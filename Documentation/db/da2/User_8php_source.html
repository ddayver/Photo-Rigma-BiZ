<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="ru">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.13.2"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Photo-Rigma-BiZ: Исходный файл include/User.php</title>
<link rel="icon" href="../../favicon.ico" type="image/x-icon" />
<link href="../../tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../jquery.js"></script>
<script type="text/javascript" src="../../dynsections.js"></script>
<script type="text/javascript" src="../../clipboard.js"></script>
<link href="../../navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../navtreedata.js"></script>
<script type="text/javascript" src="../../navtree.js"></script>
<script type="text/javascript" src="../../resize.js"></script>
<script type="text/javascript" src="../../cookie.js"></script>
<link href="../../search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../search/searchdata.js"></script>
<script type="text/javascript" src="../../search/search.js"></script>
<link href="../../doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectlogo"><img alt="Logo" src="../../logo-1.png"/></td>
  <td id="projectalign">
   <div id="projectname">Photo-Rigma-BiZ<span id="projectnumber">&#160;0.4.4</span>
   </div>
   <div id="projectbrief">Gallery_Photo-Rigma-BiZ</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Создано системой Doxygen 1.13.2 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "../../search/",'.html');
/* @license-end */
</script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() { codefold.init(1); });
/* @license-end */
</script>
<script type="text/javascript" src="../../menudata.js"></script>
<script type="text/javascript" src="../../menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('../../',true,false,'search.php','Поиск',true);
  $(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function(){initNavTree('db/da2/User_8php_source.html','../../'); initResizable(true); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Загрузка...</div>
<div class="SRStatus" id="Searching">Поиск...</div>
<div class="SRStatus" id="NoMatches">Не найдено</div>
</div>
</div>
</div>
</div>

<div class="header">
  <div class="headertitle"><div class="title">User.php</div></div>
</div><!--header-->
<div class="contents">
<a href="../../db/da2/User_8php.html">См. документацию.</a><div class="fragment"><div class="line"><a id="l00001" name="l00001"></a><span class="lineno">    1</span>&lt;?php</div>
<div class="line"><a id="l00002" name="l00002"></a><span class="lineno">    2</span></div>
<div class="line"><a id="l00045" name="l00045"></a><span class="lineno">   45</span> </div>
<div class="line"><a id="l00046" name="l00046"></a><span class="lineno">   46</span><span class="keyword">namespace </span>PhotoRigma\Classes;</div>
<div class="line"><a id="l00047" name="l00047"></a><span class="lineno">   47</span> </div>
<div class="line"><a id="l00048" name="l00048"></a><span class="lineno">   48</span>use DateTime;</div>
<div class="line"><a id="l00049" name="l00049"></a><span class="lineno">   49</span>use DateTimeZone;</div>
<div class="line"><a id="l00050" name="l00050"></a><span class="lineno">   50</span>use Exception;</div>
<div class="line"><a id="l00051" name="l00051"></a><span class="lineno">   51</span>use InvalidArgumentException;</div>
<div class="line"><a id="l00052" name="l00052"></a><span class="lineno">   52</span>use JsonException;</div>
<div class="line"><a id="l00053" name="l00053"></a><span class="lineno">   53</span>use PDOException;</div>
<div class="line"><a id="l00054" name="l00054"></a><span class="lineno">   54</span>use PhotoRigma\Interfaces\Database_Interface;</div>
<div class="line"><a id="l00055" name="l00055"></a><span class="lineno">   55</span>use PhotoRigma\Interfaces\User_Interface;</div>
<div class="line"><a id="l00056" name="l00056"></a><span class="lineno">   56</span>use PhotoRigma\Interfaces\Work_Interface;</div>
<div class="line"><a id="l00057" name="l00057"></a><span class="lineno">   57</span>use Random;</div>
<div class="line"><a id="l00058" name="l00058"></a><span class="lineno">   58</span>use RuntimeException;</div>
<div class="line"><a id="l00059" name="l00059"></a><span class="lineno">   59</span>use UnexpectedValueException;</div>
<div class="line"><a id="l00060" name="l00060"></a><span class="lineno">   60</span> </div>
<div class="line"><a id="l00061" name="l00061"></a><span class="lineno">   61</span>use <span class="keyword">function</span> PhotoRigma\Include\log_in_file;</div>
<div class="line"><a id="l00062" name="l00062"></a><span class="lineno">   62</span> </div>
<div class="line"><a id="l00063" name="l00063"></a><span class="lineno">   63</span><span class="comment">// Предотвращение прямого вызова файла</span></div>
<div class="line"><a id="l00064" name="l00064"></a><span class="lineno">   64</span><span class="keywordflow">if</span> (!defined(<span class="stringliteral">&#39;IN_GALLERY&#39;</span>) || <a class="code hl_variable" href="../../de/d90/namespacePhotoRigma.html#afc238d5007d9f82f9c59e7d33f7a75c6">IN_GALLERY</a> !== <span class="keyword">true</span>) {</div>
<div class="line"><a id="l00065" name="l00065"></a><span class="lineno">   65</span>    error_log(</div>
<div class="line"><a id="l00066" name="l00066"></a><span class="lineno">   66</span>        date(<span class="stringliteral">&#39;H:i:s&#39;</span>) . <span class="stringliteral">&#39; [ERROR] | &#39;</span> . (filter_input(</div>
<div class="line"><a id="l00067" name="l00067"></a><span class="lineno">   67</span>            INPUT_SERVER,</div>
<div class="line"><a id="l00068" name="l00068"></a><span class="lineno">   68</span>            <span class="stringliteral">&#39;REMOTE_ADDR&#39;</span>,</div>
<div class="line"><a id="l00069" name="l00069"></a><span class="lineno">   69</span>            FILTER_VALIDATE_IP</div>
<div class="line"><a id="l00070" name="l00070"></a><span class="lineno">   70</span>        ) ?: <span class="stringliteral">&#39;UNKNOWN_IP&#39;</span>) . <span class="stringliteral">&#39; | &#39;</span> . __FILE__ . <span class="stringliteral">&#39; | Попытка прямого вызова файла&#39;</span></div>
<div class="line"><a id="l00071" name="l00071"></a><span class="lineno">   71</span>    );</div>
<div class="line"><a id="l00072" name="l00072"></a><span class="lineno">   72</span>    die(<span class="stringliteral">&#39;HACK!&#39;</span>);</div>
<div class="line"><a id="l00073" name="l00073"></a><span class="lineno">   73</span>}</div>
<div class="line"><a id="l00074" name="l00074"></a><span class="lineno">   74</span></div>
<div class="foldopen" id="foldopen00108" data-start="{" data-end="};">
<div class="line"><a id="l00108" name="l00108"></a><span class="lineno"><a class="line" href="../../df/dfe/classPhotoRigma_1_1Classes_1_1User.html">  108</a></span><span class="keyword">class </span><a class="code hl_class" href="../../df/dfe/classPhotoRigma_1_1Classes_1_1User.html">User</a> <span class="keyword">implements</span> <a class="code hl_interface" href="../../dc/d14/interfacePhotoRigma_1_1Interfaces_1_1User__Interface.html">User_Interface</a></div>
<div class="line"><a id="l00109" name="l00109"></a><span class="lineno">  109</span>{</div>
<div class="line"><a id="l00110" name="l00110"></a><span class="lineno">  110</span>    <span class="comment">// Свойства</span></div>
<div class="line"><a id="l00111" name="l00111"></a><span class="lineno"><a class="line" href="../../df/dfe/classPhotoRigma_1_1Classes_1_1User.html#a54301e4038f95a7b17247e0d674ff3d6">  111</a></span>    <span class="keyword">private</span> array <a class="code hl_variable" href="../../df/dfe/classPhotoRigma_1_1Classes_1_1User.html#a54301e4038f95a7b17247e0d674ff3d6">$user</a> = []; </div>
<div class="line"><a id="l00112" name="l00112"></a><span class="lineno"><a class="line" href="../../df/dfe/classPhotoRigma_1_1Classes_1_1User.html#a18e3eac65d39ced5231d9b3e3630ba75">  112</a></span>    <span class="keyword">private</span> <a class="code hl_interface" href="../../d7/dc2/interfacePhotoRigma_1_1Interfaces_1_1Database__Interface.html">Database_Interface</a> <a class="code hl_variable" href="../../df/dfe/classPhotoRigma_1_1Classes_1_1User.html#a18e3eac65d39ced5231d9b3e3630ba75">$db</a>; </div>
<div class="line"><a id="l00113" name="l00113"></a><span class="lineno"><a class="line" href="../../df/dfe/classPhotoRigma_1_1Classes_1_1User.html#aa4aebf7c7377e1c2823e0520d16de530">  113</a></span>    <span class="keyword">private</span> array <a class="code hl_variable" href="../../df/dfe/classPhotoRigma_1_1Classes_1_1User.html#aa4aebf7c7377e1c2823e0520d16de530">$session</a>; </div>
<div class="line"><a id="l00114" name="l00114"></a><span class="lineno"><a class="line" href="../../df/dfe/classPhotoRigma_1_1Classes_1_1User.html#af31e6e13ab6e21a8020e1573c9899c5f">  114</a></span>    <span class="keyword">private</span> array <a class="code hl_variable" href="../../df/dfe/classPhotoRigma_1_1Classes_1_1User.html#af31e6e13ab6e21a8020e1573c9899c5f">$user_right_fields</a> = []; </div>
<div class="line"><a id="l00115" name="l00115"></a><span class="lineno"><a class="line" href="../../df/dfe/classPhotoRigma_1_1Classes_1_1User.html#a440fb4e1ddf381895225c74da750d6ce">  115</a></span>    <span class="keyword">private</span> ?<a class="code hl_interface" href="../../da/d79/interfacePhotoRigma_1_1Interfaces_1_1Work__Interface.html">Work_Interface</a> <a class="code hl_variable" href="../../df/dfe/classPhotoRigma_1_1Classes_1_1User.html#a440fb4e1ddf381895225c74da750d6ce">$work</a> = <span class="keyword">null</span>; </div>
<div class="line"><a id="l00116" name="l00116"></a><span class="lineno">  116</span></div>
<div class="foldopen" id="foldopen00167" data-start="{" data-end="}">
<div class="line"><a id="l00167" name="l00167"></a><span class="lineno"><a class="line" href="../../df/dfe/classPhotoRigma_1_1Classes_1_1User.html#a0524c883699d2510258de9ed3b7b3194">  167</a></span>    <span class="keyword">public</span> <span class="keyword">function</span> <a class="code hl_function" href="../../df/dfe/classPhotoRigma_1_1Classes_1_1User.html#a0524c883699d2510258de9ed3b7b3194">__construct</a>(<a class="code hl_interface" href="../../d7/dc2/interfacePhotoRigma_1_1Interfaces_1_1Database__Interface.html">Database_Interface</a> <a class="code hl_variable" href="../../df/dfe/classPhotoRigma_1_1Classes_1_1User.html#a18e3eac65d39ced5231d9b3e3630ba75">$db</a>, array &amp;<a class="code hl_variable" href="../../df/dfe/classPhotoRigma_1_1Classes_1_1User.html#aa4aebf7c7377e1c2823e0520d16de530">$session</a>)</div>
<div class="line"><a id="l00168" name="l00168"></a><span class="lineno">  168</span>    {</div>
<div class="line"><a id="l00169" name="l00169"></a><span class="lineno">  169</span>        $this-&gt;db = <a class="code hl_variable" href="../../df/dfe/classPhotoRigma_1_1Classes_1_1User.html#a18e3eac65d39ced5231d9b3e3630ba75">$db</a>;</div>
<div class="line"><a id="l00170" name="l00170"></a><span class="lineno">  170</span>        <span class="keywordflow">if</span> (!isset(<a class="code hl_variable" href="../../df/dfe/classPhotoRigma_1_1Classes_1_1User.html#aa4aebf7c7377e1c2823e0520d16de530">$session</a>[KEY_SESSION])) {</div>
<div class="line"><a id="l00171" name="l00171"></a><span class="lineno">  171</span>            <a class="code hl_variable" href="../../df/dfe/classPhotoRigma_1_1Classes_1_1User.html#aa4aebf7c7377e1c2823e0520d16de530">$session</a>[KEY_SESSION] = [];</div>
<div class="line"><a id="l00172" name="l00172"></a><span class="lineno">  172</span>        }</div>
<div class="line"><a id="l00173" name="l00173"></a><span class="lineno">  173</span>        $this-&gt;session = &amp;<a class="code hl_variable" href="../../df/dfe/classPhotoRigma_1_1Classes_1_1User.html#aa4aebf7c7377e1c2823e0520d16de530">$session</a>[KEY_SESSION];</div>
<div class="line"><a id="l00174" name="l00174"></a><span class="lineno">  174</span>        $this-&gt;<a class="code hl_function" href="../../df/dfe/classPhotoRigma_1_1Classes_1_1User.html#a31dc3b03e806ca6646c7fcc89b72004e">_all_right_fields</a>();</div>
<div class="line"><a id="l00175" name="l00175"></a><span class="lineno">  175</span>        $this-&gt;<a class="code hl_function" href="../../df/dfe/classPhotoRigma_1_1Classes_1_1User.html#aee4743c1e7219e86017ef88bdd1a4656">_initialize_user</a>();</div>
<div class="line"><a id="l00176" name="l00176"></a><span class="lineno">  176</span>    }</div>
</div>
<div class="line"><a id="l00177" name="l00177"></a><span class="lineno">  177</span></div>
<div class="foldopen" id="foldopen00236" data-start="{" data-end="}">
<div class="line"><a id="l00236" name="l00236"></a><span class="lineno"><a class="line" href="../../df/dfe/classPhotoRigma_1_1Classes_1_1User.html#a31dc3b03e806ca6646c7fcc89b72004e">  236</a></span>    <span class="keyword">private</span> <span class="keyword">function</span> <a class="code hl_function" href="../../df/dfe/classPhotoRigma_1_1Classes_1_1User.html#a31dc3b03e806ca6646c7fcc89b72004e">_all_right_fields</a>(): void</div>
<div class="line"><a id="l00237" name="l00237"></a><span class="lineno">  237</span>    {</div>
<div class="line"><a id="l00238" name="l00238"></a><span class="lineno">  238</span>        <span class="comment">// === Загрузка прав первого пользователя ===</span></div>
<div class="line"><a id="l00239" name="l00239"></a><span class="lineno">  239</span>        <span class="keywordflow">if</span> (!$this-&gt;db-&gt;select(<span class="stringliteral">&#39;`user_rights`&#39;</span>, TBL_USERS, [<span class="stringliteral">&#39;limit&#39;</span> =&gt; 1])) {</div>
<div class="line"><a id="l00240" name="l00240"></a><span class="lineno">  240</span>            <span class="keywordflow">throw</span> <span class="keyword">new</span> RuntimeException(</div>
<div class="line"><a id="l00241" name="l00241"></a><span class="lineno">  241</span>                __FILE__ . <span class="charliteral">&#39;:&#39;</span> . __LINE__ . <span class="stringliteral">&#39; (&#39;</span> . (__METHOD__ ?: __FUNCTION__ ?: <span class="stringliteral">&#39;global&#39;</span>) . <span class="stringliteral">&#39;) | Ошибка базы данных | Не удалось получить права первого пользователя&#39;</span></div>
<div class="line"><a id="l00242" name="l00242"></a><span class="lineno">  242</span>            );</div>
<div class="line"><a id="l00243" name="l00243"></a><span class="lineno">  243</span>        }</div>
<div class="line"><a id="l00244" name="l00244"></a><span class="lineno">  244</span> </div>
<div class="line"><a id="l00245" name="l00245"></a><span class="lineno">  245</span>        $user_result = $this-&gt;db-&gt;result_row();</div>
<div class="line"><a id="l00246" name="l00246"></a><span class="lineno">  246</span>        <span class="keywordflow">if</span> ($user_result &amp;&amp; isset($user_result[<span class="stringliteral">&#39;user_rights&#39;</span>])) {</div>
<div class="line"><a id="l00247" name="l00247"></a><span class="lineno">  247</span>            <span class="comment">// Обрабатываем права пользователя</span></div>
<div class="line"><a id="l00248" name="l00248"></a><span class="lineno">  248</span>            $user_rights = $this-&gt;<a class="code hl_function" href="../../df/dfe/classPhotoRigma_1_1Classes_1_1User.html#a6031ba212847fdf2810753c120c4b4d2">process_user_rights</a>($user_result[<span class="stringliteral">&#39;user_rights&#39;</span>]);</div>
<div class="line"><a id="l00249" name="l00249"></a><span class="lineno">  249</span>            <span class="comment">// Сохраняем имена полей прав пользователя</span></div>
<div class="line"><a id="l00250" name="l00250"></a><span class="lineno">  250</span>            $this-&gt;user_right_fields[<span class="stringliteral">&#39;user&#39;</span>] = array_keys($user_rights);</div>
<div class="line"><a id="l00251" name="l00251"></a><span class="lineno">  251</span>        } <span class="keywordflow">else</span> {</div>
<div class="line"><a id="l00252" name="l00252"></a><span class="lineno">  252</span>            <span class="comment">// Если права пользователя отсутствуют, сохраняем пустой массив</span></div>
<div class="line"><a id="l00253" name="l00253"></a><span class="lineno">  253</span>            $this-&gt;user_right_fields[<span class="stringliteral">&#39;user&#39;</span>] = [];</div>
<div class="line"><a id="l00254" name="l00254"></a><span class="lineno">  254</span>        }</div>
<div class="line"><a id="l00255" name="l00255"></a><span class="lineno">  255</span> </div>
<div class="line"><a id="l00256" name="l00256"></a><span class="lineno">  256</span>        <span class="comment">// === Загрузка прав первой группы ===</span></div>
<div class="line"><a id="l00257" name="l00257"></a><span class="lineno">  257</span>        <span class="keywordflow">if</span> (!$this-&gt;db-&gt;select(<span class="stringliteral">&#39;`user_rights`&#39;</span>, TBL_GROUP, [<span class="stringliteral">&#39;limit&#39;</span> =&gt; 1])) {</div>
<div class="line"><a id="l00258" name="l00258"></a><span class="lineno">  258</span>            <span class="keywordflow">throw</span> <span class="keyword">new</span> RuntimeException(</div>
<div class="line"><a id="l00259" name="l00259"></a><span class="lineno">  259</span>                __FILE__ . <span class="charliteral">&#39;:&#39;</span> . __LINE__ . <span class="stringliteral">&#39; (&#39;</span> . (__METHOD__ ?: __FUNCTION__ ?: <span class="stringliteral">&#39;global&#39;</span>) . <span class="stringliteral">&#39;) | Ошибка базы данных | Не удалось получить права первой группы&#39;</span></div>
<div class="line"><a id="l00260" name="l00260"></a><span class="lineno">  260</span>            );</div>
<div class="line"><a id="l00261" name="l00261"></a><span class="lineno">  261</span>        }</div>
<div class="line"><a id="l00262" name="l00262"></a><span class="lineno">  262</span> </div>
<div class="line"><a id="l00263" name="l00263"></a><span class="lineno">  263</span>        $group_result = $this-&gt;db-&gt;result_row();</div>
<div class="line"><a id="l00264" name="l00264"></a><span class="lineno">  264</span>        <span class="keywordflow">if</span> ($group_result &amp;&amp; isset($group_result[<span class="stringliteral">&#39;user_rights&#39;</span>])) {</div>
<div class="line"><a id="l00265" name="l00265"></a><span class="lineno">  265</span>            <span class="comment">// Обрабатываем права группы</span></div>
<div class="line"><a id="l00266" name="l00266"></a><span class="lineno">  266</span>            $group_rights = $this-&gt;<a class="code hl_function" href="../../df/dfe/classPhotoRigma_1_1Classes_1_1User.html#a6031ba212847fdf2810753c120c4b4d2">process_user_rights</a>($group_result[<span class="stringliteral">&#39;user_rights&#39;</span>]);</div>
<div class="line"><a id="l00267" name="l00267"></a><span class="lineno">  267</span>            <span class="comment">// Сохраняем имена полей прав группы</span></div>
<div class="line"><a id="l00268" name="l00268"></a><span class="lineno">  268</span>            $this-&gt;user_right_fields[<span class="stringliteral">&#39;group&#39;</span>] = array_keys($group_rights);</div>
<div class="line"><a id="l00269" name="l00269"></a><span class="lineno">  269</span>        } <span class="keywordflow">else</span> {</div>
<div class="line"><a id="l00270" name="l00270"></a><span class="lineno">  270</span>            <span class="comment">// Если права группы отсутствуют, сохраняем пустой массив</span></div>
<div class="line"><a id="l00271" name="l00271"></a><span class="lineno">  271</span>            $this-&gt;user_right_fields[<span class="stringliteral">&#39;group&#39;</span>] = [];</div>
<div class="line"><a id="l00272" name="l00272"></a><span class="lineno">  272</span>        }</div>
<div class="line"><a id="l00273" name="l00273"></a><span class="lineno">  273</span> </div>
<div class="line"><a id="l00274" name="l00274"></a><span class="lineno">  274</span>        <span class="comment">// Объединяем поля прав в один массив</span></div>
<div class="line"><a id="l00275" name="l00275"></a><span class="lineno">  275</span>        $this-&gt;user_right_fields[<span class="stringliteral">&#39;all&#39;</span>] = array_unique(</div>
<div class="line"><a id="l00276" name="l00276"></a><span class="lineno">  276</span>            array_merge(</div>
<div class="line"><a id="l00277" name="l00277"></a><span class="lineno">  277</span>                $this-&gt;user_right_fields[<span class="stringliteral">&#39;user&#39;</span>],</div>
<div class="line"><a id="l00278" name="l00278"></a><span class="lineno">  278</span>                $this-&gt;user_right_fields[<span class="stringliteral">&#39;group&#39;</span>]</div>
<div class="line"><a id="l00279" name="l00279"></a><span class="lineno">  279</span>            )</div>
<div class="line"><a id="l00280" name="l00280"></a><span class="lineno">  280</span>        );</div>
<div class="line"><a id="l00281" name="l00281"></a><span class="lineno">  281</span>    }</div>
</div>
<div class="line"><a id="l00282" name="l00282"></a><span class="lineno">  282</span></div>
<div class="foldopen" id="foldopen00326" data-start="{" data-end="}">
<div class="line"><a id="l00326" name="l00326"></a><span class="lineno"><a class="line" href="../../df/dfe/classPhotoRigma_1_1Classes_1_1User.html#a6031ba212847fdf2810753c120c4b4d2">  326</a></span>    <span class="keyword">public</span> <span class="keyword">function</span> <a class="code hl_function" href="../../df/dfe/classPhotoRigma_1_1Classes_1_1User.html#a6031ba212847fdf2810753c120c4b4d2">process_user_rights</a>(<span class="keywordtype">string</span> $user_rights): array</div>
<div class="line"><a id="l00327" name="l00327"></a><span class="lineno">  327</span>    {</div>
<div class="line"><a id="l00328" name="l00328"></a><span class="lineno">  328</span>        <span class="keywordflow">return</span> $this-&gt;<a class="code hl_function" href="../../df/dfe/classPhotoRigma_1_1Classes_1_1User.html#ad202cf4189004edefa5403d1fad8c7f3">_process_user_rights_internal</a>($user_rights);</div>
<div class="line"><a id="l00329" name="l00329"></a><span class="lineno">  329</span>    }</div>
</div>
<div class="line"><a id="l00330" name="l00330"></a><span class="lineno">  330</span></div>
<div class="foldopen" id="foldopen00377" data-start="{" data-end="}">
<div class="line"><a id="l00377" name="l00377"></a><span class="lineno"><a class="line" href="../../df/dfe/classPhotoRigma_1_1Classes_1_1User.html#ad202cf4189004edefa5403d1fad8c7f3">  377</a></span>    <span class="keyword">protected</span> <span class="keyword">function</span> <a class="code hl_function" href="../../df/dfe/classPhotoRigma_1_1Classes_1_1User.html#ad202cf4189004edefa5403d1fad8c7f3">_process_user_rights_internal</a>(<span class="keywordtype">string</span> $user_rights): array</div>
<div class="line"><a id="l00378" name="l00378"></a><span class="lineno">  378</span>    {</div>
<div class="line"><a id="l00379" name="l00379"></a><span class="lineno">  379</span>        <span class="comment">// Проверяем, существует ли поле user_rights</span></div>
<div class="line"><a id="l00380" name="l00380"></a><span class="lineno">  380</span>        <span class="keywordflow">if</span> (empty($user_rights)) {</div>
<div class="line"><a id="l00381" name="l00381"></a><span class="lineno">  381</span>            <span class="keywordflow">return</span> [];</div>
<div class="line"><a id="l00382" name="l00382"></a><span class="lineno">  382</span>        }</div>
<div class="line"><a id="l00383" name="l00383"></a><span class="lineno">  383</span> </div>
<div class="line"><a id="l00384" name="l00384"></a><span class="lineno">  384</span>        <span class="comment">// Декодируем JSON</span></div>
<div class="line"><a id="l00385" name="l00385"></a><span class="lineno">  385</span>        $rights = json_decode($user_rights, <span class="keyword">true</span>, 512, JSON_THROW_ON_ERROR);</div>
<div class="line"><a id="l00386" name="l00386"></a><span class="lineno">  386</span>        <span class="keywordflow">if</span> (json_last_error() !== JSON_ERROR_NONE) {</div>
<div class="line"><a id="l00387" name="l00387"></a><span class="lineno">  387</span>            <span class="keywordflow">throw</span> <span class="keyword">new</span> InvalidArgumentException(</div>
<div class="line"><a id="l00388" name="l00388"></a><span class="lineno">  388</span>                __FILE__ . <span class="charliteral">&#39;:&#39;</span> . __LINE__ . <span class="stringliteral">&#39; (&#39;</span> . (__METHOD__ ?: __FUNCTION__ ?: <span class="stringliteral">&#39;global&#39;</span>) . <span class="stringliteral">&#39;) | Некорректный формат JSON | Поле user_rights содержит невалидные данные&#39;</span></div>
<div class="line"><a id="l00389" name="l00389"></a><span class="lineno">  389</span>            );</div>
<div class="line"><a id="l00390" name="l00390"></a><span class="lineno">  390</span>        }</div>
<div class="line"><a id="l00391" name="l00391"></a><span class="lineno">  391</span> </div>
<div class="line"><a id="l00392" name="l00392"></a><span class="lineno">  392</span>        <span class="comment">// Возвращаем массив прав</span></div>
<div class="line"><a id="l00393" name="l00393"></a><span class="lineno">  393</span>        <span class="keywordflow">return</span> is_array($rights) ? $rights : [];</div>
<div class="line"><a id="l00394" name="l00394"></a><span class="lineno">  394</span>    }</div>
</div>
<div class="line"><a id="l00395" name="l00395"></a><span class="lineno">  395</span></div>
<div class="foldopen" id="foldopen00435" data-start="{" data-end="}">
<div class="line"><a id="l00435" name="l00435"></a><span class="lineno"><a class="line" href="../../df/dfe/classPhotoRigma_1_1Classes_1_1User.html#aee4743c1e7219e86017ef88bdd1a4656">  435</a></span>    <span class="keyword">private</span> <span class="keyword">function</span> <a class="code hl_function" href="../../df/dfe/classPhotoRigma_1_1Classes_1_1User.html#aee4743c1e7219e86017ef88bdd1a4656">_initialize_user</a>(): void</div>
<div class="line"><a id="l00436" name="l00436"></a><span class="lineno">  436</span>    {</div>
<div class="line"><a id="l00437" name="l00437"></a><span class="lineno">  437</span>        $login_id = (int)($this-&gt;session[<span class="stringliteral">&#39;login_id&#39;</span>] ?? 0);</div>
<div class="line"><a id="l00438" name="l00438"></a><span class="lineno">  438</span>        $this-&gt;session[<span class="stringliteral">&#39;login_id&#39;</span>] = $login_id;</div>
<div class="line"><a id="l00439" name="l00439"></a><span class="lineno">  439</span>        <span class="keywordflow">if</span> ($login_id === 0) {</div>
<div class="line"><a id="l00440" name="l00440"></a><span class="lineno">  440</span>            $this-&gt;<a class="code hl_function" href="../../df/dfe/classPhotoRigma_1_1Classes_1_1User.html#a37a62de0669ef3c96b196350fdfed0f5">_load_guest_user</a>();</div>
<div class="line"><a id="l00441" name="l00441"></a><span class="lineno">  441</span>        } <span class="keywordflow">else</span> {</div>
<div class="line"><a id="l00442" name="l00442"></a><span class="lineno">  442</span>            $this-&gt;<a class="code hl_function" href="../../df/dfe/classPhotoRigma_1_1Classes_1_1User.html#a8364c028db3f92e0d44c0533289be005">_load_authenticated_user</a>($login_id);</div>
<div class="line"><a id="l00443" name="l00443"></a><span class="lineno">  443</span>        }</div>
<div class="line"><a id="l00444" name="l00444"></a><span class="lineno">  444</span>    }</div>
</div>
<div class="line"><a id="l00445" name="l00445"></a><span class="lineno">  445</span></div>
<div class="foldopen" id="foldopen00499" data-start="{" data-end="}">
<div class="line"><a id="l00499" name="l00499"></a><span class="lineno"><a class="line" href="../../df/dfe/classPhotoRigma_1_1Classes_1_1User.html#a37a62de0669ef3c96b196350fdfed0f5">  499</a></span>    <span class="keyword">private</span> <span class="keyword">function</span> <a class="code hl_function" href="../../df/dfe/classPhotoRigma_1_1Classes_1_1User.html#a37a62de0669ef3c96b196350fdfed0f5">_load_guest_user</a>(): void</div>
<div class="line"><a id="l00500" name="l00500"></a><span class="lineno">  500</span>    {</div>
<div class="line"><a id="l00501" name="l00501"></a><span class="lineno">  501</span>        <span class="comment">// Выполняем запрос к базе данных для получения данных группы гостя</span></div>
<div class="line"><a id="l00502" name="l00502"></a><span class="lineno">  502</span>        <span class="keywordflow">if</span> (!$this-&gt;db-&gt;select(</div>
<div class="line"><a id="l00503" name="l00503"></a><span class="lineno">  503</span>            <span class="stringliteral">&#39;`id`, `user_rights`&#39;</span>,</div>
<div class="line"><a id="l00504" name="l00504"></a><span class="lineno">  504</span>            TBL_GROUP,</div>
<div class="line"><a id="l00505" name="l00505"></a><span class="lineno">  505</span>            [<span class="stringliteral">&#39;where&#39;</span> =&gt; <span class="stringliteral">&#39;`id` = :group_id&#39;</span>, <span class="stringliteral">&#39;params&#39;</span> =&gt; [<span class="stringliteral">&#39;group_id&#39;</span> =&gt; GROUP_GUEST]]</div>
<div class="line"><a id="l00506" name="l00506"></a><span class="lineno">  506</span>        )) {</div>
<div class="line"><a id="l00507" name="l00507"></a><span class="lineno">  507</span>            <span class="keywordflow">throw</span> <span class="keyword">new</span> RuntimeException(</div>
<div class="line"><a id="l00508" name="l00508"></a><span class="lineno">  508</span>                __FILE__ . <span class="charliteral">&#39;:&#39;</span> . __LINE__ . <span class="stringliteral">&#39; (&#39;</span> . (__METHOD__ ?: __FUNCTION__ ?: <span class="stringliteral">&#39;global&#39;</span>) . <span class="stringliteral">&#39;) | Ошибка базы данных | Не удалось получить данные группы гостя&#39;</span></div>
<div class="line"><a id="l00509" name="l00509"></a><span class="lineno">  509</span>            );</div>
<div class="line"><a id="l00510" name="l00510"></a><span class="lineno">  510</span>        }</div>
<div class="line"><a id="l00511" name="l00511"></a><span class="lineno">  511</span> </div>
<div class="line"><a id="l00512" name="l00512"></a><span class="lineno">  512</span>        <span class="comment">// Получаем данные группы гостя</span></div>
<div class="line"><a id="l00513" name="l00513"></a><span class="lineno">  513</span>        $guest_group = $this-&gt;db-&gt;result_row();</div>
<div class="line"><a id="l00514" name="l00514"></a><span class="lineno">  514</span>        <span class="keywordflow">if</span> (!$guest_group || !is_array($guest_group)) {</div>
<div class="line"><a id="l00515" name="l00515"></a><span class="lineno">  515</span>            <span class="keywordflow">throw</span> <span class="keyword">new</span> UnexpectedValueException(</div>
<div class="line"><a id="l00516" name="l00516"></a><span class="lineno">  516</span>                __FILE__ . <span class="charliteral">&#39;:&#39;</span> . __LINE__ . <span class="stringliteral">&#39; (&#39;</span> . (__METHOD__ ?: __FUNCTION__ ?: <span class="stringliteral">&#39;global&#39;</span>) . <span class="stringliteral">&#39;) | Некорректные данные группы гостя | Проверьте формат данных в таблице &#39;</span> . TBL_GROUP</div>
<div class="line"><a id="l00517" name="l00517"></a><span class="lineno">  517</span>            );</div>
<div class="line"><a id="l00518" name="l00518"></a><span class="lineno">  518</span>        }</div>
<div class="line"><a id="l00519" name="l00519"></a><span class="lineno">  519</span> </div>
<div class="line"><a id="l00520" name="l00520"></a><span class="lineno">  520</span>        <span class="comment">// Удаляем поле user_rights из данных гостя</span></div>
<div class="line"><a id="l00521" name="l00521"></a><span class="lineno">  521</span>        $user_rights = $guest_group[<span class="stringliteral">&#39;user_rights&#39;</span>] ?? <span class="keyword">null</span>;</div>
<div class="line"><a id="l00522" name="l00522"></a><span class="lineno">  522</span>        unset($guest_group[<span class="stringliteral">&#39;user_rights&#39;</span>]);</div>
<div class="line"><a id="l00523" name="l00523"></a><span class="lineno">  523</span> </div>
<div class="line"><a id="l00524" name="l00524"></a><span class="lineno">  524</span>        <span class="comment">// Обрабатываем права гостя (user_rights)</span></div>
<div class="line"><a id="l00525" name="l00525"></a><span class="lineno">  525</span>        $processed_rights = $this-&gt;<a class="code hl_function" href="../../df/dfe/classPhotoRigma_1_1Classes_1_1User.html#a6031ba212847fdf2810753c120c4b4d2">process_user_rights</a>($user_rights);</div>
<div class="line"><a id="l00526" name="l00526"></a><span class="lineno">  526</span> </div>
<div class="line"><a id="l00527" name="l00527"></a><span class="lineno">  527</span>        <span class="comment">// Присваиваем данные гостя с добавлением прав</span></div>
<div class="line"><a id="l00528" name="l00528"></a><span class="lineno">  528</span>        $this-&gt;user = array_merge($guest_group, $processed_rights);</div>
<div class="line"><a id="l00529" name="l00529"></a><span class="lineno">  529</span>    }</div>
</div>
<div class="line"><a id="l00530" name="l00530"></a><span class="lineno">  530</span></div>
<div class="foldopen" id="foldopen00608" data-start="{" data-end="}">
<div class="line"><a id="l00608" name="l00608"></a><span class="lineno"><a class="line" href="../../df/dfe/classPhotoRigma_1_1Classes_1_1User.html#a8364c028db3f92e0d44c0533289be005">  608</a></span>    <span class="keyword">private</span> <span class="keyword">function</span> <a class="code hl_function" href="../../df/dfe/classPhotoRigma_1_1Classes_1_1User.html#a8364c028db3f92e0d44c0533289be005">_load_authenticated_user</a>(<span class="keywordtype">int</span> $user_id): void</div>
<div class="line"><a id="l00609" name="l00609"></a><span class="lineno">  609</span>    {</div>
<div class="line"><a id="l00610" name="l00610"></a><span class="lineno">  610</span>        <span class="comment">// Загружаем данные пользователя</span></div>
<div class="line"><a id="l00611" name="l00611"></a><span class="lineno">  611</span>        <span class="keywordflow">if</span> (!$this-&gt;db-&gt;select(<span class="charliteral">&#39;*&#39;</span>, TBL_USERS, [<span class="stringliteral">&#39;where&#39;</span> =&gt; <span class="stringliteral">&#39;`id` = :user_id&#39;</span>, <span class="stringliteral">&#39;params&#39;</span> =&gt; [<span class="stringliteral">&#39;user_id&#39;</span> =&gt; $user_id]])) {</div>
<div class="line"><a id="l00612" name="l00612"></a><span class="lineno">  612</span>            <span class="keywordflow">throw</span> <span class="keyword">new</span> RuntimeException(</div>
<div class="line"><a id="l00613" name="l00613"></a><span class="lineno">  613</span>                __FILE__ . <span class="charliteral">&#39;:&#39;</span> . __LINE__ . <span class="stringliteral">&#39; (&#39;</span> . (__METHOD__ ?: __FUNCTION__ ?: <span class="stringliteral">&#39;global&#39;</span>) . <span class="stringliteral">&quot;) | Ошибка базы данных | Не удалось получить данные пользователя с ID: $user_id&quot;</span></div>
<div class="line"><a id="l00614" name="l00614"></a><span class="lineno">  614</span>            );</div>
<div class="line"><a id="l00615" name="l00615"></a><span class="lineno">  615</span>        }</div>
<div class="line"><a id="l00616" name="l00616"></a><span class="lineno">  616</span> </div>
<div class="line"><a id="l00617" name="l00617"></a><span class="lineno">  617</span>        $user_data = $this-&gt;db-&gt;result_row();</div>
<div class="line"><a id="l00618" name="l00618"></a><span class="lineno">  618</span>        <span class="keywordflow">if</span> (!$user_data) {</div>
<div class="line"><a id="l00619" name="l00619"></a><span class="lineno">  619</span>            $this-&gt;session[<span class="stringliteral">&#39;login_id&#39;</span>] = 0;</div>
<div class="line"><a id="l00620" name="l00620"></a><span class="lineno">  620</span>            $this-&gt;<a class="code hl_function" href="../../df/dfe/classPhotoRigma_1_1Classes_1_1User.html#a37a62de0669ef3c96b196350fdfed0f5">_load_guest_user</a>();</div>
<div class="line"><a id="l00621" name="l00621"></a><span class="lineno">  621</span>            <span class="keywordflow">return</span>;</div>
<div class="line"><a id="l00622" name="l00622"></a><span class="lineno">  622</span>        }</div>
<div class="line"><a id="l00623" name="l00623"></a><span class="lineno">  623</span> </div>
<div class="line"><a id="l00624" name="l00624"></a><span class="lineno">  624</span>        <span class="comment">// Проверяем окончательное удаление</span></div>
<div class="line"><a id="l00625" name="l00625"></a><span class="lineno">  625</span>        <span class="keywordflow">if</span> (!empty($user_data[<span class="stringliteral">&#39;permanently_deleted&#39;</span>])) {</div>
<div class="line"><a id="l00626" name="l00626"></a><span class="lineno">  626</span>            $this-&gt;session[<span class="stringliteral">&#39;login_id&#39;</span>] = 0;</div>
<div class="line"><a id="l00627" name="l00627"></a><span class="lineno">  627</span>            $this-&gt;<a class="code hl_function" href="../../df/dfe/classPhotoRigma_1_1Classes_1_1User.html#a37a62de0669ef3c96b196350fdfed0f5">_load_guest_user</a>();</div>
<div class="line"><a id="l00628" name="l00628"></a><span class="lineno">  628</span>            <span class="keywordflow">return</span>;</div>
<div class="line"><a id="l00629" name="l00629"></a><span class="lineno">  629</span>        }</div>
<div class="line"><a id="l00630" name="l00630"></a><span class="lineno">  630</span> </div>
<div class="line"><a id="l00631" name="l00631"></a><span class="lineno">  631</span>        <span class="comment">// Проверяем, прошло ли время восстановления после мягкого удаления</span></div>
<div class="line"><a id="l00632" name="l00632"></a><span class="lineno">  632</span>        <span class="keywordflow">if</span> (!empty($user_data[<span class="stringliteral">&#39;deleted_at&#39;</span>]) &amp;&amp; $this-&gt;<a class="code hl_function" href="../../df/dfe/classPhotoRigma_1_1Classes_1_1User.html#ae7bbb3d70503c2c3ab7de0e44bf83798">_is_soft_delete_expired_internal</a>($user_data[<span class="stringliteral">&#39;deleted_at&#39;</span>])[<span class="stringliteral">&#39;expired&#39;</span>]) {</div>
<div class="line"><a id="l00633" name="l00633"></a><span class="lineno">  633</span>            $this-&gt;session[<span class="stringliteral">&#39;login_id&#39;</span>] = 0;</div>
<div class="line"><a id="l00634" name="l00634"></a><span class="lineno">  634</span>            $this-&gt;<a class="code hl_function" href="../../df/dfe/classPhotoRigma_1_1Classes_1_1User.html#a37a62de0669ef3c96b196350fdfed0f5">_load_guest_user</a>();</div>
<div class="line"><a id="l00635" name="l00635"></a><span class="lineno">  635</span>            <span class="keywordflow">return</span>;</div>
<div class="line"><a id="l00636" name="l00636"></a><span class="lineno">  636</span>        }</div>
<div class="line"><a id="l00637" name="l00637"></a><span class="lineno">  637</span> </div>
<div class="line"><a id="l00638" name="l00638"></a><span class="lineno">  638</span>        <span class="comment">// Удаляем поле user_rights из данных пользователя</span></div>
<div class="line"><a id="l00639" name="l00639"></a><span class="lineno">  639</span>        $user_rights = $user_data[<span class="stringliteral">&#39;user_rights&#39;</span>] ?? <span class="keyword">null</span>;</div>
<div class="line"><a id="l00640" name="l00640"></a><span class="lineno">  640</span>        <span class="keywordflow">if</span> (is_array($user_data)) {</div>
<div class="line"><a id="l00641" name="l00641"></a><span class="lineno">  641</span>            unset($user_data[<span class="stringliteral">&#39;user_rights&#39;</span>]);</div>
<div class="line"><a id="l00642" name="l00642"></a><span class="lineno">  642</span>        }</div>
<div class="line"><a id="l00643" name="l00643"></a><span class="lineno">  643</span> </div>
<div class="line"><a id="l00644" name="l00644"></a><span class="lineno">  644</span>        <span class="comment">// Обрабатываем права пользователя (user_rights)</span></div>
<div class="line"><a id="l00645" name="l00645"></a><span class="lineno">  645</span>        $processed_rights = $this-&gt;<a class="code hl_function" href="../../df/dfe/classPhotoRigma_1_1Classes_1_1User.html#a6031ba212847fdf2810753c120c4b4d2">process_user_rights</a>($user_rights);</div>
<div class="line"><a id="l00646" name="l00646"></a><span class="lineno">  646</span> </div>
<div class="line"><a id="l00647" name="l00647"></a><span class="lineno">  647</span>        <span class="comment">// Присваиваем данные пользователя с добавлением прав</span></div>
<div class="line"><a id="l00648" name="l00648"></a><span class="lineno">  648</span>        $this-&gt;user = array_merge($user_data, $processed_rights);</div>
<div class="line"><a id="l00649" name="l00649"></a><span class="lineno">  649</span> </div>
<div class="line"><a id="l00650" name="l00650"></a><span class="lineno">  650</span>        <span class="comment">// Загружаем данные группы пользователя</span></div>
<div class="line"><a id="l00651" name="l00651"></a><span class="lineno">  651</span>        <span class="keywordflow">if</span> (!$this-&gt;db-&gt;select(</div>
<div class="line"><a id="l00652" name="l00652"></a><span class="lineno">  652</span>            <span class="charliteral">&#39;*&#39;</span>,</div>
<div class="line"><a id="l00653" name="l00653"></a><span class="lineno">  653</span>            TBL_GROUP,</div>
<div class="line"><a id="l00654" name="l00654"></a><span class="lineno">  654</span>            [<span class="stringliteral">&#39;where&#39;</span> =&gt; <span class="stringliteral">&#39;`id` = :group_id&#39;</span>, <span class="stringliteral">&#39;params&#39;</span> =&gt; [<span class="stringliteral">&#39;group_id&#39;</span> =&gt; $this-&gt;user[<span class="stringliteral">&#39;group_id&#39;</span>]]]</div>
<div class="line"><a id="l00655" name="l00655"></a><span class="lineno">  655</span>        )) {</div>
<div class="line"><a id="l00656" name="l00656"></a><span class="lineno">  656</span>            <span class="keywordflow">throw</span> <span class="keyword">new</span> RuntimeException(</div>
<div class="line"><a id="l00657" name="l00657"></a><span class="lineno">  657</span>                __FILE__ . <span class="charliteral">&#39;:&#39;</span> . __LINE__ . <span class="stringliteral">&#39; (&#39;</span> . (__METHOD__ ?: __FUNCTION__ ?: <span class="stringliteral">&#39;global&#39;</span>) . <span class="stringliteral">&quot;) | Ошибка базы данных | Не удалось получить данные группы пользователя с ID: {$this-&gt;user[&#39;group&#39;]}&quot;</span></div>
<div class="line"><a id="l00658" name="l00658"></a><span class="lineno">  658</span>            );</div>
<div class="line"><a id="l00659" name="l00659"></a><span class="lineno">  659</span>        }</div>
<div class="line"><a id="l00660" name="l00660"></a><span class="lineno">  660</span> </div>
<div class="line"><a id="l00661" name="l00661"></a><span class="lineno">  661</span>        $group_data = $this-&gt;db-&gt;result_row();</div>
<div class="line"><a id="l00662" name="l00662"></a><span class="lineno">  662</span>        <span class="keywordflow">if</span> (!$group_data) {</div>
<div class="line"><a id="l00663" name="l00663"></a><span class="lineno">  663</span>            $this-&gt;session[<span class="stringliteral">&#39;login_id&#39;</span>] = 0;</div>
<div class="line"><a id="l00664" name="l00664"></a><span class="lineno">  664</span>            $this-&gt;<a class="code hl_function" href="../../df/dfe/classPhotoRigma_1_1Classes_1_1User.html#a37a62de0669ef3c96b196350fdfed0f5">_load_guest_user</a>();</div>
<div class="line"><a id="l00665" name="l00665"></a><span class="lineno">  665</span>            <span class="keywordflow">return</span>;</div>
<div class="line"><a id="l00666" name="l00666"></a><span class="lineno">  666</span>        }</div>
<div class="line"><a id="l00667" name="l00667"></a><span class="lineno">  667</span> </div>
<div class="line"><a id="l00668" name="l00668"></a><span class="lineno">  668</span>        <span class="comment">// Устанавливаем язык и тему сайта</span></div>
<div class="line"><a id="l00669" name="l00669"></a><span class="lineno">  669</span>        $this-&gt;session[<span class="stringliteral">&#39;language&#39;</span>] = $this-&gt;user[<span class="stringliteral">&#39;language&#39;</span>];</div>
<div class="line"><a id="l00670" name="l00670"></a><span class="lineno">  670</span>        $this-&gt;session[<span class="stringliteral">&#39;theme&#39;</span>] = $this-&gt;user[<span class="stringliteral">&#39;theme&#39;</span>];</div>
<div class="line"><a id="l00671" name="l00671"></a><span class="lineno">  671</span>        $this-&gt;session[<span class="stringliteral">&#39;timezone&#39;</span>] = $this-&gt;user[<span class="stringliteral">&#39;timezone&#39;</span>];</div>
<div class="line"><a id="l00672" name="l00672"></a><span class="lineno">  672</span> </div>
<div class="line"><a id="l00673" name="l00673"></a><span class="lineno">  673</span>        <span class="comment">// Удаляем поле user_rights из данных группы</span></div>
<div class="line"><a id="l00674" name="l00674"></a><span class="lineno">  674</span>        $group_rights = $group_data[<span class="stringliteral">&#39;user_rights&#39;</span>] ?? <span class="keyword">null</span>;</div>
<div class="line"><a id="l00675" name="l00675"></a><span class="lineno">  675</span>        unset($group_data[<span class="stringliteral">&#39;user_rights&#39;</span>]);</div>
<div class="line"><a id="l00676" name="l00676"></a><span class="lineno">  676</span> </div>
<div class="line"><a id="l00677" name="l00677"></a><span class="lineno">  677</span>        <span class="comment">// Обрабатываем права группы (user_rights)</span></div>
<div class="line"><a id="l00678" name="l00678"></a><span class="lineno">  678</span>        $processed_rights = $this-&gt;<a class="code hl_function" href="../../df/dfe/classPhotoRigma_1_1Classes_1_1User.html#a6031ba212847fdf2810753c120c4b4d2">process_user_rights</a>($group_rights);</div>
<div class="line"><a id="l00679" name="l00679"></a><span class="lineno">  679</span> </div>
<div class="line"><a id="l00680" name="l00680"></a><span class="lineno">  680</span>        <span class="comment">// Присваиваем данные пользователя с добавлением прав группы</span></div>
<div class="line"><a id="l00681" name="l00681"></a><span class="lineno">  681</span>        $this-&gt;<a class="code hl_function" href="../../df/dfe/classPhotoRigma_1_1Classes_1_1User.html#abc511791f65e1fca6093700a8a3fee23">_merge_user_with_group</a>(array_merge($group_data, $processed_rights));</div>
<div class="line"><a id="l00682" name="l00682"></a><span class="lineno">  682</span> </div>
<div class="line"><a id="l00683" name="l00683"></a><span class="lineno">  683</span>        <span class="comment">// Обновляем данные о последней активности пользователя</span></div>
<div class="line"><a id="l00684" name="l00684"></a><span class="lineno">  684</span>        <span class="keywordflow">if</span> (!$this-&gt;db-&gt;update(</div>
<div class="line"><a id="l00685" name="l00685"></a><span class="lineno">  685</span>            [<span class="stringliteral">&#39;`date_last_activ`&#39;</span> =&gt; <span class="stringliteral">&#39;NOW()&#39;</span>],</div>
<div class="line"><a id="l00686" name="l00686"></a><span class="lineno">  686</span>            TBL_USERS,</div>
<div class="line"><a id="l00687" name="l00687"></a><span class="lineno">  687</span>            [<span class="stringliteral">&#39;where&#39;</span> =&gt; <span class="stringliteral">&#39;`id` = :user_id&#39;</span>, <span class="stringliteral">&#39;params&#39;</span> =&gt; [<span class="stringliteral">&#39;:user_id&#39;</span> =&gt; $user_id]]</div>
<div class="line"><a id="l00688" name="l00688"></a><span class="lineno">  688</span>        )) {</div>
<div class="line"><a id="l00689" name="l00689"></a><span class="lineno">  689</span>            <span class="keywordflow">throw</span> <span class="keyword">new</span> RuntimeException(</div>
<div class="line"><a id="l00690" name="l00690"></a><span class="lineno">  690</span>                __FILE__ . <span class="charliteral">&#39;:&#39;</span> . __LINE__ . <span class="stringliteral">&#39; (&#39;</span> . (__METHOD__ ?: __FUNCTION__ ?: <span class="stringliteral">&#39;global&#39;</span>) . <span class="stringliteral">&quot;) | Ошибка базы данных | Не удалось обновить дату последней активности пользователя с ID: $user_id&quot;</span></div>
<div class="line"><a id="l00691" name="l00691"></a><span class="lineno">  691</span>            );</div>
<div class="line"><a id="l00692" name="l00692"></a><span class="lineno">  692</span>        }</div>
<div class="line"><a id="l00693" name="l00693"></a><span class="lineno">  693</span>    }</div>
</div>
<div class="line"><a id="l00694" name="l00694"></a><span class="lineno">  694</span></div>
<div class="foldopen" id="foldopen00730" data-start="{" data-end="}">
<div class="line"><a id="l00730" name="l00730"></a><span class="lineno"><a class="line" href="../../df/dfe/classPhotoRigma_1_1Classes_1_1User.html#abc511791f65e1fca6093700a8a3fee23">  730</a></span>    <span class="keyword">private</span> <span class="keyword">function</span> <a class="code hl_function" href="../../df/dfe/classPhotoRigma_1_1Classes_1_1User.html#abc511791f65e1fca6093700a8a3fee23">_merge_user_with_group</a>(array $group_data): void</div>
<div class="line"><a id="l00731" name="l00731"></a><span class="lineno">  731</span>    {</div>
<div class="line"><a id="l00732" name="l00732"></a><span class="lineno">  732</span>        <span class="keywordflow">foreach</span> ($group_data as $key =&gt; $value) {</div>
<div class="line"><a id="l00733" name="l00733"></a><span class="lineno">  733</span>            match ($key) {</div>
<div class="line"><a id="l00734" name="l00734"></a><span class="lineno">  734</span>                <span class="stringliteral">&#39;name&#39;</span>  =&gt; [</div>
<div class="line"><a id="l00735" name="l00735"></a><span class="lineno">  735</span>                    $this-&gt;user[<span class="stringliteral">&#39;group_name&#39;</span>] = $value,</div>
<div class="line"><a id="l00736" name="l00736"></a><span class="lineno">  736</span>                ],</div>
<div class="line"><a id="l00737" name="l00737"></a><span class="lineno">  737</span>                <span class="stringliteral">&#39;id&#39;</span>    =&gt; <span class="keyword">null</span>, <span class="comment">// Пропускаем ключ &#39;id&#39;</span></div>
<div class="line"><a id="l00738" name="l00738"></a><span class="lineno">  738</span>                <span class="keywordflow">default</span> =&gt; $this-&gt;user[$key] = isset($this-&gt;user[$key]) &amp;&amp; !$this-&gt;user[$key] &amp;&amp; !$value ? false : $value,</div>
<div class="line"><a id="l00739" name="l00739"></a><span class="lineno">  739</span>            };</div>
<div class="line"><a id="l00740" name="l00740"></a><span class="lineno">  740</span>        }</div>
<div class="line"><a id="l00741" name="l00741"></a><span class="lineno">  741</span>    }</div>
</div>
<div class="line"><a id="l00742" name="l00742"></a><span class="lineno">  742</span></div>
<div class="foldopen" id="foldopen00788" data-start="{" data-end="}">
<div class="line"><a id="l00788" name="l00788"></a><span class="lineno"><a class="line" href="../../df/dfe/classPhotoRigma_1_1Classes_1_1User.html#ad677f704af643ac0152f7d46455bf769">  788</a></span>    <span class="keyword">public</span> <span class="keyword">function</span> <a class="code hl_function" href="../../df/dfe/classPhotoRigma_1_1Classes_1_1User.html#ad677f704af643ac0152f7d46455bf769">set_property_key</a>(<span class="keywordtype">string</span> $name, <span class="keywordtype">string</span> $key, <span class="keywordtype">string</span>|<span class="keywordtype">int</span>|<span class="keywordtype">bool</span> $value): void</div>
<div class="line"><a id="l00789" name="l00789"></a><span class="lineno">  789</span>    {</div>
<div class="line"><a id="l00790" name="l00790"></a><span class="lineno">  790</span>        $this-&gt;<a class="code hl_function" href="../../df/dfe/classPhotoRigma_1_1Classes_1_1User.html#a60ad4ddd8eb6b52a14c926e2a495dcba">_set_property_key_internal</a>($name, $key, $value);</div>
<div class="line"><a id="l00791" name="l00791"></a><span class="lineno">  791</span>    }</div>
</div>
<div class="line"><a id="l00792" name="l00792"></a><span class="lineno">  792</span></div>
<div class="foldopen" id="foldopen00841" data-start="{" data-end="}">
<div class="line"><a id="l00841" name="l00841"></a><span class="lineno"><a class="line" href="../../df/dfe/classPhotoRigma_1_1Classes_1_1User.html#a60ad4ddd8eb6b52a14c926e2a495dcba">  841</a></span>    <span class="keyword">protected</span> <span class="keyword">function</span> <a class="code hl_function" href="../../df/dfe/classPhotoRigma_1_1Classes_1_1User.html#a60ad4ddd8eb6b52a14c926e2a495dcba">_set_property_key_internal</a>(<span class="keywordtype">string</span> $name, <span class="keywordtype">string</span> $key, <span class="keywordtype">string</span>|<span class="keywordtype">int</span>|<span class="keywordtype">bool</span> $value): void</div>
<div class="line"><a id="l00842" name="l00842"></a><span class="lineno">  842</span>    {</div>
<div class="line"><a id="l00843" name="l00843"></a><span class="lineno">  843</span>        <span class="comment">// Проверяем, какой массив нужно изменить</span></div>
<div class="line"><a id="l00844" name="l00844"></a><span class="lineno">  844</span>        <span class="keywordflow">switch</span> ($name) {</div>
<div class="line"><a id="l00845" name="l00845"></a><span class="lineno">  845</span>            <span class="keywordflow">case</span> <span class="stringliteral">&#39;user&#39;</span>:</div>
<div class="line"><a id="l00846" name="l00846"></a><span class="lineno">  846</span>                $this-&gt;user[$key] = $value;</div>
<div class="line"><a id="l00847" name="l00847"></a><span class="lineno">  847</span>                <span class="keywordflow">break</span>;</div>
<div class="line"><a id="l00848" name="l00848"></a><span class="lineno">  848</span> </div>
<div class="line"><a id="l00849" name="l00849"></a><span class="lineno">  849</span>            <span class="keywordflow">case</span> <span class="stringliteral">&#39;session&#39;</span>:</div>
<div class="line"><a id="l00850" name="l00850"></a><span class="lineno">  850</span>                $this-&gt;session[$key] = $value;</div>
<div class="line"><a id="l00851" name="l00851"></a><span class="lineno">  851</span>                <span class="keywordflow">break</span>;</div>
<div class="line"><a id="l00852" name="l00852"></a><span class="lineno">  852</span> </div>
<div class="line"><a id="l00853" name="l00853"></a><span class="lineno">  853</span>            <span class="keywordflow">default</span>:</div>
<div class="line"><a id="l00854" name="l00854"></a><span class="lineno">  854</span>                <span class="keywordflow">throw</span> <span class="keyword">new</span> InvalidArgumentException(</div>
<div class="line"><a id="l00855" name="l00855"></a><span class="lineno">  855</span>                    __FILE__ . <span class="charliteral">&#39;:&#39;</span> . __LINE__ . <span class="stringliteral">&#39; (&#39;</span> . (__METHOD__ ?: __FUNCTION__ ?: <span class="stringliteral">&#39;global&#39;</span>) . <span class="stringliteral">&#39;) | &#39;</span> . <span class="stringliteral">&quot;Недопустимое свойство | Свойство: $name&quot;</span></div>
<div class="line"><a id="l00856" name="l00856"></a><span class="lineno">  856</span>                );</div>
<div class="line"><a id="l00857" name="l00857"></a><span class="lineno">  857</span>        }</div>
<div class="line"><a id="l00858" name="l00858"></a><span class="lineno">  858</span>    }</div>
</div>
<div class="line"><a id="l00859" name="l00859"></a><span class="lineno">  859</span></div>
<div class="foldopen" id="foldopen00894" data-start="{" data-end="}">
<div class="line"><a id="l00894" name="l00894"></a><span class="lineno"><a class="line" href="../../df/dfe/classPhotoRigma_1_1Classes_1_1User.html#a0bb4e25a2291e3792c181a821de0c88c">  894</a></span>    <span class="keyword">public</span> <span class="keyword">function</span> <a class="code hl_function" href="../../df/dfe/classPhotoRigma_1_1Classes_1_1User.html#a0bb4e25a2291e3792c181a821de0c88c">set_work</a>(<a class="code hl_interface" href="../../da/d79/interfacePhotoRigma_1_1Interfaces_1_1Work__Interface.html">Work_Interface</a> <a class="code hl_variable" href="../../df/dfe/classPhotoRigma_1_1Classes_1_1User.html#a440fb4e1ddf381895225c74da750d6ce">$work</a>): void</div>
<div class="line"><a id="l00895" name="l00895"></a><span class="lineno">  895</span>    {</div>
<div class="line"><a id="l00896" name="l00896"></a><span class="lineno">  896</span>        $this-&gt;<a class="code hl_function" href="../../df/dfe/classPhotoRigma_1_1Classes_1_1User.html#aaf0dcd4a67d4b0f9d67121936d09b848">_set_work_internal</a>($work);</div>
<div class="line"><a id="l00897" name="l00897"></a><span class="lineno">  897</span>    }</div>
</div>
<div class="line"><a id="l00898" name="l00898"></a><span class="lineno">  898</span></div>
<div class="foldopen" id="foldopen00944" data-start="{" data-end="}">
<div class="line"><a id="l00944" name="l00944"></a><span class="lineno"><a class="line" href="../../df/dfe/classPhotoRigma_1_1Classes_1_1User.html#aaf0dcd4a67d4b0f9d67121936d09b848">  944</a></span>    <span class="keyword">protected</span> <span class="keyword">function</span> <a class="code hl_function" href="../../df/dfe/classPhotoRigma_1_1Classes_1_1User.html#aaf0dcd4a67d4b0f9d67121936d09b848">_set_work_internal</a>(<a class="code hl_interface" href="../../da/d79/interfacePhotoRigma_1_1Interfaces_1_1Work__Interface.html">Work_Interface</a> <a class="code hl_variable" href="../../df/dfe/classPhotoRigma_1_1Classes_1_1User.html#a440fb4e1ddf381895225c74da750d6ce">$work</a>): void</div>
<div class="line"><a id="l00945" name="l00945"></a><span class="lineno">  945</span>    {</div>
<div class="line"><a id="l00946" name="l00946"></a><span class="lineno">  946</span>        $this-&gt;work = <a class="code hl_variable" href="../../df/dfe/classPhotoRigma_1_1Classes_1_1User.html#a440fb4e1ddf381895225c74da750d6ce">$work</a>;</div>
<div class="line"><a id="l00947" name="l00947"></a><span class="lineno">  947</span>        $this-&gt;session[<span class="stringliteral">&#39;theme&#39;</span>] ??= <a class="code hl_variable" href="../../df/dfe/classPhotoRigma_1_1Classes_1_1User.html#a440fb4e1ddf381895225c74da750d6ce">$work</a>-&gt;config[<span class="stringliteral">&#39;theme&#39;</span>];</div>
<div class="line"><a id="l00948" name="l00948"></a><span class="lineno">  948</span>        $this-&gt;session[<span class="stringliteral">&#39;language&#39;</span>] ??= <a class="code hl_variable" href="../../df/dfe/classPhotoRigma_1_1Classes_1_1User.html#a440fb4e1ddf381895225c74da750d6ce">$work</a>-&gt;config[<span class="stringliteral">&#39;language&#39;</span>];</div>
<div class="line"><a id="l00949" name="l00949"></a><span class="lineno">  949</span>        $this-&gt;session[<span class="stringliteral">&#39;timezone&#39;</span>] ??= <a class="code hl_variable" href="../../df/dfe/classPhotoRigma_1_1Classes_1_1User.html#a440fb4e1ddf381895225c74da750d6ce">$work</a>-&gt;config[<span class="stringliteral">&#39;timezone&#39;</span>];</div>
<div class="line"><a id="l00950" name="l00950"></a><span class="lineno">  950</span>    }</div>
</div>
<div class="line"><a id="l00951" name="l00951"></a><span class="lineno">  951</span></div>
<div class="foldopen" id="foldopen01002" data-start="{" data-end="}">
<div class="line"><a id="l01002" name="l01002"></a><span class="lineno"><a class="line" href="../../df/dfe/classPhotoRigma_1_1Classes_1_1User.html#a0acd7052f38245fd3723ea29c83bf3f3"> 1002</a></span>    <span class="keyword">public</span> <span class="keyword">function</span> <a class="code hl_function" href="../../df/dfe/classPhotoRigma_1_1Classes_1_1User.html#a0acd7052f38245fd3723ea29c83bf3f3">__get</a>(<span class="keywordtype">string</span> $name): array</div>
<div class="line"><a id="l01003" name="l01003"></a><span class="lineno"> 1003</span>    {</div>
<div class="line"><a id="l01004" name="l01004"></a><span class="lineno"> 1004</span>        <span class="keywordflow">return</span> match ($name) {</div>
<div class="line"><a id="l01005" name="l01005"></a><span class="lineno"> 1005</span>            <span class="stringliteral">&#39;user&#39;</span>              =&gt; <a class="code hl_variable" href="../../df/dfe/classPhotoRigma_1_1Classes_1_1User.html#a54301e4038f95a7b17247e0d674ff3d6">$this-&gt;user</a>,</div>
<div class="line"><a id="l01006" name="l01006"></a><span class="lineno"> 1006</span>            <span class="stringliteral">&#39;session&#39;</span>           =&gt; <a class="code hl_variable" href="../../df/dfe/classPhotoRigma_1_1Classes_1_1User.html#aa4aebf7c7377e1c2823e0520d16de530">$this-&gt;session</a>,</div>
<div class="line"><a id="l01007" name="l01007"></a><span class="lineno"> 1007</span>            <span class="stringliteral">&#39;user_right_fields&#39;</span> =&gt; <a class="code hl_variable" href="../../df/dfe/classPhotoRigma_1_1Classes_1_1User.html#af31e6e13ab6e21a8020e1573c9899c5f">$this-&gt;user_right_fields</a>,</div>
<div class="line"><a id="l01008" name="l01008"></a><span class="lineno"> 1008</span>            <span class="keywordflow">default</span>             =&gt; <span class="keywordflow">throw</span> <span class="keyword">new</span> InvalidArgumentException(</div>
<div class="line"><a id="l01009" name="l01009"></a><span class="lineno"> 1009</span>                __FILE__ . <span class="charliteral">&#39;:&#39;</span> . __LINE__ . <span class="stringliteral">&#39; (&#39;</span> . (__METHOD__ ?: __FUNCTION__ ?: <span class="stringliteral">&#39;global&#39;</span>) . <span class="stringliteral">&quot;) | Свойство не существует | Получено: &#39;$name&#39;&quot;</span></div>
<div class="line"><a id="l01010" name="l01010"></a><span class="lineno"> 1010</span>            ),</div>
<div class="line"><a id="l01011" name="l01011"></a><span class="lineno"> 1011</span>        };</div>
<div class="line"><a id="l01012" name="l01012"></a><span class="lineno"> 1012</span>    }</div>
</div>
<div class="line"><a id="l01013" name="l01013"></a><span class="lineno"> 1013</span></div>
<div class="foldopen" id="foldopen01065" data-start="{" data-end="}">
<div class="line"><a id="l01065" name="l01065"></a><span class="lineno"><a class="line" href="../../df/dfe/classPhotoRigma_1_1Classes_1_1User.html#a7c8aa5e8f1335dd150232b9ba442d694"> 1065</a></span>    <span class="keyword">public</span> <span class="keyword">function</span> <a class="code hl_function" href="../../df/dfe/classPhotoRigma_1_1Classes_1_1User.html#a7c8aa5e8f1335dd150232b9ba442d694">__set</a>(<span class="keywordtype">string</span> $name, array $value): void</div>
<div class="line"><a id="l01066" name="l01066"></a><span class="lineno"> 1066</span>    {</div>
<div class="line"><a id="l01067" name="l01067"></a><span class="lineno"> 1067</span>        <span class="comment">// Разрешаем изменять только свойство &#39;session&#39;</span></div>
<div class="line"><a id="l01068" name="l01068"></a><span class="lineno"> 1068</span>        <span class="keywordflow">if</span> ($name !== <span class="stringliteral">&#39;session&#39;</span>) {</div>
<div class="line"><a id="l01069" name="l01069"></a><span class="lineno"> 1069</span>            <span class="keywordflow">throw</span> <span class="keyword">new</span> InvalidArgumentException(</div>
<div class="line"><a id="l01070" name="l01070"></a><span class="lineno"> 1070</span>                __FILE__ . <span class="charliteral">&#39;:&#39;</span> . __LINE__ . <span class="stringliteral">&#39; (&#39;</span> . (__METHOD__ ?: __FUNCTION__ ?: <span class="stringliteral">&#39;global&#39;</span>) . <span class="stringliteral">&#39;) | &#39;</span> . <span class="stringliteral">&quot;Несуществующее свойство | Свойство: $name&quot;</span></div>
<div class="line"><a id="l01071" name="l01071"></a><span class="lineno"> 1071</span>            );</div>
<div class="line"><a id="l01072" name="l01072"></a><span class="lineno"> 1072</span>        }</div>
<div class="line"><a id="l01073" name="l01073"></a><span class="lineno"> 1073</span> </div>
<div class="line"><a id="l01074" name="l01074"></a><span class="lineno"> 1074</span>        <span class="comment">// Получаем текущее значение свойства</span></div>
<div class="line"><a id="l01075" name="l01075"></a><span class="lineno"> 1075</span>        $current_value = $this-&gt;$name;</div>
<div class="line"><a id="l01076" name="l01076"></a><span class="lineno"> 1076</span> </div>
<div class="line"><a id="l01077" name="l01077"></a><span class="lineno"> 1077</span>        <span class="comment">// Обновляем только те ключи, которые переданы в $value</span></div>
<div class="line"><a id="l01078" name="l01078"></a><span class="lineno"> 1078</span>        <span class="keywordflow">foreach</span> ($value as $key =&gt; $val) {</div>
<div class="line"><a id="l01079" name="l01079"></a><span class="lineno"> 1079</span>            $current_value[$key] = $val;</div>
<div class="line"><a id="l01080" name="l01080"></a><span class="lineno"> 1080</span>        }</div>
<div class="line"><a id="l01081" name="l01081"></a><span class="lineno"> 1081</span> </div>
<div class="line"><a id="l01082" name="l01082"></a><span class="lineno"> 1082</span>        <span class="comment">// Логируем изменения</span></div>
<div class="line"><a id="l01083" name="l01083"></a><span class="lineno"> 1083</span>        $updated_keys = array_intersect_key($value, $this-&gt;$name); <span class="comment">// Ключи, которые были обновлены</span></div>
<div class="line"><a id="l01084" name="l01084"></a><span class="lineno"> 1084</span>        $added_keys = array_diff_key($value, $this-&gt;$name); <span class="comment">// Новые ключи</span></div>
<div class="line"><a id="l01085" name="l01085"></a><span class="lineno"> 1085</span> </div>
<div class="line"><a id="l01086" name="l01086"></a><span class="lineno"> 1086</span>        <span class="keywordflow">if</span> (!empty($updated_keys)) {</div>
<div class="line"><a id="l01087" name="l01087"></a><span class="lineno"> 1087</span>            log_in_file(</div>
<div class="line"><a id="l01088" name="l01088"></a><span class="lineno"> 1088</span>                __FILE__ . <span class="charliteral">&#39;:&#39;</span> . __LINE__ . <span class="stringliteral">&#39; (&#39;</span> . (__METHOD__ ?: __FUNCTION__ ?: <span class="stringliteral">&#39;global&#39;</span>) . <span class="stringliteral">&#39;) | &#39;</span> . <span class="stringliteral">&quot;Обновление свойства &#39;$name&#39; | Изменённые ключи: &quot;</span> . json_encode(</div>
<div class="line"><a id="l01089" name="l01089"></a><span class="lineno"> 1089</span>                    $updated_keys,</div>
<div class="line"><a id="l01090" name="l01090"></a><span class="lineno"> 1090</span>                    JSON_THROW_ON_ERROR | JSON_UNESCAPED_UNICODE | JSON_PRETTY_PRINT</div>
<div class="line"><a id="l01091" name="l01091"></a><span class="lineno"> 1091</span>                )</div>
<div class="line"><a id="l01092" name="l01092"></a><span class="lineno"> 1092</span>            );</div>
<div class="line"><a id="l01093" name="l01093"></a><span class="lineno"> 1093</span>        }</div>
<div class="line"><a id="l01094" name="l01094"></a><span class="lineno"> 1094</span>        <span class="keywordflow">if</span> (!empty($added_keys)) {</div>
<div class="line"><a id="l01095" name="l01095"></a><span class="lineno"> 1095</span>            log_in_file(</div>
<div class="line"><a id="l01096" name="l01096"></a><span class="lineno"> 1096</span>                __FILE__ . <span class="charliteral">&#39;:&#39;</span> . __LINE__ . <span class="stringliteral">&#39; (&#39;</span> . (__METHOD__ ?: __FUNCTION__ ?: <span class="stringliteral">&#39;global&#39;</span>) . <span class="stringliteral">&#39;) | &#39;</span> . <span class="stringliteral">&quot;Добавление в свойство &#39;$name&#39; | Новые ключи: &quot;</span> . json_encode(</div>
<div class="line"><a id="l01097" name="l01097"></a><span class="lineno"> 1097</span>                    $added_keys,</div>
<div class="line"><a id="l01098" name="l01098"></a><span class="lineno"> 1098</span>                    JSON_THROW_ON_ERROR | JSON_UNESCAPED_UNICODE | JSON_PRETTY_PRINT</div>
<div class="line"><a id="l01099" name="l01099"></a><span class="lineno"> 1099</span>                )</div>
<div class="line"><a id="l01100" name="l01100"></a><span class="lineno"> 1100</span>            );</div>
<div class="line"><a id="l01101" name="l01101"></a><span class="lineno"> 1101</span>        }</div>
<div class="line"><a id="l01102" name="l01102"></a><span class="lineno"> 1102</span> </div>
<div class="line"><a id="l01103" name="l01103"></a><span class="lineno"> 1103</span>        <span class="comment">// Обновляем свойство</span></div>
<div class="line"><a id="l01104" name="l01104"></a><span class="lineno"> 1104</span>        $this-&gt;$name = $current_value;</div>
<div class="line"><a id="l01105" name="l01105"></a><span class="lineno"> 1105</span>    }</div>
</div>
<div class="line"><a id="l01106" name="l01106"></a><span class="lineno"> 1106</span></div>
<div class="foldopen" id="foldopen01135" data-start="{" data-end="}">
<div class="line"><a id="l01135" name="l01135"></a><span class="lineno"><a class="line" href="../../df/dfe/classPhotoRigma_1_1Classes_1_1User.html#a0c45daa80235f514090aa7789f5e93b3"> 1135</a></span>    <span class="keyword">public</span> <span class="keyword">function</span> <a class="code hl_function" href="../../df/dfe/classPhotoRigma_1_1Classes_1_1User.html#a0c45daa80235f514090aa7789f5e93b3">__isset</a>(<span class="keywordtype">string</span> $name): bool</div>
<div class="line"><a id="l01136" name="l01136"></a><span class="lineno"> 1136</span>    {</div>
<div class="line"><a id="l01137" name="l01137"></a><span class="lineno"> 1137</span>        <span class="keywordflow">return</span> isset($this-&gt;$name);</div>
<div class="line"><a id="l01138" name="l01138"></a><span class="lineno"> 1138</span>    }</div>
</div>
<div class="line"><a id="l01139" name="l01139"></a><span class="lineno"> 1139</span></div>
<div class="foldopen" id="foldopen01180" data-start="{" data-end="}">
<div class="line"><a id="l01180" name="l01180"></a><span class="lineno"><a class="line" href="../../df/dfe/classPhotoRigma_1_1Classes_1_1User.html#acb35e2058e1fa1189a515873e76e62dd"> 1180</a></span>    <span class="keyword">public</span> <span class="keyword">function</span> <a class="code hl_function" href="../../df/dfe/classPhotoRigma_1_1Classes_1_1User.html#acb35e2058e1fa1189a515873e76e62dd">add_new_group</a>(array $group_data): int</div>
<div class="line"><a id="l01181" name="l01181"></a><span class="lineno"> 1181</span>    {</div>
<div class="line"><a id="l01182" name="l01182"></a><span class="lineno"> 1182</span>        <span class="keywordflow">return</span> $this-&gt;<a class="code hl_function" href="../../df/dfe/classPhotoRigma_1_1Classes_1_1User.html#a0e838259fa4a4581be6a51e6ae8ab238">_add_new_group_internal</a>($group_data);</div>
<div class="line"><a id="l01183" name="l01183"></a><span class="lineno"> 1183</span>    }</div>
</div>
<div class="line"><a id="l01184" name="l01184"></a><span class="lineno"> 1184</span></div>
<div class="foldopen" id="foldopen01237" data-start="{" data-end="}">
<div class="line"><a id="l01237" name="l01237"></a><span class="lineno"><a class="line" href="../../df/dfe/classPhotoRigma_1_1Classes_1_1User.html#a0e838259fa4a4581be6a51e6ae8ab238"> 1237</a></span>    <span class="keyword">protected</span> <span class="keyword">function</span> <a class="code hl_function" href="../../df/dfe/classPhotoRigma_1_1Classes_1_1User.html#a0e838259fa4a4581be6a51e6ae8ab238">_add_new_group_internal</a>(array $group_data): int</div>
<div class="line"><a id="l01238" name="l01238"></a><span class="lineno"> 1238</span>    {</div>
<div class="line"><a id="l01239" name="l01239"></a><span class="lineno"> 1239</span>        $query_data = [];</div>
<div class="line"><a id="l01240" name="l01240"></a><span class="lineno"> 1240</span>        $params_data = [];</div>
<div class="line"><a id="l01241" name="l01241"></a><span class="lineno"> 1241</span> </div>
<div class="line"><a id="l01242" name="l01242"></a><span class="lineno"> 1242</span>        <span class="comment">// Проверяем и добавляем имя группы</span></div>
<div class="line"><a id="l01243" name="l01243"></a><span class="lineno"> 1243</span>        <span class="keywordflow">if</span> ($this-&gt;work-&gt;check_input(<span class="stringliteral">&#39;_POST&#39;</span>, <span class="stringliteral">&#39;name_group&#39;</span>, [<span class="stringliteral">&#39;isset&#39;</span> =&gt; <span class="keyword">true</span>, <span class="stringliteral">&#39;empty&#39;</span> =&gt; <span class="keyword">true</span>, <span class="stringliteral">&#39;regexp&#39;</span> =&gt; REG_NAME])) {</div>
<div class="line"><a id="l01244" name="l01244"></a><span class="lineno"> 1244</span>            $clean_name = <a class="code hl_function" href="../../d7/d53/classPhotoRigma_1_1Classes_1_1Work.html#a8ecb9d3a6cba675b7a2d72ddc14b53f3">Work::clean_field</a>($group_data[<span class="stringliteral">&#39;name_group&#39;</span>]);</div>
<div class="line"><a id="l01245" name="l01245"></a><span class="lineno"> 1245</span>            $query_data[<span class="stringliteral">&#39;`name`&#39;</span>] = <span class="stringliteral">&#39;:name&#39;</span>;</div>
<div class="line"><a id="l01246" name="l01246"></a><span class="lineno"> 1246</span>            $params_data[<span class="stringliteral">&#39;name&#39;</span>] = $clean_name;</div>
<div class="line"><a id="l01247" name="l01247"></a><span class="lineno"> 1247</span>        } <span class="keywordflow">else</span> {</div>
<div class="line"><a id="l01248" name="l01248"></a><span class="lineno"> 1248</span>            <span class="keywordflow">return</span> 0;</div>
<div class="line"><a id="l01249" name="l01249"></a><span class="lineno"> 1249</span>        }</div>
<div class="line"><a id="l01250" name="l01250"></a><span class="lineno"> 1250</span> </div>
<div class="line"><a id="l01251" name="l01251"></a><span class="lineno"> 1251</span>        $new_group_rights = [];</div>
<div class="line"><a id="l01252" name="l01252"></a><span class="lineno"> 1252</span> </div>
<div class="line"><a id="l01253" name="l01253"></a><span class="lineno"> 1253</span>        <span class="keywordflow">foreach</span> ($this-&gt;user_right_fields[<span class="stringliteral">&#39;all&#39;</span>] as $value) {</div>
<div class="line"><a id="l01254" name="l01254"></a><span class="lineno"> 1254</span>            <span class="comment">// Используем filter_var для корректной конвертации всех значений в bool</span></div>
<div class="line"><a id="l01255" name="l01255"></a><span class="lineno"> 1255</span>            $new_group_rights[$value] = filter_var(</div>
<div class="line"><a id="l01256" name="l01256"></a><span class="lineno"> 1256</span>                $group_data[$value] ?? <span class="keyword">false</span>,</div>
<div class="line"><a id="l01257" name="l01257"></a><span class="lineno"> 1257</span>                FILTER_VALIDATE_BOOLEAN</div>
<div class="line"><a id="l01258" name="l01258"></a><span class="lineno"> 1258</span>            );</div>
<div class="line"><a id="l01259" name="l01259"></a><span class="lineno"> 1259</span>        }</div>
<div class="line"><a id="l01260" name="l01260"></a><span class="lineno"> 1260</span> </div>
<div class="line"><a id="l01261" name="l01261"></a><span class="lineno"> 1261</span>        <span class="comment">// Кодируем права доступа</span></div>
<div class="line"><a id="l01262" name="l01262"></a><span class="lineno"> 1262</span>        $encoded_group_rights = $this-&gt;<a class="code hl_function" href="../../df/dfe/classPhotoRigma_1_1Classes_1_1User.html#ab6a181342a4b7b3aac421c86eb537238">_encode_user_rights_internal</a>($new_group_rights);</div>
<div class="line"><a id="l01263" name="l01263"></a><span class="lineno"> 1263</span> </div>
<div class="line"><a id="l01264" name="l01264"></a><span class="lineno"> 1264</span>        $query_data[<span class="stringliteral">&#39;`user_rights`&#39;</span>] = <span class="stringliteral">&#39;:user_rights&#39;</span>;</div>
<div class="line"><a id="l01265" name="l01265"></a><span class="lineno"> 1265</span>        $params_data[<span class="stringliteral">&#39;user_rights&#39;</span>] = $encoded_group_rights;</div>
<div class="line"><a id="l01266" name="l01266"></a><span class="lineno"> 1266</span> </div>
<div class="line"><a id="l01267" name="l01267"></a><span class="lineno"> 1267</span>        <span class="comment">// Выполняем вставку</span></div>
<div class="line"><a id="l01268" name="l01268"></a><span class="lineno"> 1268</span>        $this-&gt;db-&gt;insert($query_data, TBL_GROUP, <span class="stringliteral">&#39;&#39;</span>, [<span class="stringliteral">&#39;params&#39;</span> =&gt; $params_data]);</div>
<div class="line"><a id="l01269" name="l01269"></a><span class="lineno"> 1269</span> </div>
<div class="line"><a id="l01270" name="l01270"></a><span class="lineno"> 1270</span>        <span class="keywordflow">return</span> $this-&gt;db-&gt;get_last_insert_id();</div>
<div class="line"><a id="l01271" name="l01271"></a><span class="lineno"> 1271</span>    }</div>
</div>
<div class="line"><a id="l01272" name="l01272"></a><span class="lineno"> 1272</span></div>
<div class="foldopen" id="foldopen01337" data-start="{" data-end="}">
<div class="line"><a id="l01337" name="l01337"></a><span class="lineno"><a class="line" href="../../df/dfe/classPhotoRigma_1_1Classes_1_1User.html#a4375fc668762fd63651b09a2a04f35bb"> 1337</a></span>    <span class="keyword">public</span> <span class="keyword">function</span> <a class="code hl_function" href="../../df/dfe/classPhotoRigma_1_1Classes_1_1User.html#a4375fc668762fd63651b09a2a04f35bb">add_new_user</a>(array $post_data): int</div>
<div class="line"><a id="l01338" name="l01338"></a><span class="lineno"> 1338</span>    {</div>
<div class="line"><a id="l01339" name="l01339"></a><span class="lineno"> 1339</span>        <span class="keywordflow">return</span> $this-&gt;<a class="code hl_function" href="../../df/dfe/classPhotoRigma_1_1Classes_1_1User.html#a2308665ad82b46f7f73e34750887dbee">_add_new_user_internal</a>($post_data);</div>
<div class="line"><a id="l01340" name="l01340"></a><span class="lineno"> 1340</span>    }</div>
</div>
<div class="line"><a id="l01341" name="l01341"></a><span class="lineno"> 1341</span></div>
<div class="foldopen" id="foldopen01428" data-start="{" data-end="}">
<div class="line"><a id="l01428" name="l01428"></a><span class="lineno"><a class="line" href="../../df/dfe/classPhotoRigma_1_1Classes_1_1User.html#a2308665ad82b46f7f73e34750887dbee"> 1428</a></span>    <span class="keyword">protected</span> <span class="keyword">function</span> <a class="code hl_function" href="../../df/dfe/classPhotoRigma_1_1Classes_1_1User.html#a2308665ad82b46f7f73e34750887dbee">_add_new_user_internal</a>(array $post_data): int</div>
<div class="line"><a id="l01429" name="l01429"></a><span class="lineno"> 1429</span>    {</div>
<div class="line"><a id="l01430" name="l01430"></a><span class="lineno"> 1430</span>        <span class="comment">// === 1. Валидация входных данных ===</span></div>
<div class="line"><a id="l01431" name="l01431"></a><span class="lineno"> 1431</span>        $error = <span class="keyword">false</span>;</div>
<div class="line"><a id="l01432" name="l01432"></a><span class="lineno"> 1432</span>        $field_validators = [</div>
<div class="line"><a id="l01433" name="l01433"></a><span class="lineno"> 1433</span>            <span class="stringliteral">&#39;login&#39;</span>       =&gt; [<span class="stringliteral">&#39;isset&#39;</span> =&gt; <span class="keyword">true</span>, <span class="stringliteral">&#39;empty&#39;</span> =&gt; <span class="keyword">true</span>, <span class="stringliteral">&#39;regexp&#39;</span> =&gt; REG_LOGIN],</div>
<div class="line"><a id="l01434" name="l01434"></a><span class="lineno"> 1434</span>            <span class="stringliteral">&#39;password&#39;</span>    =&gt; [<span class="stringliteral">&#39;isset&#39;</span> =&gt; <span class="keyword">true</span>, <span class="stringliteral">&#39;empty&#39;</span> =&gt; <span class="keyword">true</span>],</div>
<div class="line"><a id="l01435" name="l01435"></a><span class="lineno"> 1435</span>            <span class="stringliteral">&#39;re_password&#39;</span> =&gt; [<span class="stringliteral">&#39;isset&#39;</span> =&gt; <span class="keyword">true</span>, <span class="stringliteral">&#39;empty&#39;</span> =&gt; <span class="keyword">true</span>],</div>
<div class="line"><a id="l01436" name="l01436"></a><span class="lineno"> 1436</span>            <span class="stringliteral">&#39;email&#39;</span>       =&gt; [<span class="stringliteral">&#39;isset&#39;</span> =&gt; <span class="keyword">true</span>, <span class="stringliteral">&#39;empty&#39;</span> =&gt; <span class="keyword">true</span>, <span class="stringliteral">&#39;regexp&#39;</span> =&gt; REG_EMAIL],</div>
<div class="line"><a id="l01437" name="l01437"></a><span class="lineno"> 1437</span>            <span class="stringliteral">&#39;real_name&#39;</span>   =&gt; [<span class="stringliteral">&#39;isset&#39;</span> =&gt; <span class="keyword">true</span>, <span class="stringliteral">&#39;empty&#39;</span> =&gt; <span class="keyword">true</span>, <span class="stringliteral">&#39;regexp&#39;</span> =&gt; REG_NAME],</div>
<div class="line"><a id="l01438" name="l01438"></a><span class="lineno"> 1438</span>            <span class="stringliteral">&#39;captcha&#39;</span>     =&gt; [<span class="stringliteral">&#39;isset&#39;</span> =&gt; <span class="keyword">true</span>, <span class="stringliteral">&#39;empty&#39;</span> =&gt; <span class="keyword">true</span>, <span class="stringliteral">&#39;regexp&#39;</span> =&gt; <span class="stringliteral">&#39;/^[0-9]+$/&#39;</span>],</div>
<div class="line"><a id="l01439" name="l01439"></a><span class="lineno"> 1439</span>        ];</div>
<div class="line"><a id="l01440" name="l01440"></a><span class="lineno"> 1440</span> </div>
<div class="line"><a id="l01441" name="l01441"></a><span class="lineno"> 1441</span>        <span class="keywordflow">foreach</span> ($field_validators as $field =&gt; $options) {</div>
<div class="line"><a id="l01442" name="l01442"></a><span class="lineno"> 1442</span>            <span class="keywordflow">if</span> (!$this-&gt;work-&gt;check_input(<span class="stringliteral">&#39;_POST&#39;</span>, $field, $options)) {</div>
<div class="line"><a id="l01443" name="l01443"></a><span class="lineno"> 1443</span>                $this-&gt;session[<span class="stringliteral">&#39;error&#39;</span>][$field][<span class="stringliteral">&#39;if&#39;</span>] = <span class="keyword">true</span>;</div>
<div class="line"><a id="l01444" name="l01444"></a><span class="lineno"> 1444</span>                $this-&gt;session[<span class="stringliteral">&#39;error&#39;</span>][$field][<span class="stringliteral">&#39;text&#39;</span>] = match ($field) {</div>
<div class="line"><a id="l01445" name="l01445"></a><span class="lineno"> 1445</span>                    <span class="stringliteral">&#39;login&#39;</span>       =&gt; $this-&gt;work-&gt;lang[<span class="stringliteral">&#39;profile&#39;</span>][<span class="stringliteral">&#39;error_login&#39;</span>],</div>
<div class="line"><a id="l01446" name="l01446"></a><span class="lineno"> 1446</span>                    <span class="stringliteral">&#39;password&#39;</span>    =&gt; $this-&gt;work-&gt;lang[<span class="stringliteral">&#39;profile&#39;</span>][<span class="stringliteral">&#39;error_password&#39;</span>],</div>
<div class="line"><a id="l01447" name="l01447"></a><span class="lineno"> 1447</span>                    <span class="stringliteral">&#39;re_password&#39;</span> =&gt; $this-&gt;work-&gt;lang[<span class="stringliteral">&#39;profile&#39;</span>][<span class="stringliteral">&#39;error_re_password&#39;</span>],</div>
<div class="line"><a id="l01448" name="l01448"></a><span class="lineno"> 1448</span>                    <span class="stringliteral">&#39;email&#39;</span>       =&gt; $this-&gt;work-&gt;lang[<span class="stringliteral">&#39;profile&#39;</span>][<span class="stringliteral">&#39;error_email&#39;</span>],</div>
<div class="line"><a id="l01449" name="l01449"></a><span class="lineno"> 1449</span>                    <span class="stringliteral">&#39;real_name&#39;</span>   =&gt; $this-&gt;work-&gt;lang[<span class="stringliteral">&#39;profile&#39;</span>][<span class="stringliteral">&#39;error_real_name&#39;</span>],</div>
<div class="line"><a id="l01450" name="l01450"></a><span class="lineno"> 1450</span>                    <span class="stringliteral">&#39;captcha&#39;</span>     =&gt; $this-&gt;work-&gt;lang[<span class="stringliteral">&#39;profile&#39;</span>][<span class="stringliteral">&#39;error_captcha&#39;</span>],</div>
<div class="line"><a id="l01451" name="l01451"></a><span class="lineno"> 1451</span>                    <span class="keywordflow">default</span>       =&gt; <span class="stringliteral">&#39;Unknown error&#39;</span>,</div>
<div class="line"><a id="l01452" name="l01452"></a><span class="lineno"> 1452</span>                };</div>
<div class="line"><a id="l01453" name="l01453"></a><span class="lineno"> 1453</span>                $error = <span class="keyword">true</span>;</div>
<div class="line"><a id="l01454" name="l01454"></a><span class="lineno"> 1454</span>            } <span class="keywordflow">else</span> {</div>
<div class="line"><a id="l01455" name="l01455"></a><span class="lineno"> 1455</span>                <span class="comment">// Дополнительные проверки для re_password и captcha</span></div>
<div class="line"><a id="l01456" name="l01456"></a><span class="lineno"> 1456</span>                <span class="keywordflow">if</span> ($field === <span class="stringliteral">&#39;re_password&#39;</span> &amp;&amp; $post_data[<span class="stringliteral">&#39;re_password&#39;</span>] !== $post_data[<span class="stringliteral">&#39;password&#39;</span>]) {</div>
<div class="line"><a id="l01457" name="l01457"></a><span class="lineno"> 1457</span>                    $this-&gt;session[<span class="stringliteral">&#39;error&#39;</span>][<span class="stringliteral">&#39;re_password&#39;</span>][<span class="stringliteral">&#39;if&#39;</span>] = <span class="keyword">true</span>;</div>
<div class="line"><a id="l01458" name="l01458"></a><span class="lineno"> 1458</span>                    $this-&gt;session[<span class="stringliteral">&#39;error&#39;</span>][<span class="stringliteral">&#39;re_password&#39;</span>][<span class="stringliteral">&#39;text&#39;</span>] = $this-&gt;work-&gt;lang[<span class="stringliteral">&#39;profile&#39;</span>][<span class="stringliteral">&#39;error_re_password&#39;</span>];</div>
<div class="line"><a id="l01459" name="l01459"></a><span class="lineno"> 1459</span>                    $error = <span class="keyword">true</span>;</div>
<div class="line"><a id="l01460" name="l01460"></a><span class="lineno"> 1460</span>                }</div>
<div class="line"><a id="l01461" name="l01461"></a><span class="lineno"> 1461</span>                <span class="keywordflow">if</span> ($field === <span class="stringliteral">&#39;captcha&#39;</span> &amp;&amp; !password_verify($post_data[<span class="stringliteral">&#39;captcha&#39;</span>], $this-&gt;session[<span class="stringliteral">&#39;captcha&#39;</span>])) {</div>
<div class="line"><a id="l01462" name="l01462"></a><span class="lineno"> 1462</span>                    $this-&gt;session[<span class="stringliteral">&#39;error&#39;</span>][<span class="stringliteral">&#39;captcha&#39;</span>][<span class="stringliteral">&#39;if&#39;</span>] = <span class="keyword">true</span>;</div>
<div class="line"><a id="l01463" name="l01463"></a><span class="lineno"> 1463</span>                    $this-&gt;session[<span class="stringliteral">&#39;error&#39;</span>][<span class="stringliteral">&#39;captcha&#39;</span>][<span class="stringliteral">&#39;text&#39;</span>] = $this-&gt;work-&gt;lang[<span class="stringliteral">&#39;profile&#39;</span>][<span class="stringliteral">&#39;error_captcha&#39;</span>];</div>
<div class="line"><a id="l01464" name="l01464"></a><span class="lineno"> 1464</span>                    $error = <span class="keyword">true</span>;</div>
<div class="line"><a id="l01465" name="l01465"></a><span class="lineno"> 1465</span>                }</div>
<div class="line"><a id="l01466" name="l01466"></a><span class="lineno"> 1466</span>            }</div>
<div class="line"><a id="l01467" name="l01467"></a><span class="lineno"> 1467</span>        }</div>
<div class="line"><a id="l01468" name="l01468"></a><span class="lineno"> 1468</span>        $this-&gt;<a class="code hl_function" href="../../df/dfe/classPhotoRigma_1_1Classes_1_1User.html#ab19c821428e4402d7669bc3940afe6d7">unset_property_key</a>(<span class="stringliteral">&#39;session&#39;</span>, <span class="stringliteral">&#39;captcha&#39;</span>);</div>
<div class="line"><a id="l01469" name="l01469"></a><span class="lineno"> 1469</span> </div>
<div class="line"><a id="l01470" name="l01470"></a><span class="lineno"> 1470</span>        <span class="comment">// === 2. Проверка уникальности login, email и real_name ===</span></div>
<div class="line"><a id="l01471" name="l01471"></a><span class="lineno"> 1471</span>        $this-&gt;db-&gt;select(</div>
<div class="line"><a id="l01472" name="l01472"></a><span class="lineno"> 1472</span>            <span class="stringliteral">&#39;COUNT(CASE WHEN `login` = :login THEN 1 END) as `login_count`,</span></div>
<div class="line"><a id="l01473" name="l01473"></a><span class="lineno"> 1473</span><span class="stringliteral">             COUNT(CASE WHEN `email` = :email THEN 1 END) as `email_count`,</span></div>
<div class="line"><a id="l01474" name="l01474"></a><span class="lineno"> 1474</span><span class="stringliteral">             COUNT(CASE WHEN `real_name` = :real_name THEN 1 END) as `real_count`&#39;</span>,</div>
<div class="line"><a id="l01475" name="l01475"></a><span class="lineno"> 1475</span>            TBL_USERS,</div>
<div class="line"><a id="l01476" name="l01476"></a><span class="lineno"> 1476</span>            [</div>
<div class="line"><a id="l01477" name="l01477"></a><span class="lineno"> 1477</span>                <span class="stringliteral">&#39;params&#39;</span> =&gt; [</div>
<div class="line"><a id="l01478" name="l01478"></a><span class="lineno"> 1478</span>                    <span class="stringliteral">&#39;:login&#39;</span>     =&gt; $post_data[<span class="stringliteral">&#39;login&#39;</span>],</div>
<div class="line"><a id="l01479" name="l01479"></a><span class="lineno"> 1479</span>                    <span class="stringliteral">&#39;:email&#39;</span>     =&gt; $post_data[<span class="stringliteral">&#39;email&#39;</span>],</div>
<div class="line"><a id="l01480" name="l01480"></a><span class="lineno"> 1480</span>                    <span class="stringliteral">&#39;:real_name&#39;</span> =&gt; $post_data[<span class="stringliteral">&#39;real_name&#39;</span>],</div>
<div class="line"><a id="l01481" name="l01481"></a><span class="lineno"> 1481</span>                ],</div>
<div class="line"><a id="l01482" name="l01482"></a><span class="lineno"> 1482</span>            ]</div>
<div class="line"><a id="l01483" name="l01483"></a><span class="lineno"> 1483</span>        );</div>
<div class="line"><a id="l01484" name="l01484"></a><span class="lineno"> 1484</span>        $unique_check_result = $this-&gt;db-&gt;result_row();</div>
<div class="line"><a id="l01485" name="l01485"></a><span class="lineno"> 1485</span> </div>
<div class="line"><a id="l01486" name="l01486"></a><span class="lineno"> 1486</span>        <span class="keywordflow">if</span> ($unique_check_result) {</div>
<div class="line"><a id="l01487" name="l01487"></a><span class="lineno"> 1487</span>            <span class="keywordflow">if</span> ($unique_check_result[<span class="stringliteral">&#39;login_count&#39;</span>] &gt; 0) {</div>
<div class="line"><a id="l01488" name="l01488"></a><span class="lineno"> 1488</span>                $error = <span class="keyword">true</span>;</div>
<div class="line"><a id="l01489" name="l01489"></a><span class="lineno"> 1489</span>                $this-&gt;session[<span class="stringliteral">&#39;error&#39;</span>][<span class="stringliteral">&#39;login&#39;</span>][<span class="stringliteral">&#39;if&#39;</span>] = <span class="keyword">true</span>;</div>
<div class="line"><a id="l01490" name="l01490"></a><span class="lineno"> 1490</span>                $this-&gt;session[<span class="stringliteral">&#39;error&#39;</span>][<span class="stringliteral">&#39;login&#39;</span>][<span class="stringliteral">&#39;text&#39;</span>] = $this-&gt;work-&gt;lang[<span class="stringliteral">&#39;profile&#39;</span>][<span class="stringliteral">&#39;error_login_exists&#39;</span>];</div>
<div class="line"><a id="l01491" name="l01491"></a><span class="lineno"> 1491</span>            }</div>
<div class="line"><a id="l01492" name="l01492"></a><span class="lineno"> 1492</span>            <span class="keywordflow">if</span> ($unique_check_result[<span class="stringliteral">&#39;email_count&#39;</span>] &gt; 0) {</div>
<div class="line"><a id="l01493" name="l01493"></a><span class="lineno"> 1493</span>                $error = <span class="keyword">true</span>;</div>
<div class="line"><a id="l01494" name="l01494"></a><span class="lineno"> 1494</span>                $this-&gt;session[<span class="stringliteral">&#39;error&#39;</span>][<span class="stringliteral">&#39;email&#39;</span>][<span class="stringliteral">&#39;if&#39;</span>] = <span class="keyword">true</span>;</div>
<div class="line"><a id="l01495" name="l01495"></a><span class="lineno"> 1495</span>                $this-&gt;session[<span class="stringliteral">&#39;error&#39;</span>][<span class="stringliteral">&#39;email&#39;</span>][<span class="stringliteral">&#39;text&#39;</span>] = $this-&gt;work-&gt;lang[<span class="stringliteral">&#39;profile&#39;</span>][<span class="stringliteral">&#39;error_email_exists&#39;</span>];</div>
<div class="line"><a id="l01496" name="l01496"></a><span class="lineno"> 1496</span>            }</div>
<div class="line"><a id="l01497" name="l01497"></a><span class="lineno"> 1497</span>            <span class="keywordflow">if</span> ($unique_check_result[<span class="stringliteral">&#39;real_count&#39;</span>] &gt; 0) {</div>
<div class="line"><a id="l01498" name="l01498"></a><span class="lineno"> 1498</span>                $error = <span class="keyword">true</span>;</div>
<div class="line"><a id="l01499" name="l01499"></a><span class="lineno"> 1499</span>                $this-&gt;session[<span class="stringliteral">&#39;error&#39;</span>][<span class="stringliteral">&#39;real_name&#39;</span>][<span class="stringliteral">&#39;if&#39;</span>] = <span class="keyword">true</span>;</div>
<div class="line"><a id="l01500" name="l01500"></a><span class="lineno"> 1500</span>                $this-&gt;session[<span class="stringliteral">&#39;error&#39;</span>][<span class="stringliteral">&#39;real_name&#39;</span>][<span class="stringliteral">&#39;text&#39;</span>] = $this-&gt;work-&gt;lang[<span class="stringliteral">&#39;profile&#39;</span>][<span class="stringliteral">&#39;error_real_name_exists&#39;</span>];</div>
<div class="line"><a id="l01501" name="l01501"></a><span class="lineno"> 1501</span>            }</div>
<div class="line"><a id="l01502" name="l01502"></a><span class="lineno"> 1502</span>        }</div>
<div class="line"><a id="l01503" name="l01503"></a><span class="lineno"> 1503</span> </div>
<div class="line"><a id="l01504" name="l01504"></a><span class="lineno"> 1504</span>        <span class="comment">// === 3. Если возникли ошибки, сохраняем их в сессии и завершаем ===</span></div>
<div class="line"><a id="l01505" name="l01505"></a><span class="lineno"> 1505</span>        <span class="keywordflow">if</span> ($error) {</div>
<div class="line"><a id="l01506" name="l01506"></a><span class="lineno"> 1506</span>            <span class="keywordflow">return</span> 0; <span class="comment">// Возвращаем 0, чтобы обозначить ошибку</span></div>
<div class="line"><a id="l01507" name="l01507"></a><span class="lineno"> 1507</span>        }</div>
<div class="line"><a id="l01508" name="l01508"></a><span class="lineno"> 1508</span> </div>
<div class="line"><a id="l01509" name="l01509"></a><span class="lineno"> 1509</span>        <span class="comment">// === 4. Добавление нового пользователя в базу данных ===</span></div>
<div class="line"><a id="l01510" name="l01510"></a><span class="lineno"> 1510</span>        $query = [</div>
<div class="line"><a id="l01511" name="l01511"></a><span class="lineno"> 1511</span>            <span class="stringliteral">&#39;login&#39;</span>     =&gt; $post_data[<span class="stringliteral">&#39;login&#39;</span>],</div>
<div class="line"><a id="l01512" name="l01512"></a><span class="lineno"> 1512</span>            <span class="stringliteral">&#39;password&#39;</span>  =&gt; password_hash($post_data[<span class="stringliteral">&#39;re_password&#39;</span>], PASSWORD_BCRYPT),</div>
<div class="line"><a id="l01513" name="l01513"></a><span class="lineno"> 1513</span>            <span class="stringliteral">&#39;email&#39;</span>     =&gt; $post_data[<span class="stringliteral">&#39;email&#39;</span>],</div>
<div class="line"><a id="l01514" name="l01514"></a><span class="lineno"> 1514</span>            <span class="stringliteral">&#39;real_name&#39;</span> =&gt; $post_data[<span class="stringliteral">&#39;real_name&#39;</span>],</div>
<div class="line"><a id="l01515" name="l01515"></a><span class="lineno"> 1515</span>            <span class="stringliteral">&#39;group_id&#39;</span>  =&gt; DEFAULT_GROUP,</div>
<div class="line"><a id="l01516" name="l01516"></a><span class="lineno"> 1516</span>        ];</div>
<div class="line"><a id="l01517" name="l01517"></a><span class="lineno"> 1517</span> </div>
<div class="line"><a id="l01518" name="l01518"></a><span class="lineno"> 1518</span>        <span class="comment">// Получение данных группы по умолчанию</span></div>
<div class="line"><a id="l01519" name="l01519"></a><span class="lineno"> 1519</span>        $this-&gt;db-&gt;select(<span class="charliteral">&#39;*&#39;</span>, TBL_GROUP, [</div>
<div class="line"><a id="l01520" name="l01520"></a><span class="lineno"> 1520</span>            <span class="stringliteral">&#39;where&#39;</span>  =&gt; <span class="stringliteral">&#39;`id` = :group_id&#39;</span>,</div>
<div class="line"><a id="l01521" name="l01521"></a><span class="lineno"> 1521</span>            <span class="stringliteral">&#39;params&#39;</span> =&gt; [<span class="stringliteral">&#39;:group_id&#39;</span> =&gt; DEFAULT_GROUP],</div>
<div class="line"><a id="l01522" name="l01522"></a><span class="lineno"> 1522</span>        ]);</div>
<div class="line"><a id="l01523" name="l01523"></a><span class="lineno"> 1523</span>        $group_data = $this-&gt;db-&gt;result_row();</div>
<div class="line"><a id="l01524" name="l01524"></a><span class="lineno"> 1524</span> </div>
<div class="line"><a id="l01525" name="l01525"></a><span class="lineno"> 1525</span>        <span class="keywordflow">if</span> (!$group_data) {</div>
<div class="line"><a id="l01526" name="l01526"></a><span class="lineno"> 1526</span>            <span class="keywordflow">throw</span> <span class="keyword">new</span> RuntimeException(</div>
<div class="line"><a id="l01527" name="l01527"></a><span class="lineno"> 1527</span>                __FILE__ . <span class="charliteral">&#39;:&#39;</span> . __LINE__ . <span class="stringliteral">&#39; (&#39;</span> . (__METHOD__ ?: __FUNCTION__ ?: <span class="stringliteral">&#39;global&#39;</span>) . <span class="stringliteral">&#39;) | Не удалось получить данные группы по умолчанию&#39;</span></div>
<div class="line"><a id="l01528" name="l01528"></a><span class="lineno"> 1528</span>            );</div>
<div class="line"><a id="l01529" name="l01529"></a><span class="lineno"> 1529</span>        }</div>
<div class="line"><a id="l01530" name="l01530"></a><span class="lineno"> 1530</span> </div>
<div class="line"><a id="l01531" name="l01531"></a><span class="lineno"> 1531</span>        <span class="comment">// Добавляем данные группы в массив для вставки нового пользователя</span></div>
<div class="line"><a id="l01532" name="l01532"></a><span class="lineno"> 1532</span>        <span class="keywordflow">foreach</span> ($group_data as $key =&gt; $value) {</div>
<div class="line"><a id="l01533" name="l01533"></a><span class="lineno"> 1533</span>            <span class="keywordflow">if</span> ($key !== <span class="stringliteral">&#39;id&#39;</span> &amp;&amp; $key !== <span class="stringliteral">&#39;name&#39;</span>) {</div>
<div class="line"><a id="l01534" name="l01534"></a><span class="lineno"> 1534</span>                $query[$key] = $value;</div>
<div class="line"><a id="l01535" name="l01535"></a><span class="lineno"> 1535</span>            }</div>
<div class="line"><a id="l01536" name="l01536"></a><span class="lineno"> 1536</span>        }</div>
<div class="line"><a id="l01537" name="l01537"></a><span class="lineno"> 1537</span> </div>
<div class="line"><a id="l01538" name="l01538"></a><span class="lineno"> 1538</span>        <span class="comment">// Формируем плоский массив плейсхолдеров и ассоциативный массив для вставки</span></div>
<div class="line"><a id="l01539" name="l01539"></a><span class="lineno"> 1539</span>        $insert_data = array_map(<span class="keyword">static</span> fn ($key) =&gt; <span class="stringliteral">&quot;`$key`&quot;</span>, array_keys($query)); <span class="comment">// Экранируем имена столбцов</span></div>
<div class="line"><a id="l01540" name="l01540"></a><span class="lineno"> 1540</span>        $placeholders = array_map(<span class="keyword">static</span> fn ($key) =&gt; <span class="stringliteral">&quot;:$key&quot;</span>, array_keys($query)); <span class="comment">// Формируем плейсхолдеры</span></div>
<div class="line"><a id="l01541" name="l01541"></a><span class="lineno"> 1541</span>        $params = array_combine(</div>
<div class="line"><a id="l01542" name="l01542"></a><span class="lineno"> 1542</span>            array_map(<span class="keyword">static</span> fn ($key) =&gt; <span class="stringliteral">&quot;:$key&quot;</span>, array_keys($query)), <span class="comment">// Добавляем префикс &#39;:&#39; к каждому ключу</span></div>
<div class="line"><a id="l01543" name="l01543"></a><span class="lineno"> 1543</span>            $query <span class="comment">// Значения остаются без изменений</span></div>
<div class="line"><a id="l01544" name="l01544"></a><span class="lineno"> 1544</span>        );</div>
<div class="line"><a id="l01545" name="l01545"></a><span class="lineno"> 1545</span> </div>
<div class="line"><a id="l01546" name="l01546"></a><span class="lineno"> 1546</span>        <span class="comment">// Вставка нового пользователя в базу данных</span></div>
<div class="line"><a id="l01547" name="l01547"></a><span class="lineno"> 1547</span>        $this-&gt;db-&gt;insert(</div>
<div class="line"><a id="l01548" name="l01548"></a><span class="lineno"> 1548</span>            array_combine($insert_data, $placeholders),</div>
<div class="line"><a id="l01549" name="l01549"></a><span class="lineno"> 1549</span>            <span class="comment">// Передаём ассоциативный массив (имена столбцов =&gt; плейсхолдеры)</span></div>
<div class="line"><a id="l01550" name="l01550"></a><span class="lineno"> 1550</span>            TBL_USERS,</div>
<div class="line"><a id="l01551" name="l01551"></a><span class="lineno"> 1551</span>            <span class="stringliteral">&#39;&#39;</span>,</div>
<div class="line"><a id="l01552" name="l01552"></a><span class="lineno"> 1552</span>            [<span class="stringliteral">&#39;params&#39;</span> =&gt; $params] <span class="comment">// Передаём преобразованный массив параметров</span></div>
<div class="line"><a id="l01553" name="l01553"></a><span class="lineno"> 1553</span>        );</div>
<div class="line"><a id="l01554" name="l01554"></a><span class="lineno"> 1554</span> </div>
<div class="line"><a id="l01555" name="l01555"></a><span class="lineno"> 1555</span>        <span class="comment">// === 5. Возвращаем результат ===</span></div>
<div class="line"><a id="l01556" name="l01556"></a><span class="lineno"> 1556</span>        <span class="keywordflow">return</span> $this-&gt;db-&gt;get_last_insert_id(); <span class="comment">// ID нового пользователя</span></div>
<div class="line"><a id="l01557" name="l01557"></a><span class="lineno"> 1557</span>    }</div>
</div>
<div class="line"><a id="l01558" name="l01558"></a><span class="lineno"> 1558</span></div>
<div class="foldopen" id="foldopen01603" data-start="{" data-end="}">
<div class="line"><a id="l01603" name="l01603"></a><span class="lineno"><a class="line" href="../../df/dfe/classPhotoRigma_1_1Classes_1_1User.html#ab19c821428e4402d7669bc3940afe6d7"> 1603</a></span>    <span class="keyword">public</span> <span class="keyword">function</span> <a class="code hl_function" href="../../df/dfe/classPhotoRigma_1_1Classes_1_1User.html#ab19c821428e4402d7669bc3940afe6d7">unset_property_key</a>(<span class="keywordtype">string</span> $name, <span class="keywordtype">string</span> $key): void</div>
<div class="line"><a id="l01604" name="l01604"></a><span class="lineno"> 1604</span>    {</div>
<div class="line"><a id="l01605" name="l01605"></a><span class="lineno"> 1605</span>        $this-&gt;<a class="code hl_function" href="../../df/dfe/classPhotoRigma_1_1Classes_1_1User.html#afaec38e538d6cb2625c21ac316cb7692">_unset_property_key_internal</a>($name, $key);</div>
<div class="line"><a id="l01606" name="l01606"></a><span class="lineno"> 1606</span>    }</div>
</div>
<div class="line"><a id="l01607" name="l01607"></a><span class="lineno"> 1607</span></div>
<div class="foldopen" id="foldopen01654" data-start="{" data-end="}">
<div class="line"><a id="l01654" name="l01654"></a><span class="lineno"><a class="line" href="../../df/dfe/classPhotoRigma_1_1Classes_1_1User.html#afaec38e538d6cb2625c21ac316cb7692"> 1654</a></span>    <span class="keyword">protected</span> <span class="keyword">function</span> <a class="code hl_function" href="../../df/dfe/classPhotoRigma_1_1Classes_1_1User.html#afaec38e538d6cb2625c21ac316cb7692">_unset_property_key_internal</a>(<span class="keywordtype">string</span> $name, <span class="keywordtype">string</span> $key): void</div>
<div class="line"><a id="l01655" name="l01655"></a><span class="lineno"> 1655</span>    {</div>
<div class="line"><a id="l01656" name="l01656"></a><span class="lineno"> 1656</span>        <span class="comment">// Проверяем, какой массив нужно изменить</span></div>
<div class="line"><a id="l01657" name="l01657"></a><span class="lineno"> 1657</span>        <span class="keywordflow">switch</span> ($name) {</div>
<div class="line"><a id="l01658" name="l01658"></a><span class="lineno"> 1658</span>            <span class="keywordflow">case</span> <span class="stringliteral">&#39;user&#39;</span>:</div>
<div class="line"><a id="l01659" name="l01659"></a><span class="lineno"> 1659</span>                <span class="keywordflow">if</span> (isset($this-&gt;user[$key])) {</div>
<div class="line"><a id="l01660" name="l01660"></a><span class="lineno"> 1660</span>                    unset($this-&gt;user[$key]);</div>
<div class="line"><a id="l01661" name="l01661"></a><span class="lineno"> 1661</span>                }</div>
<div class="line"><a id="l01662" name="l01662"></a><span class="lineno"> 1662</span>                <span class="keywordflow">break</span>;</div>
<div class="line"><a id="l01663" name="l01663"></a><span class="lineno"> 1663</span> </div>
<div class="line"><a id="l01664" name="l01664"></a><span class="lineno"> 1664</span>            <span class="keywordflow">case</span> <span class="stringliteral">&#39;session&#39;</span>:</div>
<div class="line"><a id="l01665" name="l01665"></a><span class="lineno"> 1665</span>                <span class="keywordflow">if</span> (isset($this-&gt;session[$key])) {</div>
<div class="line"><a id="l01666" name="l01666"></a><span class="lineno"> 1666</span>                    unset($this-&gt;session[$key]);</div>
<div class="line"><a id="l01667" name="l01667"></a><span class="lineno"> 1667</span>                }</div>
<div class="line"><a id="l01668" name="l01668"></a><span class="lineno"> 1668</span>                <span class="keywordflow">break</span>;</div>
<div class="line"><a id="l01669" name="l01669"></a><span class="lineno"> 1669</span> </div>
<div class="line"><a id="l01670" name="l01670"></a><span class="lineno"> 1670</span>            <span class="keywordflow">default</span>:</div>
<div class="line"><a id="l01671" name="l01671"></a><span class="lineno"> 1671</span>                <span class="keywordflow">throw</span> <span class="keyword">new</span> InvalidArgumentException(</div>
<div class="line"><a id="l01672" name="l01672"></a><span class="lineno"> 1672</span>                    __FILE__ . <span class="charliteral">&#39;:&#39;</span> . __LINE__ . <span class="stringliteral">&#39; (&#39;</span> . (__METHOD__ ?: __FUNCTION__ ?: <span class="stringliteral">&#39;global&#39;</span>) . <span class="stringliteral">&#39;) | &#39;</span> . <span class="stringliteral">&quot;Недопустимое свойство | Свойство: $name&quot;</span></div>
<div class="line"><a id="l01673" name="l01673"></a><span class="lineno"> 1673</span>                );</div>
<div class="line"><a id="l01674" name="l01674"></a><span class="lineno"> 1674</span>        }</div>
<div class="line"><a id="l01675" name="l01675"></a><span class="lineno"> 1675</span>    }</div>
</div>
<div class="line"><a id="l01676" name="l01676"></a><span class="lineno"> 1676</span></div>
<div class="foldopen" id="foldopen01706" data-start="{" data-end="}">
<div class="line"><a id="l01706" name="l01706"></a><span class="lineno"><a class="line" href="../../df/dfe/classPhotoRigma_1_1Classes_1_1User.html#ae5e5917c41be4155a54de5e90827dc57"> 1706</a></span>    <span class="keyword">public</span> <span class="keyword">function</span> <a class="code hl_function" href="../../df/dfe/classPhotoRigma_1_1Classes_1_1User.html#ae5e5917c41be4155a54de5e90827dc57">csrf_token</a>(): string</div>
<div class="line"><a id="l01707" name="l01707"></a><span class="lineno"> 1707</span>    {</div>
<div class="line"><a id="l01708" name="l01708"></a><span class="lineno"> 1708</span>        <span class="keywordflow">return</span> $this-&gt;<a class="code hl_function" href="../../df/dfe/classPhotoRigma_1_1Classes_1_1User.html#a28425e4464b81751a589fb6bdd1c19f1">_csrf_token_internal</a>();</div>
<div class="line"><a id="l01709" name="l01709"></a><span class="lineno"> 1709</span>    }</div>
</div>
<div class="line"><a id="l01710" name="l01710"></a><span class="lineno"> 1710</span></div>
<div class="foldopen" id="foldopen01745" data-start="{" data-end="}">
<div class="line"><a id="l01745" name="l01745"></a><span class="lineno"><a class="line" href="../../df/dfe/classPhotoRigma_1_1Classes_1_1User.html#a28425e4464b81751a589fb6bdd1c19f1"> 1745</a></span>    <span class="keyword">protected</span> <span class="keyword">function</span> <a class="code hl_function" href="../../df/dfe/classPhotoRigma_1_1Classes_1_1User.html#a28425e4464b81751a589fb6bdd1c19f1">_csrf_token_internal</a>(): string</div>
<div class="line"><a id="l01746" name="l01746"></a><span class="lineno"> 1746</span>    {</div>
<div class="line"><a id="l01747" name="l01747"></a><span class="lineno"> 1747</span>        <span class="keywordflow">if</span> (empty($this-&gt;session[<span class="stringliteral">&#39;csrf_token&#39;</span>])) {</div>
<div class="line"><a id="l01748" name="l01748"></a><span class="lineno"> 1748</span>            $this-&gt;session[<span class="stringliteral">&#39;csrf_token&#39;</span>] = bin2hex(random_bytes(32)); <span class="comment">// 64 символа</span></div>
<div class="line"><a id="l01749" name="l01749"></a><span class="lineno"> 1749</span>        }</div>
<div class="line"><a id="l01750" name="l01750"></a><span class="lineno"> 1750</span>        <span class="keywordflow">return</span> $this-&gt;session[<span class="stringliteral">&#39;csrf_token&#39;</span>];</div>
<div class="line"><a id="l01751" name="l01751"></a><span class="lineno"> 1751</span>    }</div>
</div>
<div class="line"><a id="l01752" name="l01752"></a><span class="lineno"> 1752</span></div>
<div class="foldopen" id="foldopen01792" data-start="{" data-end="}">
<div class="line"><a id="l01792" name="l01792"></a><span class="lineno"><a class="line" href="../../df/dfe/classPhotoRigma_1_1Classes_1_1User.html#a4045f753ad732e5f01bafd4b6c04d961"> 1792</a></span>    <span class="keyword">public</span> <span class="keyword">function</span> <a class="code hl_function" href="../../df/dfe/classPhotoRigma_1_1Classes_1_1User.html#a4045f753ad732e5f01bafd4b6c04d961">delete_group</a>(<span class="keywordtype">int</span> $group_id): bool</div>
<div class="line"><a id="l01793" name="l01793"></a><span class="lineno"> 1793</span>    {</div>
<div class="line"><a id="l01794" name="l01794"></a><span class="lineno"> 1794</span>        <span class="keywordflow">return</span> $this-&gt;<a class="code hl_function" href="../../df/dfe/classPhotoRigma_1_1Classes_1_1User.html#aab7ca272675fb69fed326d0094ec13e2">_delete_group_internal</a>($group_id);</div>
<div class="line"><a id="l01795" name="l01795"></a><span class="lineno"> 1795</span>    }</div>
</div>
<div class="line"><a id="l01796" name="l01796"></a><span class="lineno"> 1796</span></div>
<div class="foldopen" id="foldopen01842" data-start="{" data-end="}">
<div class="line"><a id="l01842" name="l01842"></a><span class="lineno"><a class="line" href="../../df/dfe/classPhotoRigma_1_1Classes_1_1User.html#aab7ca272675fb69fed326d0094ec13e2"> 1842</a></span>    <span class="keyword">protected</span> <span class="keyword">function</span> <a class="code hl_function" href="../../df/dfe/classPhotoRigma_1_1Classes_1_1User.html#aab7ca272675fb69fed326d0094ec13e2">_delete_group_internal</a>(<span class="keywordtype">int</span> $group_id): bool</div>
<div class="line"><a id="l01843" name="l01843"></a><span class="lineno"> 1843</span>    {</div>
<div class="line"><a id="l01844" name="l01844"></a><span class="lineno"> 1844</span>        <span class="comment">// 1. Проверяем, защищена ли группа от удаления</span></div>
<div class="line"><a id="l01845" name="l01845"></a><span class="lineno"> 1845</span>        <span class="keywordflow">if</span> (in_array($group_id, PROTECTED_GROUPS, <span class="keyword">true</span>)) {</div>
<div class="line"><a id="l01846" name="l01846"></a><span class="lineno"> 1846</span>            log_in_file(</div>
<div class="line"><a id="l01847" name="l01847"></a><span class="lineno"> 1847</span>                __FILE__ . <span class="charliteral">&#39;:&#39;</span> . __LINE__ . <span class="stringliteral">&#39; (&#39;</span> . (__METHOD__ ?: __FUNCTION__ ?: <span class="stringliteral">&#39;global&#39;</span>) . <span class="stringliteral">&#39;) | &#39;</span> .</div>
<div class="line"><a id="l01848" name="l01848"></a><span class="lineno"> 1848</span>                <span class="stringliteral">&quot;Невозможно удалить защищенную группу | ID: $group_id&quot;</span></div>
<div class="line"><a id="l01849" name="l01849"></a><span class="lineno"> 1849</span>            );</div>
<div class="line"><a id="l01850" name="l01850"></a><span class="lineno"> 1850</span>            <span class="keywordflow">return</span> <span class="keyword">false</span>;</div>
<div class="line"><a id="l01851" name="l01851"></a><span class="lineno"> 1851</span>        }</div>
<div class="line"><a id="l01852" name="l01852"></a><span class="lineno"> 1852</span> </div>
<div class="line"><a id="l01853" name="l01853"></a><span class="lineno"> 1853</span>        <span class="comment">// 2. Переводим всех пользователей группы на DEFAULT_GROUP</span></div>
<div class="line"><a id="l01854" name="l01854"></a><span class="lineno"> 1854</span>        $this-&gt;db-&gt;update(</div>
<div class="line"><a id="l01855" name="l01855"></a><span class="lineno"> 1855</span>            [<span class="stringliteral">&#39;`group_id`&#39;</span> =&gt; <span class="stringliteral">&#39;:new_group_id&#39;</span>],</div>
<div class="line"><a id="l01856" name="l01856"></a><span class="lineno"> 1856</span>            TBL_USERS,</div>
<div class="line"><a id="l01857" name="l01857"></a><span class="lineno"> 1857</span>            [</div>
<div class="line"><a id="l01858" name="l01858"></a><span class="lineno"> 1858</span>                <span class="stringliteral">&#39;where&#39;</span> =&gt; <span class="stringliteral">&#39;`group_id` = :old_group_id&#39;</span>,</div>
<div class="line"><a id="l01859" name="l01859"></a><span class="lineno"> 1859</span>                <span class="stringliteral">&#39;params&#39;</span> =&gt; [</div>
<div class="line"><a id="l01860" name="l01860"></a><span class="lineno"> 1860</span>                    <span class="stringliteral">&#39;:new_group_id&#39;</span> =&gt; DEFAULT_GROUP,</div>
<div class="line"><a id="l01861" name="l01861"></a><span class="lineno"> 1861</span>                    <span class="stringliteral">&#39;:old_group_id&#39;</span> =&gt; $group_id</div>
<div class="line"><a id="l01862" name="l01862"></a><span class="lineno"> 1862</span>                ]</div>
<div class="line"><a id="l01863" name="l01863"></a><span class="lineno"> 1863</span>            ]</div>
<div class="line"><a id="l01864" name="l01864"></a><span class="lineno"> 1864</span>        );</div>
<div class="line"><a id="l01865" name="l01865"></a><span class="lineno"> 1865</span> </div>
<div class="line"><a id="l01866" name="l01866"></a><span class="lineno"> 1866</span>        <span class="comment">// 3. Удаляем саму группу</span></div>
<div class="line"><a id="l01867" name="l01867"></a><span class="lineno"> 1867</span>        $this-&gt;db-&gt;delete(TBL_GROUP, [</div>
<div class="line"><a id="l01868" name="l01868"></a><span class="lineno"> 1868</span>            <span class="stringliteral">&#39;where&#39;</span> =&gt; <span class="stringliteral">&#39;`id` = :group_id&#39;</span>,</div>
<div class="line"><a id="l01869" name="l01869"></a><span class="lineno"> 1869</span>            <span class="stringliteral">&#39;params&#39;</span> =&gt; [<span class="stringliteral">&#39;:group_id&#39;</span> =&gt; $group_id]</div>
<div class="line"><a id="l01870" name="l01870"></a><span class="lineno"> 1870</span>        ]);</div>
<div class="line"><a id="l01871" name="l01871"></a><span class="lineno"> 1871</span> </div>
<div class="line"><a id="l01872" name="l01872"></a><span class="lineno"> 1872</span>        <span class="comment">// 4. Возвращаем результат</span></div>
<div class="line"><a id="l01873" name="l01873"></a><span class="lineno"> 1873</span>        <span class="keywordflow">return</span> (<span class="keywordtype">bool</span>)$this-&gt;db-&gt;get_affected_rows();</div>
<div class="line"><a id="l01874" name="l01874"></a><span class="lineno"> 1874</span>    }</div>
</div>
<div class="line"><a id="l01875" name="l01875"></a><span class="lineno"> 1875</span></div>
<div class="foldopen" id="foldopen01919" data-start="{" data-end="}">
<div class="line"><a id="l01919" name="l01919"></a><span class="lineno"><a class="line" href="../../df/dfe/classPhotoRigma_1_1Classes_1_1User.html#ab2c4aecffb50ad3f568cc504c6aea0c3"> 1919</a></span>    <span class="keyword">public</span> <span class="keyword">function</span> <a class="code hl_function" href="../../df/dfe/classPhotoRigma_1_1Classes_1_1User.html#ab2c4aecffb50ad3f568cc504c6aea0c3">delete_user</a>(<span class="keywordtype">int</span> $user_id, <span class="keywordtype">bool</span> $permanent = <span class="keyword">false</span>): bool</div>
<div class="line"><a id="l01920" name="l01920"></a><span class="lineno"> 1920</span>    {</div>
<div class="line"><a id="l01921" name="l01921"></a><span class="lineno"> 1921</span>        <span class="keywordflow">return</span> $this-&gt;<a class="code hl_function" href="../../df/dfe/classPhotoRigma_1_1Classes_1_1User.html#ae687233b186e739de3c8987820209b66">_delete_user_internal</a>($user_id, $permanent);</div>
<div class="line"><a id="l01922" name="l01922"></a><span class="lineno"> 1922</span>    }</div>
</div>
<div class="line"><a id="l01923" name="l01923"></a><span class="lineno"> 1923</span></div>
<div class="foldopen" id="foldopen01992" data-start="{" data-end="}">
<div class="line"><a id="l01992" name="l01992"></a><span class="lineno"><a class="line" href="../../df/dfe/classPhotoRigma_1_1Classes_1_1User.html#ae687233b186e739de3c8987820209b66"> 1992</a></span>    <span class="keyword">protected</span> <span class="keyword">function</span> <a class="code hl_function" href="../../df/dfe/classPhotoRigma_1_1Classes_1_1User.html#ae687233b186e739de3c8987820209b66">_delete_user_internal</a>(<span class="keywordtype">int</span> $user_id, <span class="keywordtype">bool</span> $permanent = <span class="keyword">false</span>): bool</div>
<div class="line"><a id="l01993" name="l01993"></a><span class="lineno"> 1993</span>    {</div>
<div class="line"><a id="l01994" name="l01994"></a><span class="lineno"> 1994</span>        <span class="comment">// 1. Получаем данные пользователя</span></div>
<div class="line"><a id="l01995" name="l01995"></a><span class="lineno"> 1995</span>        $this-&gt;db-&gt;select(</div>
<div class="line"><a id="l01996" name="l01996"></a><span class="lineno"> 1996</span>            [<span class="stringliteral">&#39;`id`&#39;</span>, <span class="stringliteral">&#39;`group_id`&#39;</span>, <span class="stringliteral">&#39;`deleted_at`&#39;</span>, <span class="stringliteral">&#39;`permanently_deleted`&#39;</span>],</div>
<div class="line"><a id="l01997" name="l01997"></a><span class="lineno"> 1997</span>            TBL_USERS,</div>
<div class="line"><a id="l01998" name="l01998"></a><span class="lineno"> 1998</span>            [<span class="stringliteral">&#39;where&#39;</span> =&gt; <span class="stringliteral">&#39;`id` = :id&#39;</span>, <span class="stringliteral">&#39;params&#39;</span> =&gt; [<span class="stringliteral">&#39;:id&#39;</span> =&gt; $user_id]]</div>
<div class="line"><a id="l01999" name="l01999"></a><span class="lineno"> 1999</span>        );</div>
<div class="line"><a id="l02000" name="l02000"></a><span class="lineno"> 2000</span>        $user_data = $this-&gt;db-&gt;result_row();</div>
<div class="line"><a id="l02001" name="l02001"></a><span class="lineno"> 2001</span> </div>
<div class="line"><a id="l02002" name="l02002"></a><span class="lineno"> 2002</span>        <span class="keywordflow">if</span> (!$user_data) {</div>
<div class="line"><a id="l02003" name="l02003"></a><span class="lineno"> 2003</span>            log_in_file(</div>
<div class="line"><a id="l02004" name="l02004"></a><span class="lineno"> 2004</span>                __FILE__ . <span class="charliteral">&#39;:&#39;</span> . __LINE__ . <span class="stringliteral">&#39; (&#39;</span> . (__METHOD__ ?: __FUNCTION__ ?: <span class="stringliteral">&#39;global&#39;</span>) . <span class="stringliteral">&quot;) | Пользователь с ID $user_id не найден&quot;</span></div>
<div class="line"><a id="l02005" name="l02005"></a><span class="lineno"> 2005</span>            );</div>
<div class="line"><a id="l02006" name="l02006"></a><span class="lineno"> 2006</span>            <span class="keywordflow">return</span> <span class="keyword">false</span>;</div>
<div class="line"><a id="l02007" name="l02007"></a><span class="lineno"> 2007</span>        }</div>
<div class="line"><a id="l02008" name="l02008"></a><span class="lineno"> 2008</span> </div>
<div class="line"><a id="l02009" name="l02009"></a><span class="lineno"> 2009</span>        <span class="comment">// 2. Проверяем, не удаляем ли мы самого себя</span></div>
<div class="line"><a id="l02010" name="l02010"></a><span class="lineno"> 2010</span>        <span class="keywordflow">if</span> ((<span class="keywordtype">int</span>)$user_data[<span class="stringliteral">&#39;id&#39;</span>] === $this-&gt;session[<span class="stringliteral">&#39;login_id&#39;</span>] &amp;&amp; (<span class="keywordtype">int</span>)$user_data[<span class="stringliteral">&#39;group_id&#39;</span>] === GROUP_ADMIN) {</div>
<div class="line"><a id="l02011" name="l02011"></a><span class="lineno"> 2011</span>            log_in_file(</div>
<div class="line"><a id="l02012" name="l02012"></a><span class="lineno"> 2012</span>                __FILE__ . <span class="charliteral">&#39;:&#39;</span> . __LINE__ . <span class="stringliteral">&#39; (&#39;</span> . (__METHOD__ ?: __FUNCTION__ ?: <span class="stringliteral">&#39;global&#39;</span>) . <span class="stringliteral">&quot;) | Администратор не может удалить сам себя | ID: $user_id&quot;</span></div>
<div class="line"><a id="l02013" name="l02013"></a><span class="lineno"> 2013</span>            );</div>
<div class="line"><a id="l02014" name="l02014"></a><span class="lineno"> 2014</span>            <span class="keywordflow">return</span> <span class="keyword">false</span>;</div>
<div class="line"><a id="l02015" name="l02015"></a><span class="lineno"> 2015</span>        }</div>
<div class="line"><a id="l02016" name="l02016"></a><span class="lineno"> 2016</span> </div>
<div class="line"><a id="l02017" name="l02017"></a><span class="lineno"> 2017</span>        <span class="comment">// 3. Проверяем права на окончательное удаление</span></div>
<div class="line"><a id="l02018" name="l02018"></a><span class="lineno"> 2018</span>        <span class="keywordflow">if</span> ($permanent) {</div>
<div class="line"><a id="l02019" name="l02019"></a><span class="lineno"> 2019</span>            <span class="comment">// Только админ с подтверждённой сессией может окончательно удалить</span></div>
<div class="line"><a id="l02020" name="l02020"></a><span class="lineno"> 2020</span>            <span class="keywordflow">if</span> (</div>
<div class="line"><a id="l02021" name="l02021"></a><span class="lineno"> 2021</span>                !$this-&gt;user[<span class="stringliteral">&#39;admin&#39;</span>] ||</div>
<div class="line"><a id="l02022" name="l02022"></a><span class="lineno"> 2022</span>                !$this-&gt;session[<span class="stringliteral">&#39;admin_on&#39;</span>]</div>
<div class="line"><a id="l02023" name="l02023"></a><span class="lineno"> 2023</span>            ) {</div>
<div class="line"><a id="l02024" name="l02024"></a><span class="lineno"> 2024</span>                log_in_file(</div>
<div class="line"><a id="l02025" name="l02025"></a><span class="lineno"> 2025</span>                    __FILE__ . <span class="charliteral">&#39;:&#39;</span> . __LINE__ . <span class="stringliteral">&#39; (&#39;</span> . (__METHOD__ ?: __FUNCTION__ ?: <span class="stringliteral">&#39;global&#39;</span>) . <span class="stringliteral">&quot;) | Только админ с подтвержденной сессией может окончательно удалить | ID: $user_id&quot;</span></div>
<div class="line"><a id="l02026" name="l02026"></a><span class="lineno"> 2026</span>                );</div>
<div class="line"><a id="l02027" name="l02027"></a><span class="lineno"> 2027</span>                <span class="keywordflow">return</span> <span class="keyword">false</span>;</div>
<div class="line"><a id="l02028" name="l02028"></a><span class="lineno"> 2028</span>            }</div>
<div class="line"><a id="l02029" name="l02029"></a><span class="lineno"> 2029</span> </div>
<div class="line"><a id="l02030" name="l02030"></a><span class="lineno"> 2030</span>            <span class="comment">// Проверяем, не последний ли это админ</span></div>
<div class="line"><a id="l02031" name="l02031"></a><span class="lineno"> 2031</span>            $this-&gt;db-&gt;select(<span class="stringliteral">&#39;COUNT(*) AS cnt&#39;</span>, TBL_USERS, [</div>
<div class="line"><a id="l02032" name="l02032"></a><span class="lineno"> 2032</span>                <span class="stringliteral">&#39;where&#39;</span> =&gt; <span class="stringliteral">&#39;`group_id` = :group AND `id` != :exclude_id AND `permanently_deleted` = 0&#39;</span>,</div>
<div class="line"><a id="l02033" name="l02033"></a><span class="lineno"> 2033</span>                <span class="stringliteral">&#39;params&#39;</span> =&gt; [</div>
<div class="line"><a id="l02034" name="l02034"></a><span class="lineno"> 2034</span>                    <span class="stringliteral">&#39;:group&#39;</span> =&gt; GROUP_ADMIN,</div>
<div class="line"><a id="l02035" name="l02035"></a><span class="lineno"> 2035</span>                    <span class="stringliteral">&#39;:exclude_id&#39;</span> =&gt; $user_id,</div>
<div class="line"><a id="l02036" name="l02036"></a><span class="lineno"> 2036</span>                ],</div>
<div class="line"><a id="l02037" name="l02037"></a><span class="lineno"> 2037</span>            ]);</div>
<div class="line"><a id="l02038" name="l02038"></a><span class="lineno"> 2038</span>            $count_result = $this-&gt;db-&gt;result_row();</div>
<div class="line"><a id="l02039" name="l02039"></a><span class="lineno"> 2039</span>            $admin_count = (int)$count_result[<span class="stringliteral">&#39;cnt&#39;</span>];</div>
<div class="line"><a id="l02040" name="l02040"></a><span class="lineno"> 2040</span> </div>
<div class="line"><a id="l02041" name="l02041"></a><span class="lineno"> 2041</span>            <span class="keywordflow">if</span> ($admin_count &lt;= 0) {</div>
<div class="line"><a id="l02042" name="l02042"></a><span class="lineno"> 2042</span>                log_in_file(</div>
<div class="line"><a id="l02043" name="l02043"></a><span class="lineno"> 2043</span>                    __FILE__ . <span class="charliteral">&#39;:&#39;</span> . __LINE__ . <span class="stringliteral">&#39; (&#39;</span> . (__METHOD__ ?: __FUNCTION__ ?: <span class="stringliteral">&#39;global&#39;</span>) . <span class="stringliteral">&quot;) | Невозможно удалить последнего админа | ID: $user_id&quot;</span></div>
<div class="line"><a id="l02044" name="l02044"></a><span class="lineno"> 2044</span>                );</div>
<div class="line"><a id="l02045" name="l02045"></a><span class="lineno"> 2045</span>                <span class="keywordflow">return</span> <span class="keyword">false</span>;</div>
<div class="line"><a id="l02046" name="l02046"></a><span class="lineno"> 2046</span>            }</div>
<div class="line"><a id="l02047" name="l02047"></a><span class="lineno"> 2047</span> </div>
<div class="line"><a id="l02048" name="l02048"></a><span class="lineno"> 2048</span>            <span class="comment">// Вызываем окончательное удаление с флагом force = true</span></div>
<div class="line"><a id="l02049" name="l02049"></a><span class="lineno"> 2049</span>            <span class="keywordflow">return</span> $this-&gt;<a class="code hl_function" href="../../df/dfe/classPhotoRigma_1_1Classes_1_1User.html#ac4c1020c1604de75d27c31dbe77e2fb7">_hard_delete_user_internal</a>($user_id, <span class="keyword">true</span>);</div>
<div class="line"><a id="l02050" name="l02050"></a><span class="lineno"> 2050</span>        }</div>
<div class="line"><a id="l02051" name="l02051"></a><span class="lineno"> 2051</span> </div>
<div class="line"><a id="l02052" name="l02052"></a><span class="lineno"> 2052</span>        <span class="comment">// 4. Выполняем мягкое удаление</span></div>
<div class="line"><a id="l02053" name="l02053"></a><span class="lineno"> 2053</span>        <span class="keywordflow">return</span> $this-&gt;<a class="code hl_function" href="../../df/dfe/classPhotoRigma_1_1Classes_1_1User.html#a9a102a9a5c4c289295b12acbac2f5302">_soft_delete</a>($user_id);</div>
<div class="line"><a id="l02054" name="l02054"></a><span class="lineno"> 2054</span>    }</div>
</div>
<div class="line"><a id="l02055" name="l02055"></a><span class="lineno"> 2055</span></div>
<div class="foldopen" id="foldopen02117" data-start="{" data-end="}">
<div class="line"><a id="l02117" name="l02117"></a><span class="lineno"><a class="line" href="../../df/dfe/classPhotoRigma_1_1Classes_1_1User.html#a8432fa6f08d4982b9c9d9aaede7de566"> 2117</a></span>    <span class="keyword">public</span> <span class="keyword">function</span> <a class="code hl_function" href="../../df/dfe/classPhotoRigma_1_1Classes_1_1User.html#a8432fa6f08d4982b9c9d9aaede7de566">update_group_data</a>(array $group_data, array $post_data): array</div>
<div class="line"><a id="l02118" name="l02118"></a><span class="lineno"> 2118</span>    {</div>
<div class="line"><a id="l02119" name="l02119"></a><span class="lineno"> 2119</span>        <span class="keywordflow">return</span> $this-&gt;<a class="code hl_function" href="../../df/dfe/classPhotoRigma_1_1Classes_1_1User.html#a846904b254f7b59e420e58a68604dc77">_update_group_data_internal</a>($group_data, $post_data);</div>
<div class="line"><a id="l02120" name="l02120"></a><span class="lineno"> 2120</span>    }</div>
</div>
<div class="line"><a id="l02121" name="l02121"></a><span class="lineno"> 2121</span></div>
<div class="foldopen" id="foldopen02200" data-start="{" data-end="}">
<div class="line"><a id="l02200" name="l02200"></a><span class="lineno"><a class="line" href="../../df/dfe/classPhotoRigma_1_1Classes_1_1User.html#a846904b254f7b59e420e58a68604dc77"> 2200</a></span>    <span class="keyword">protected</span> <span class="keyword">function</span> <a class="code hl_function" href="../../df/dfe/classPhotoRigma_1_1Classes_1_1User.html#a846904b254f7b59e420e58a68604dc77">_update_group_data_internal</a>(array $group_data, array $post_data): array</div>
<div class="line"><a id="l02201" name="l02201"></a><span class="lineno"> 2201</span>    {</div>
<div class="line"><a id="l02202" name="l02202"></a><span class="lineno"> 2202</span>        <span class="comment">// Обновляем название группы</span></div>
<div class="line"><a id="l02204" name="l02204"></a><span class="lineno"> 2204</span>        <span class="keywordflow">if</span> ($this-&gt;work-&gt;check_input(</div>
<div class="line"><a id="l02205" name="l02205"></a><span class="lineno"> 2205</span>            <span class="stringliteral">&#39;_POST&#39;</span>,</div>
<div class="line"><a id="l02206" name="l02206"></a><span class="lineno"> 2206</span>            <span class="stringliteral">&#39;name_group&#39;</span>,</div>
<div class="line"><a id="l02207" name="l02207"></a><span class="lineno"> 2207</span>            [<span class="stringliteral">&#39;isset&#39;</span> =&gt; <span class="keyword">true</span>, <span class="stringliteral">&#39;empty&#39;</span> =&gt; <span class="keyword">true</span>, <span class="stringliteral">&#39;regexp&#39;</span> =&gt; REG_NAME]</div>
<div class="line"><a id="l02208" name="l02208"></a><span class="lineno"> 2208</span>        ) &amp;&amp; $post_data[<span class="stringliteral">&#39;name_group&#39;</span>] !== $group_data[<span class="stringliteral">&#39;name&#39;</span>]) {</div>
<div class="line"><a id="l02209" name="l02209"></a><span class="lineno"> 2209</span>            $clean_name = <a class="code hl_function" href="../../d7/d53/classPhotoRigma_1_1Classes_1_1Work.html#a8ecb9d3a6cba675b7a2d72ddc14b53f3">Work::clean_field</a>($post_data[<span class="stringliteral">&#39;name_group&#39;</span>]); <span class="comment">// Очищаем название группы для безопасности</span></div>
<div class="line"><a id="l02210" name="l02210"></a><span class="lineno"> 2210</span>            $this-&gt;db-&gt;update(</div>
<div class="line"><a id="l02211" name="l02211"></a><span class="lineno"> 2211</span>                [<span class="stringliteral">&#39;name&#39;</span> =&gt; <span class="stringliteral">&#39;:name&#39;</span>], <span class="comment">// Обновляем поле name в таблице групп</span></div>
<div class="line"><a id="l02212" name="l02212"></a><span class="lineno"> 2212</span>                TBL_GROUP,</div>
<div class="line"><a id="l02213" name="l02213"></a><span class="lineno"> 2213</span>                [</div>
<div class="line"><a id="l02214" name="l02214"></a><span class="lineno"> 2214</span>                    <span class="stringliteral">&#39;where&#39;</span>  =&gt; <span class="stringliteral">&#39;`id` = :id_group&#39;</span>, <span class="comment">// Условие: группа с указанным ID</span></div>
<div class="line"><a id="l02215" name="l02215"></a><span class="lineno"> 2215</span>                    <span class="stringliteral">&#39;params&#39;</span> =&gt; [</div>
<div class="line"><a id="l02216" name="l02216"></a><span class="lineno"> 2216</span>                        <span class="stringliteral">&#39;:name&#39;</span>     =&gt; $clean_name, <span class="comment">// Новое название группы</span></div>
<div class="line"><a id="l02217" name="l02217"></a><span class="lineno"> 2217</span>                        <span class="stringliteral">&#39;:id_group&#39;</span> =&gt; $post_data[<span class="stringliteral">&#39;id_group&#39;</span>], <span class="comment">// ID группы</span></div>
<div class="line"><a id="l02218" name="l02218"></a><span class="lineno"> 2218</span>                    ],</div>
<div class="line"><a id="l02219" name="l02219"></a><span class="lineno"> 2219</span>                ]</div>
<div class="line"><a id="l02220" name="l02220"></a><span class="lineno"> 2220</span>            );</div>
<div class="line"><a id="l02221" name="l02221"></a><span class="lineno"> 2221</span>            $rows = $this-&gt;db-&gt;get_affected_rows(); <span class="comment">// Получаем количество измененных строк</span></div>
<div class="line"><a id="l02222" name="l02222"></a><span class="lineno"> 2222</span>            <span class="keywordflow">if</span> ($rows &gt; 0) {</div>
<div class="line"><a id="l02223" name="l02223"></a><span class="lineno"> 2223</span>                $group_data[<span class="stringliteral">&#39;name&#39;</span>] = $clean_name; <span class="comment">// Обновляем название группы в данных</span></div>
<div class="line"><a id="l02224" name="l02224"></a><span class="lineno"> 2224</span>            }</div>
<div class="line"><a id="l02225" name="l02225"></a><span class="lineno"> 2225</span>        }</div>
<div class="line"><a id="l02226" name="l02226"></a><span class="lineno"> 2226</span> </div>
<div class="line"><a id="l02227" name="l02227"></a><span class="lineno"> 2227</span>        $new_group_rights = [];</div>
<div class="line"><a id="l02228" name="l02228"></a><span class="lineno"> 2228</span> </div>
<div class="line"><a id="l02229" name="l02229"></a><span class="lineno"> 2229</span>        <span class="comment">// Обновляем права доступа группы</span></div>
<div class="line"><a id="l02230" name="l02230"></a><span class="lineno"> 2230</span>        <span class="keywordflow">foreach</span> ($this-&gt;user_right_fields[<span class="stringliteral">&#39;all&#39;</span>] as $value) {</div>
<div class="line"><a id="l02231" name="l02231"></a><span class="lineno"> 2231</span>            <span class="keywordflow">if</span> ($this-&gt;work-&gt;check_input(<span class="stringliteral">&#39;_POST&#39;</span>, $value, [<span class="stringliteral">&#39;isset&#39;</span> =&gt; <span class="keyword">true</span>, <span class="stringliteral">&#39;empty&#39;</span> =&gt; <span class="keyword">true</span>])) {</div>
<div class="line"><a id="l02232" name="l02232"></a><span class="lineno"> 2232</span>                <span class="comment">// Если поле существует и имеет допустимое значение, нормализуем его (true/false)</span></div>
<div class="line"><a id="l02233" name="l02233"></a><span class="lineno"> 2233</span>                $post_data[$value] = in_array($post_data[$value], [<span class="stringliteral">&#39;on&#39;</span>, 1, <span class="charliteral">&#39;1&#39;</span>, <span class="keyword">true</span>], <span class="keyword">true</span>);</div>
<div class="line"><a id="l02234" name="l02234"></a><span class="lineno"> 2234</span>            } <span class="keywordflow">else</span> {</div>
<div class="line"><a id="l02235" name="l02235"></a><span class="lineno"> 2235</span>                <span class="comment">// Если поле не передано, устанавливаем значение в false</span></div>
<div class="line"><a id="l02236" name="l02236"></a><span class="lineno"> 2236</span>                $post_data[$value] = <span class="keyword">false</span>;</div>
<div class="line"><a id="l02237" name="l02237"></a><span class="lineno"> 2237</span>            }</div>
<div class="line"><a id="l02238" name="l02238"></a><span class="lineno"> 2238</span>            $new_group_rights[$value] = $post_data[$value]; <span class="comment">// Сохраняем обновленное значение права</span></div>
<div class="line"><a id="l02239" name="l02239"></a><span class="lineno"> 2239</span>        }</div>
<div class="line"><a id="l02240" name="l02240"></a><span class="lineno"> 2240</span> </div>
<div class="line"><a id="l02241" name="l02241"></a><span class="lineno"> 2241</span>        <span class="comment">// Кодируем права доступа для сохранения в базе данных</span></div>
<div class="line"><a id="l02242" name="l02242"></a><span class="lineno"> 2242</span>        $encoded_group_rights = $this-&gt;<a class="code hl_function" href="../../df/dfe/classPhotoRigma_1_1Classes_1_1User.html#ab6a181342a4b7b3aac421c86eb537238">_encode_user_rights_internal</a>($new_group_rights);</div>
<div class="line"><a id="l02243" name="l02243"></a><span class="lineno"> 2243</span> </div>
<div class="line"><a id="l02244" name="l02244"></a><span class="lineno"> 2244</span>        <span class="comment">// Обновляем права доступа группы в базе данных</span></div>
<div class="line"><a id="l02245" name="l02245"></a><span class="lineno"> 2245</span>        $this-&gt;db-&gt;update(</div>
<div class="line"><a id="l02246" name="l02246"></a><span class="lineno"> 2246</span>            [<span class="stringliteral">&#39;`user_rights`&#39;</span> =&gt; <span class="stringliteral">&#39;:u_rights&#39;</span>], <span class="comment">// Обновляем поле user_rights</span></div>
<div class="line"><a id="l02247" name="l02247"></a><span class="lineno"> 2247</span>            TBL_GROUP,</div>
<div class="line"><a id="l02248" name="l02248"></a><span class="lineno"> 2248</span>            [</div>
<div class="line"><a id="l02249" name="l02249"></a><span class="lineno"> 2249</span>                <span class="stringliteral">&#39;where&#39;</span>  =&gt; <span class="stringliteral">&#39;`id` = :id_group&#39;</span>, <span class="comment">// Условие: группа с указанным ID</span></div>
<div class="line"><a id="l02250" name="l02250"></a><span class="lineno"> 2250</span>                <span class="stringliteral">&#39;params&#39;</span> =&gt; [</div>
<div class="line"><a id="l02251" name="l02251"></a><span class="lineno"> 2251</span>                    <span class="stringliteral">&#39;:u_rights&#39;</span> =&gt; $encoded_group_rights, <span class="comment">// Закодированные права доступа</span></div>
<div class="line"><a id="l02252" name="l02252"></a><span class="lineno"> 2252</span>                    <span class="stringliteral">&#39;:id_group&#39;</span> =&gt; $post_data[<span class="stringliteral">&#39;id_group&#39;</span>], <span class="comment">// ID группы</span></div>
<div class="line"><a id="l02253" name="l02253"></a><span class="lineno"> 2253</span>                ],</div>
<div class="line"><a id="l02254" name="l02254"></a><span class="lineno"> 2254</span>            ]</div>
<div class="line"><a id="l02255" name="l02255"></a><span class="lineno"> 2255</span>        );</div>
<div class="line"><a id="l02256" name="l02256"></a><span class="lineno"> 2256</span>        $rows = $this-&gt;db-&gt;get_affected_rows(); <span class="comment">// Получаем количество измененных строк</span></div>
<div class="line"><a id="l02257" name="l02257"></a><span class="lineno"> 2257</span>        <span class="keywordflow">if</span> ($rows &gt; 0) {</div>
<div class="line"><a id="l02258" name="l02258"></a><span class="lineno"> 2258</span>            <span class="comment">// Если данные успешно обновлены, обновляем права доступа в памяти</span></div>
<div class="line"><a id="l02259" name="l02259"></a><span class="lineno"> 2259</span>            $group_data = array_merge($group_data, $new_group_rights);</div>
<div class="line"><a id="l02260" name="l02260"></a><span class="lineno"> 2260</span>        } <span class="keywordflow">else</span> {</div>
<div class="line"><a id="l02261" name="l02261"></a><span class="lineno"> 2261</span>            <span class="comment">// Если данные не изменились, обрабатываем права доступа через process_user_rights</span></div>
<div class="line"><a id="l02262" name="l02262"></a><span class="lineno"> 2262</span>            $group_data = array_merge($group_data, $this-&gt;<a class="code hl_function" href="../../df/dfe/classPhotoRigma_1_1Classes_1_1User.html#ad202cf4189004edefa5403d1fad8c7f3">_process_user_rights_internal</a>($group_data[<span class="stringliteral">&#39;user_rights&#39;</span>]));</div>
<div class="line"><a id="l02263" name="l02263"></a><span class="lineno"> 2263</span>        }</div>
<div class="line"><a id="l02264" name="l02264"></a><span class="lineno"> 2264</span> </div>
<div class="line"><a id="l02265" name="l02265"></a><span class="lineno"> 2265</span>        <span class="comment">// Удаляем ключ user_rights из результирующего массива, если он существует</span></div>
<div class="line"><a id="l02266" name="l02266"></a><span class="lineno"> 2266</span>        <span class="keywordflow">if</span> (isset($group_data[<span class="stringliteral">&#39;user_rights&#39;</span>])) {</div>
<div class="line"><a id="l02267" name="l02267"></a><span class="lineno"> 2267</span>            unset($group_data[<span class="stringliteral">&#39;user_rights&#39;</span>]);</div>
<div class="line"><a id="l02268" name="l02268"></a><span class="lineno"> 2268</span>        }</div>
<div class="line"><a id="l02269" name="l02269"></a><span class="lineno"> 2269</span> </div>
<div class="line"><a id="l02270" name="l02270"></a><span class="lineno"> 2270</span>        <span class="keywordflow">return</span> $group_data; <span class="comment">// Возвращаем обновленные данные группы</span></div>
<div class="line"><a id="l02271" name="l02271"></a><span class="lineno"> 2271</span>    }</div>
</div>
<div class="line"><a id="l02272" name="l02272"></a><span class="lineno"> 2272</span></div>
<div class="foldopen" id="foldopen02319" data-start="{" data-end="}">
<div class="line"><a id="l02319" name="l02319"></a><span class="lineno"><a class="line" href="../../df/dfe/classPhotoRigma_1_1Classes_1_1User.html#a6ccf217fb8ddc2f985779f15cf32f078"> 2319</a></span>    <span class="keyword">public</span> <span class="keyword">function</span> <a class="code hl_function" href="../../df/dfe/classPhotoRigma_1_1Classes_1_1User.html#a6ccf217fb8ddc2f985779f15cf32f078">encode_user_rights</a>(array $rights): string</div>
<div class="line"><a id="l02320" name="l02320"></a><span class="lineno"> 2320</span>    {</div>
<div class="line"><a id="l02321" name="l02321"></a><span class="lineno"> 2321</span>        <span class="keywordflow">return</span> $this-&gt;<a class="code hl_function" href="../../df/dfe/classPhotoRigma_1_1Classes_1_1User.html#ab6a181342a4b7b3aac421c86eb537238">_encode_user_rights_internal</a>($rights);</div>
<div class="line"><a id="l02322" name="l02322"></a><span class="lineno"> 2322</span>    }</div>
</div>
<div class="line"><a id="l02323" name="l02323"></a><span class="lineno"> 2323</span></div>
<div class="foldopen" id="foldopen02375" data-start="{" data-end="}">
<div class="line"><a id="l02375" name="l02375"></a><span class="lineno"><a class="line" href="../../df/dfe/classPhotoRigma_1_1Classes_1_1User.html#ab6a181342a4b7b3aac421c86eb537238"> 2375</a></span>    <span class="keyword">protected</span> <span class="keyword">function</span> <a class="code hl_function" href="../../df/dfe/classPhotoRigma_1_1Classes_1_1User.html#ab6a181342a4b7b3aac421c86eb537238">_encode_user_rights_internal</a>(array $rights): string</div>
<div class="line"><a id="l02376" name="l02376"></a><span class="lineno"> 2376</span>    {</div>
<div class="line"><a id="l02377" name="l02377"></a><span class="lineno"> 2377</span>        <span class="comment">// Проверяем, существует ли массив прав</span></div>
<div class="line"><a id="l02378" name="l02378"></a><span class="lineno"> 2378</span>        <span class="keywordflow">if</span> (!isset($rights)) {</div>
<div class="line"><a id="l02379" name="l02379"></a><span class="lineno"> 2379</span>            <span class="keywordflow">return</span> <span class="stringliteral">&#39;&#39;</span>;</div>
<div class="line"><a id="l02380" name="l02380"></a><span class="lineno"> 2380</span>        }</div>
<div class="line"><a id="l02381" name="l02381"></a><span class="lineno"> 2381</span> </div>
<div class="line"><a id="l02382" name="l02382"></a><span class="lineno"> 2382</span>        <span class="comment">// Кодируем массив в JSON</span></div>
<div class="line"><a id="l02383" name="l02383"></a><span class="lineno"> 2383</span>        $json = json_encode($rights, JSON_THROW_ON_ERROR | JSON_UNESCAPED_UNICODE | JSON_UNESCAPED_SLASHES);</div>
<div class="line"><a id="l02384" name="l02384"></a><span class="lineno"> 2384</span> </div>
<div class="line"><a id="l02385" name="l02385"></a><span class="lineno"> 2385</span>        <span class="comment">// Проверяем наличие ошибок при кодировании</span></div>
<div class="line"><a id="l02386" name="l02386"></a><span class="lineno"> 2386</span>        <span class="keywordflow">if</span> (json_last_error() !== JSON_ERROR_NONE) {</div>
<div class="line"><a id="l02387" name="l02387"></a><span class="lineno"> 2387</span>            <span class="keywordflow">throw</span> <span class="keyword">new</span> InvalidArgumentException(</div>
<div class="line"><a id="l02388" name="l02388"></a><span class="lineno"> 2388</span>                __FILE__ . <span class="charliteral">&#39;:&#39;</span> . __LINE__ . <span class="stringliteral">&#39; (&#39;</span> . (__METHOD__ ?: __FUNCTION__ ?: <span class="stringliteral">&#39;global&#39;</span>) . <span class="stringliteral">&#39;) | Ошибка кодирования JSON | &#39;</span> . json_last_error_msg(</div>
<div class="line"><a id="l02389" name="l02389"></a><span class="lineno"> 2389</span>                )</div>
<div class="line"><a id="l02390" name="l02390"></a><span class="lineno"> 2390</span>            );</div>
<div class="line"><a id="l02391" name="l02391"></a><span class="lineno"> 2391</span>        }</div>
<div class="line"><a id="l02392" name="l02392"></a><span class="lineno"> 2392</span> </div>
<div class="line"><a id="l02393" name="l02393"></a><span class="lineno"> 2393</span>        <span class="comment">// Возвращаем строку JSON</span></div>
<div class="line"><a id="l02394" name="l02394"></a><span class="lineno"> 2394</span>        <span class="keywordflow">return</span> is_string($json) ? $json : <span class="stringliteral">&#39;&#39;</span>;</div>
<div class="line"><a id="l02395" name="l02395"></a><span class="lineno"> 2395</span>    }</div>
</div>
<div class="line"><a id="l02396" name="l02396"></a><span class="lineno"> 2396</span></div>
<div class="foldopen" id="foldopen02459" data-start="{" data-end="}">
<div class="line"><a id="l02459" name="l02459"></a><span class="lineno"><a class="line" href="../../df/dfe/classPhotoRigma_1_1Classes_1_1User.html#a9f839b5040591e4ea416cfc8f2ec8f44"> 2459</a></span>    <span class="keyword">public</span> <span class="keyword">function</span> <a class="code hl_function" href="../../df/dfe/classPhotoRigma_1_1Classes_1_1User.html#a9f839b5040591e4ea416cfc8f2ec8f44">login_user</a>(array $post, <span class="keywordtype">string</span> $redirect_url): int</div>
<div class="line"><a id="l02460" name="l02460"></a><span class="lineno"> 2460</span>    {</div>
<div class="line"><a id="l02461" name="l02461"></a><span class="lineno"> 2461</span>        <span class="keywordflow">return</span> $this-&gt;<a class="code hl_function" href="../../df/dfe/classPhotoRigma_1_1Classes_1_1User.html#a6faeda51357eb02f3ea21011d8db4262">_login_user_internal</a>($post, $redirect_url);</div>
<div class="line"><a id="l02462" name="l02462"></a><span class="lineno"> 2462</span>    }</div>
</div>
<div class="line"><a id="l02463" name="l02463"></a><span class="lineno"> 2463</span></div>
<div class="foldopen" id="foldopen02546" data-start="{" data-end="}">
<div class="line"><a id="l02546" name="l02546"></a><span class="lineno"><a class="line" href="../../df/dfe/classPhotoRigma_1_1Classes_1_1User.html#a6faeda51357eb02f3ea21011d8db4262"> 2546</a></span>    <span class="keyword">protected</span> <span class="keyword">function</span> <a class="code hl_function" href="../../df/dfe/classPhotoRigma_1_1Classes_1_1User.html#a6faeda51357eb02f3ea21011d8db4262">_login_user_internal</a>(array $post, <span class="keywordtype">string</span> $redirect_url): int</div>
<div class="line"><a id="l02547" name="l02547"></a><span class="lineno"> 2547</span>    {</div>
<div class="line"><a id="l02548" name="l02548"></a><span class="lineno"> 2548</span>        <span class="comment">// === 1. Проверка входных данных (логин и пароль) ===</span></div>
<div class="line"><a id="l02549" name="l02549"></a><span class="lineno"> 2549</span>        <span class="keywordflow">if</span> (!$this-&gt;work-&gt;check_input(<span class="stringliteral">&#39;_POST&#39;</span>, <span class="stringliteral">&#39;login&#39;</span>, [</div>
<div class="line"><a id="l02550" name="l02550"></a><span class="lineno"> 2550</span>                <span class="stringliteral">&#39;isset&#39;</span>  =&gt; <span class="keyword">true</span>,</div>
<div class="line"><a id="l02551" name="l02551"></a><span class="lineno"> 2551</span>                <span class="stringliteral">&#39;empty&#39;</span>  =&gt; <span class="keyword">true</span>,</div>
<div class="line"><a id="l02552" name="l02552"></a><span class="lineno"> 2552</span>                <span class="stringliteral">&#39;regexp&#39;</span> =&gt; REG_LOGIN,</div>
<div class="line"><a id="l02553" name="l02553"></a><span class="lineno"> 2553</span>            ]) || !$this-&gt;work-&gt;check_input(<span class="stringliteral">&#39;_POST&#39;</span>, <span class="stringliteral">&#39;password&#39;</span>, [</div>
<div class="line"><a id="l02554" name="l02554"></a><span class="lineno"> 2554</span>                <span class="stringliteral">&#39;isset&#39;</span> =&gt; <span class="keyword">true</span>,</div>
<div class="line"><a id="l02555" name="l02555"></a><span class="lineno"> 2555</span>                <span class="stringliteral">&#39;empty&#39;</span> =&gt; <span class="keyword">true</span>,</div>
<div class="line"><a id="l02556" name="l02556"></a><span class="lineno"> 2556</span>            ])) {</div>
<div class="line"><a id="l02557" name="l02557"></a><span class="lineno"> 2557</span>            <span class="comment">// Входные данные формы невалидны</span></div>
<div class="line"><a id="l02558" name="l02558"></a><span class="lineno"> 2558</span>            header(<span class="stringliteral">&#39;Location: &#39;</span> . $redirect_url);</div>
<div class="line"><a id="l02559" name="l02559"></a><span class="lineno"> 2559</span>            exit;</div>
<div class="line"><a id="l02560" name="l02560"></a><span class="lineno"> 2560</span>        }</div>
<div class="line"><a id="l02561" name="l02561"></a><span class="lineno"> 2561</span> </div>
<div class="line"><a id="l02562" name="l02562"></a><span class="lineno"> 2562</span>        <span class="comment">// === 2. Поиск пользователя в базе данных по логину ===</span></div>
<div class="line"><a id="l02563" name="l02563"></a><span class="lineno"> 2563</span>        $this-&gt;db-&gt;select(</div>
<div class="line"><a id="l02564" name="l02564"></a><span class="lineno"> 2564</span>            [<span class="stringliteral">&#39;`id`&#39;</span>, <span class="stringliteral">&#39;`login`&#39;</span>, <span class="stringliteral">&#39;`password`&#39;</span>, <span class="stringliteral">&#39;`deleted_at`&#39;</span>, <span class="stringliteral">&#39;`permanently_deleted`&#39;</span>],</div>
<div class="line"><a id="l02565" name="l02565"></a><span class="lineno"> 2565</span>            TBL_USERS,</div>
<div class="line"><a id="l02566" name="l02566"></a><span class="lineno"> 2566</span>            [</div>
<div class="line"><a id="l02567" name="l02567"></a><span class="lineno"> 2567</span>                <span class="stringliteral">&#39;where&#39;</span>  =&gt; <span class="stringliteral">&#39;`login` = :login&#39;</span>,</div>
<div class="line"><a id="l02568" name="l02568"></a><span class="lineno"> 2568</span>                <span class="stringliteral">&#39;params&#39;</span> =&gt; [<span class="stringliteral">&#39;:login&#39;</span> =&gt; $post[<span class="stringliteral">&#39;login&#39;</span>]],</div>
<div class="line"><a id="l02569" name="l02569"></a><span class="lineno"> 2569</span>            ]</div>
<div class="line"><a id="l02570" name="l02570"></a><span class="lineno"> 2570</span>        );</div>
<div class="line"><a id="l02571" name="l02571"></a><span class="lineno"> 2571</span>        $user_data = $this-&gt;db-&gt;result_row();</div>
<div class="line"><a id="l02572" name="l02572"></a><span class="lineno"> 2572</span> </div>
<div class="line"><a id="l02573" name="l02573"></a><span class="lineno"> 2573</span>        <span class="keywordflow">if</span> ($user_data === <span class="keyword">false</span>) {</div>
<div class="line"><a id="l02574" name="l02574"></a><span class="lineno"> 2574</span>            <span class="comment">// Пользователь с указанным логином не найден</span></div>
<div class="line"><a id="l02575" name="l02575"></a><span class="lineno"> 2575</span>            log_in_file(</div>
<div class="line"><a id="l02576" name="l02576"></a><span class="lineno"> 2576</span>                __FILE__ . <span class="charliteral">&#39;:&#39;</span> . __LINE__ . <span class="stringliteral">&#39; (&#39;</span> . (__METHOD__ ?: __FUNCTION__ ?: <span class="stringliteral">&#39;global&#39;</span>) . <span class="stringliteral">&quot;) | Ошибка получения данных пользователя | Логин: {$post[&#39;login&#39;]}&quot;</span></div>
<div class="line"><a id="l02577" name="l02577"></a><span class="lineno"> 2577</span>            );</div>
<div class="line"><a id="l02578" name="l02578"></a><span class="lineno"> 2578</span>            header(<span class="stringliteral">&#39;Location: &#39;</span> . $redirect_url);</div>
<div class="line"><a id="l02579" name="l02579"></a><span class="lineno"> 2579</span>            exit;</div>
<div class="line"><a id="l02580" name="l02580"></a><span class="lineno"> 2580</span>        }</div>
<div class="line"><a id="l02581" name="l02581"></a><span class="lineno"> 2581</span> </div>
<div class="line"><a id="l02582" name="l02582"></a><span class="lineno"> 2582</span>        <span class="comment">// === 3. Проверяем статус удаления ===</span></div>
<div class="line"><a id="l02583" name="l02583"></a><span class="lineno"> 2583</span>        <span class="keywordflow">if</span> (!empty($user_data[<span class="stringliteral">&#39;permanently_deleted&#39;</span>])) {</div>
<div class="line"><a id="l02584" name="l02584"></a><span class="lineno"> 2584</span>            <span class="comment">// Пользователь окончательно удалён</span></div>
<div class="line"><a id="l02585" name="l02585"></a><span class="lineno"> 2585</span>            log_in_file(</div>
<div class="line"><a id="l02586" name="l02586"></a><span class="lineno"> 2586</span>                __FILE__ . <span class="charliteral">&#39;:&#39;</span> . __LINE__ . <span class="stringliteral">&#39; (&#39;</span> . (__METHOD__ ?: __FUNCTION__ ?: <span class="stringliteral">&#39;global&#39;</span>) . <span class="stringliteral">&quot;) | Попытка входа заблокированного пользователя ID: {$user_data[&#39;id&#39;]}&quot;</span></div>
<div class="line"><a id="l02587" name="l02587"></a><span class="lineno"> 2587</span>            );</div>
<div class="line"><a id="l02588" name="l02588"></a><span class="lineno"> 2588</span>            header(<span class="stringliteral">&#39;Location: &#39;</span> . $redirect_url);</div>
<div class="line"><a id="l02589" name="l02589"></a><span class="lineno"> 2589</span>            exit;</div>
<div class="line"><a id="l02590" name="l02590"></a><span class="lineno"> 2590</span>        }</div>
<div class="line"><a id="l02591" name="l02591"></a><span class="lineno"> 2591</span> </div>
<div class="line"><a id="l02592" name="l02592"></a><span class="lineno"> 2592</span>        <span class="keywordflow">if</span> (!empty($user_data[<span class="stringliteral">&#39;deleted_at&#39;</span>])) {</div>
<div class="line"><a id="l02593" name="l02593"></a><span class="lineno"> 2593</span>            <span class="comment">// Пользователь мягко удалён — проверяем истечение срока</span></div>
<div class="line"><a id="l02594" name="l02594"></a><span class="lineno"> 2594</span>            <span class="keywordflow">if</span> ($this-&gt;<a class="code hl_function" href="../../df/dfe/classPhotoRigma_1_1Classes_1_1User.html#ae7bbb3d70503c2c3ab7de0e44bf83798">_is_soft_delete_expired_internal</a>($user_data[<span class="stringliteral">&#39;deleted_at&#39;</span>])[<span class="stringliteral">&#39;expired&#39;</span>]) {</div>
<div class="line"><a id="l02595" name="l02595"></a><span class="lineno"> 2595</span>                <span class="comment">// Срок истёк — считаем аккаунт окончательно удалённым</span></div>
<div class="line"><a id="l02596" name="l02596"></a><span class="lineno"> 2596</span>                log_in_file(</div>
<div class="line"><a id="l02597" name="l02597"></a><span class="lineno"> 2597</span>                    __FILE__ . <span class="charliteral">&#39;:&#39;</span> . __LINE__ . <span class="stringliteral">&#39; (&#39;</span> . (__METHOD__ ?: __FUNCTION__ ?: <span class="stringliteral">&#39;global&#39;</span>) . <span class="stringliteral">&quot;) | Срок восстановления истёк | Пользователь ID: {$user_data[&#39;id&#39;]}&quot;</span></div>
<div class="line"><a id="l02598" name="l02598"></a><span class="lineno"> 2598</span>                );</div>
<div class="line"><a id="l02599" name="l02599"></a><span class="lineno"> 2599</span>                header(<span class="stringliteral">&#39;Location: &#39;</span> . $redirect_url);</div>
<div class="line"><a id="l02600" name="l02600"></a><span class="lineno"> 2600</span>                exit;</div>
<div class="line"><a id="l02601" name="l02601"></a><span class="lineno"> 2601</span>            }</div>
<div class="line"><a id="l02602" name="l02602"></a><span class="lineno"> 2602</span> </div>
<div class="line"><a id="l02603" name="l02603"></a><span class="lineno"> 2603</span>            <span class="comment">// Срок не истёк — восстанавливаем аккаунт</span></div>
<div class="line"><a id="l02604" name="l02604"></a><span class="lineno"> 2604</span>            log_in_file(</div>
<div class="line"><a id="l02605" name="l02605"></a><span class="lineno"> 2605</span>                __FILE__ . <span class="charliteral">&#39;:&#39;</span> . __LINE__ . <span class="stringliteral">&#39; (&#39;</span> . (__METHOD__ ?: __FUNCTION__ ?: <span class="stringliteral">&#39;global&#39;</span>) . <span class="stringliteral">&quot;) | Аккаунт мягко удалён, но срок восстановления не истёк | Пользователь ID: {$user_data[&#39;id&#39;]}&quot;</span></div>
<div class="line"><a id="l02606" name="l02606"></a><span class="lineno"> 2606</span>            );</div>
<div class="line"><a id="l02607" name="l02607"></a><span class="lineno"> 2607</span> </div>
<div class="line"><a id="l02608" name="l02608"></a><span class="lineno"> 2608</span>            $this-&gt;db-&gt;update(</div>
<div class="line"><a id="l02609" name="l02609"></a><span class="lineno"> 2609</span>                [<span class="stringliteral">&#39;`deleted_at`&#39;</span> =&gt; <span class="stringliteral">&#39;NULL&#39;</span>],</div>
<div class="line"><a id="l02610" name="l02610"></a><span class="lineno"> 2610</span>                TBL_USERS,</div>
<div class="line"><a id="l02611" name="l02611"></a><span class="lineno"> 2611</span>                [<span class="stringliteral">&#39;where&#39;</span> =&gt; <span class="stringliteral">&#39;`id` = :id&#39;</span>, <span class="stringliteral">&#39;params&#39;</span> =&gt; [<span class="stringliteral">&#39;:id&#39;</span> =&gt; $user_data[<span class="stringliteral">&#39;id&#39;</span>]]]</div>
<div class="line"><a id="l02612" name="l02612"></a><span class="lineno"> 2612</span>            );</div>
<div class="line"><a id="l02613" name="l02613"></a><span class="lineno"> 2613</span> </div>
<div class="line"><a id="l02614" name="l02614"></a><span class="lineno"> 2614</span>            $rows = $this-&gt;db-&gt;get_affected_rows();</div>
<div class="line"><a id="l02615" name="l02615"></a><span class="lineno"> 2615</span>            <span class="keywordflow">if</span> ($rows &lt;= 0) {</div>
<div class="line"><a id="l02616" name="l02616"></a><span class="lineno"> 2616</span>                log_in_file(</div>
<div class="line"><a id="l02617" name="l02617"></a><span class="lineno"> 2617</span>                    __FILE__ . <span class="charliteral">&#39;:&#39;</span> . __LINE__ . <span class="stringliteral">&#39; (&#39;</span> . (__METHOD__ ?: __FUNCTION__ ?: <span class="stringliteral">&#39;global&#39;</span>) . <span class="stringliteral">&quot;) | Ошибка восстановления аккаунта | Пользователь ID: {$user_data[&#39;id&#39;]}&quot;</span></div>
<div class="line"><a id="l02618" name="l02618"></a><span class="lineno"> 2618</span>                );</div>
<div class="line"><a id="l02619" name="l02619"></a><span class="lineno"> 2619</span>            }</div>
<div class="line"><a id="l02620" name="l02620"></a><span class="lineno"> 2620</span>        }</div>
<div class="line"><a id="l02621" name="l02621"></a><span class="lineno"> 2621</span> </div>
<div class="line"><a id="l02622" name="l02622"></a><span class="lineno"> 2622</span>        <span class="comment">// === 4. Проверка пароля ===</span></div>
<div class="line"><a id="l02623" name="l02623"></a><span class="lineno"> 2623</span>        <span class="keywordflow">if</span> (!password_verify($post[<span class="stringliteral">&#39;password&#39;</span>], $user_data[<span class="stringliteral">&#39;password&#39;</span>])) {</div>
<div class="line"><a id="l02624" name="l02624"></a><span class="lineno"> 2624</span>            <span class="comment">// Если проверка через password_verify() не прошла, проверяем через md5</span></div>
<div class="line"><a id="l02625" name="l02625"></a><span class="lineno"> 2625</span>            <span class="keywordflow">if</span> (md5($post[<span class="stringliteral">&#39;password&#39;</span>]) !== $user_data[<span class="stringliteral">&#39;password&#39;</span>]) {</div>
<div class="line"><a id="l02626" name="l02626"></a><span class="lineno"> 2626</span>                <span class="comment">// Пароль неверный</span></div>
<div class="line"><a id="l02627" name="l02627"></a><span class="lineno"> 2627</span>                log_in_file(</div>
<div class="line"><a id="l02628" name="l02628"></a><span class="lineno"> 2628</span>                    __FILE__ . <span class="charliteral">&#39;:&#39;</span> . __LINE__ . <span class="stringliteral">&#39; (&#39;</span> . (__METHOD__ ?: __FUNCTION__ ?: <span class="stringliteral">&#39;global&#39;</span>) . <span class="stringliteral">&quot;) | Неверный пароль | Логин: {$post[&#39;login&#39;]}&quot;</span></div>
<div class="line"><a id="l02629" name="l02629"></a><span class="lineno"> 2629</span>                );</div>
<div class="line"><a id="l02630" name="l02630"></a><span class="lineno"> 2630</span>                header(<span class="stringliteral">&#39;Location: &#39;</span> . $redirect_url);</div>
<div class="line"><a id="l02631" name="l02631"></a><span class="lineno"> 2631</span>                exit;</div>
<div class="line"><a id="l02632" name="l02632"></a><span class="lineno"> 2632</span>            }</div>
<div class="line"><a id="l02633" name="l02633"></a><span class="lineno"> 2633</span> </div>
<div class="line"><a id="l02634" name="l02634"></a><span class="lineno"> 2634</span>            <span class="comment">// Пароль верный, но хранится в формате md5. Преобразуем его в password_hash()</span></div>
<div class="line"><a id="l02635" name="l02635"></a><span class="lineno"> 2635</span>            $new_password_hash = password_hash($post[<span class="stringliteral">&#39;password&#39;</span>], PASSWORD_BCRYPT);</div>
<div class="line"><a id="l02636" name="l02636"></a><span class="lineno"> 2636</span> </div>
<div class="line"><a id="l02637" name="l02637"></a><span class="lineno"> 2637</span>            $this-&gt;db-&gt;update(</div>
<div class="line"><a id="l02638" name="l02638"></a><span class="lineno"> 2638</span>                [<span class="stringliteral">&#39;`password`&#39;</span> =&gt; <span class="stringliteral">&#39;:password&#39;</span>],</div>
<div class="line"><a id="l02639" name="l02639"></a><span class="lineno"> 2639</span>                TBL_USERS,</div>
<div class="line"><a id="l02640" name="l02640"></a><span class="lineno"> 2640</span>                [</div>
<div class="line"><a id="l02641" name="l02641"></a><span class="lineno"> 2641</span>                    <span class="stringliteral">&#39;where&#39;</span>  =&gt; <span class="stringliteral">&#39;`id` = :id&#39;</span>,</div>
<div class="line"><a id="l02642" name="l02642"></a><span class="lineno"> 2642</span>                    <span class="stringliteral">&#39;params&#39;</span> =&gt; [</div>
<div class="line"><a id="l02643" name="l02643"></a><span class="lineno"> 2643</span>                        <span class="stringliteral">&#39;:password&#39;</span> =&gt; $new_password_hash,</div>
<div class="line"><a id="l02644" name="l02644"></a><span class="lineno"> 2644</span>                        <span class="stringliteral">&#39;:id&#39;</span>       =&gt; $user_data[<span class="stringliteral">&#39;id&#39;</span>],</div>
<div class="line"><a id="l02645" name="l02645"></a><span class="lineno"> 2645</span>                    ],</div>
<div class="line"><a id="l02646" name="l02646"></a><span class="lineno"> 2646</span>                ]</div>
<div class="line"><a id="l02647" name="l02647"></a><span class="lineno"> 2647</span>            );</div>
<div class="line"><a id="l02648" name="l02648"></a><span class="lineno"> 2648</span> </div>
<div class="line"><a id="l02649" name="l02649"></a><span class="lineno"> 2649</span>            $rows = $this-&gt;db-&gt;get_affected_rows();</div>
<div class="line"><a id="l02650" name="l02650"></a><span class="lineno"> 2650</span>            <span class="keywordflow">if</span> ($rows &gt; 0) {</div>
<div class="line"><a id="l02651" name="l02651"></a><span class="lineno"> 2651</span>                log_in_file(</div>
<div class="line"><a id="l02652" name="l02652"></a><span class="lineno"> 2652</span>                    __FILE__ . <span class="charliteral">&#39;:&#39;</span> . __LINE__ . <span class="stringliteral">&#39; (&#39;</span> . (__METHOD__ ?: __FUNCTION__ ?: <span class="stringliteral">&#39;global&#39;</span>) . <span class="stringliteral">&quot;) | Пароль успешно обновлён до нового формата | Пользователь ID: {$user_data[&#39;id&#39;]}&quot;</span></div>
<div class="line"><a id="l02653" name="l02653"></a><span class="lineno"> 2653</span>                );</div>
<div class="line"><a id="l02654" name="l02654"></a><span class="lineno"> 2654</span>            } <span class="keywordflow">else</span> {</div>
<div class="line"><a id="l02655" name="l02655"></a><span class="lineno"> 2655</span>                log_in_file(</div>
<div class="line"><a id="l02656" name="l02656"></a><span class="lineno"> 2656</span>                    __FILE__ . <span class="charliteral">&#39;:&#39;</span> . __LINE__ . <span class="stringliteral">&#39; (&#39;</span> . (__METHOD__ ?: __FUNCTION__ ?: <span class="stringliteral">&#39;global&#39;</span>) . <span class="stringliteral">&quot;) | Ошибка обновления пароля | Пользователь ID: {$user_data[&#39;id&#39;]}&quot;</span></div>
<div class="line"><a id="l02657" name="l02657"></a><span class="lineno"> 2657</span>                );</div>
<div class="line"><a id="l02658" name="l02658"></a><span class="lineno"> 2658</span>            }</div>
<div class="line"><a id="l02659" name="l02659"></a><span class="lineno"> 2659</span>        }</div>
<div class="line"><a id="l02660" name="l02660"></a><span class="lineno"> 2660</span> </div>
<div class="line"><a id="l02661" name="l02661"></a><span class="lineno"> 2661</span>        <span class="comment">// === 5. Возвращаем ID пользователя ===</span></div>
<div class="line"><a id="l02662" name="l02662"></a><span class="lineno"> 2662</span>        <span class="keywordflow">return</span> $user_data[<span class="stringliteral">&#39;id&#39;</span>];</div>
<div class="line"><a id="l02663" name="l02663"></a><span class="lineno"> 2663</span>    }</div>
</div>
<div class="line"><a id="l02664" name="l02664"></a><span class="lineno"> 2664</span></div>
<div class="foldopen" id="foldopen02734" data-start="{" data-end="}">
<div class="line"><a id="l02734" name="l02734"></a><span class="lineno"><a class="line" href="../../df/dfe/classPhotoRigma_1_1Classes_1_1User.html#a855f88015180a39f2464a41a2ce2a5c2"> 2734</a></span>    <span class="keyword">public</span> <span class="keyword">function</span> <a class="code hl_function" href="../../df/dfe/classPhotoRigma_1_1Classes_1_1User.html#a855f88015180a39f2464a41a2ce2a5c2">update_user_data</a>(<span class="keywordtype">int</span> $user_id, array $post_data, array $files_data, <span class="keywordtype">int</span> $max_size): int</div>
<div class="line"><a id="l02735" name="l02735"></a><span class="lineno"> 2735</span>    {</div>
<div class="line"><a id="l02736" name="l02736"></a><span class="lineno"> 2736</span>        <span class="keywordflow">return</span> $this-&gt;<a class="code hl_function" href="../../df/dfe/classPhotoRigma_1_1Classes_1_1User.html#a2ca555fe6bbef0b0a691c03111ffe700">_update_user_data_internal</a>($user_id, $post_data, $files_data, $max_size);</div>
<div class="line"><a id="l02737" name="l02737"></a><span class="lineno"> 2737</span>    }</div>
</div>
<div class="line"><a id="l02738" name="l02738"></a><span class="lineno"> 2738</span></div>
<div class="foldopen" id="foldopen02826" data-start="{" data-end="}">
<div class="line"><a id="l02826" name="l02826"></a><span class="lineno"><a class="line" href="../../df/dfe/classPhotoRigma_1_1Classes_1_1User.html#a2ca555fe6bbef0b0a691c03111ffe700"> 2826</a></span>    <span class="keyword">protected</span> <span class="keyword">function</span> <a class="code hl_function" href="../../df/dfe/classPhotoRigma_1_1Classes_1_1User.html#a2ca555fe6bbef0b0a691c03111ffe700">_update_user_data_internal</a>(<span class="keywordtype">int</span> $user_id, array $post_data, array $files_data, <span class="keywordtype">int</span> $max_size): int</div>
<div class="line"><a id="l02827" name="l02827"></a><span class="lineno"> 2827</span>    {</div>
<div class="line"><a id="l02828" name="l02828"></a><span class="lineno"> 2828</span>        <span class="comment">// Проверяем, существует ли пользователь с указанным ID</span></div>
<div class="line"><a id="l02829" name="l02829"></a><span class="lineno"> 2829</span>        $this-&gt;db-&gt;select(<span class="charliteral">&#39;*&#39;</span>, TBL_USERS, [</div>
<div class="line"><a id="l02830" name="l02830"></a><span class="lineno"> 2830</span>            <span class="stringliteral">&#39;where&#39;</span>  =&gt; <span class="stringliteral">&#39;`id` = :user_id&#39;</span>,</div>
<div class="line"><a id="l02831" name="l02831"></a><span class="lineno"> 2831</span>            <span class="stringliteral">&#39;params&#39;</span> =&gt; [<span class="stringliteral">&#39;:user_id&#39;</span> =&gt; $user_id],</div>
<div class="line"><a id="l02832" name="l02832"></a><span class="lineno"> 2832</span>        ]);</div>
<div class="line"><a id="l02833" name="l02833"></a><span class="lineno"> 2833</span>        $user_data = $this-&gt;db-&gt;result_row();</div>
<div class="line"><a id="l02834" name="l02834"></a><span class="lineno"> 2834</span>        <span class="keywordflow">if</span> (!$user_data) {</div>
<div class="line"><a id="l02835" name="l02835"></a><span class="lineno"> 2835</span>            <span class="keywordflow">throw</span> <span class="keyword">new</span> RuntimeException(</div>
<div class="line"><a id="l02836" name="l02836"></a><span class="lineno"> 2836</span>                __FILE__ . <span class="charliteral">&#39;:&#39;</span> . __LINE__ . <span class="stringliteral">&#39; (&#39;</span> . (__METHOD__ ?: __FUNCTION__ ?: <span class="stringliteral">&#39;global&#39;</span>) . <span class="stringliteral">&quot;) | Пользователь не найден | ID: $user_id&quot;</span></div>
<div class="line"><a id="l02837" name="l02837"></a><span class="lineno"> 2837</span>            );</div>
<div class="line"><a id="l02838" name="l02838"></a><span class="lineno"> 2838</span>        }</div>
<div class="line"><a id="l02839" name="l02839"></a><span class="lineno"> 2839</span>        $new_user_data = [];</div>
<div class="line"><a id="l02840" name="l02840"></a><span class="lineno"> 2840</span>        <span class="comment">// === ПРОВЕРКА ПАРОЛЯ ===</span></div>
<div class="line"><a id="l02841" name="l02841"></a><span class="lineno"> 2841</span>        <span class="keywordflow">if</span> ($user_id !== $this-&gt;session[<span class="stringliteral">&#39;login_id&#39;</span>] || ($this-&gt;work-&gt;check_input(</div>
<div class="line"><a id="l02842" name="l02842"></a><span class="lineno"> 2842</span>            <span class="stringliteral">&#39;_POST&#39;</span>,</div>
<div class="line"><a id="l02843" name="l02843"></a><span class="lineno"> 2843</span>            <span class="stringliteral">&#39;password&#39;</span>,</div>
<div class="line"><a id="l02844" name="l02844"></a><span class="lineno"> 2844</span>            [<span class="stringliteral">&#39;isset&#39;</span> =&gt; <span class="keyword">true</span>, <span class="stringliteral">&#39;empty&#39;</span> =&gt; <span class="keyword">true</span>]</div>
<div class="line"><a id="l02845" name="l02845"></a><span class="lineno"> 2845</span>        ) &amp;&amp; password_verify($post_data[<span class="stringliteral">&#39;password&#39;</span>], $user_data[<span class="stringliteral">&#39;password&#39;</span>]))) {</div>
<div class="line"><a id="l02846" name="l02846"></a><span class="lineno"> 2846</span>            <span class="keywordflow">if</span> ($this-&gt;work-&gt;check_input(<span class="stringliteral">&#39;_POST&#39;</span>, <span class="stringliteral">&#39;edit_password&#39;</span>, [<span class="stringliteral">&#39;isset&#39;</span> =&gt; <span class="keyword">true</span>, <span class="stringliteral">&#39;empty&#39;</span> =&gt; <span class="keyword">true</span>])) {</div>
<div class="line"><a id="l02847" name="l02847"></a><span class="lineno"> 2847</span>                $new_user_data[<span class="stringliteral">&#39;password&#39;</span>] = $post_data[<span class="stringliteral">&#39;re_password&#39;</span>] !== $post_data[<span class="stringliteral">&#39;edit_password&#39;</span>] ? $user_data[<span class="stringliteral">&#39;password&#39;</span>] : password_hash(</div>
<div class="line"><a id="l02848" name="l02848"></a><span class="lineno"> 2848</span>                    $post_data[<span class="stringliteral">&#39;re_password&#39;</span>],</div>
<div class="line"><a id="l02849" name="l02849"></a><span class="lineno"> 2849</span>                    PASSWORD_BCRYPT</div>
<div class="line"><a id="l02850" name="l02850"></a><span class="lineno"> 2850</span>                );</div>
<div class="line"><a id="l02851" name="l02851"></a><span class="lineno"> 2851</span>            } <span class="keywordflow">else</span> {</div>
<div class="line"><a id="l02852" name="l02852"></a><span class="lineno"> 2852</span>                $new_user_data[<span class="stringliteral">&#39;password&#39;</span>] = $user_data[<span class="stringliteral">&#39;password&#39;</span>];</div>
<div class="line"><a id="l02853" name="l02853"></a><span class="lineno"> 2853</span>            }</div>
<div class="line"><a id="l02854" name="l02854"></a><span class="lineno"> 2854</span>        }</div>
<div class="line"><a id="l02855" name="l02855"></a><span class="lineno"> 2855</span>        <span class="comment">// === ПРОВЕРКА EMAIL И REAL_NAME ===</span></div>
<div class="line"><a id="l02856" name="l02856"></a><span class="lineno"> 2856</span>        <span class="keywordflow">if</span> ($this-&gt;work-&gt;check_input(<span class="stringliteral">&#39;_POST&#39;</span>, <span class="stringliteral">&#39;email&#39;</span>, [<span class="stringliteral">&#39;isset&#39;</span> =&gt; <span class="keyword">true</span>, <span class="stringliteral">&#39;empty&#39;</span> =&gt; <span class="keyword">true</span>, <span class="stringliteral">&#39;regexp&#39;</span> =&gt; REG_EMAIL])) {</div>
<div class="line"><a id="l02857" name="l02857"></a><span class="lineno"> 2857</span>            $filtered_email = filter_var($post_data[<span class="stringliteral">&#39;email&#39;</span>], FILTER_SANITIZE_EMAIL);</div>
<div class="line"><a id="l02858" name="l02858"></a><span class="lineno"> 2858</span>            $this-&gt;db-&gt;select(</div>
<div class="line"><a id="l02859" name="l02859"></a><span class="lineno"> 2859</span>                <span class="stringliteral">&#39;SUM(`email` = :email) as `email_count`, SUM(`real_name` = :real_name) as `real_count`&#39;</span>,</div>
<div class="line"><a id="l02860" name="l02860"></a><span class="lineno"> 2860</span>                TBL_USERS,</div>
<div class="line"><a id="l02861" name="l02861"></a><span class="lineno"> 2861</span>                [</div>
<div class="line"><a id="l02862" name="l02862"></a><span class="lineno"> 2862</span>                    <span class="stringliteral">&#39;where&#39;</span>  =&gt; <span class="stringliteral">&#39;`id` != :user_id&#39;</span>,</div>
<div class="line"><a id="l02863" name="l02863"></a><span class="lineno"> 2863</span>                    <span class="stringliteral">&#39;params&#39;</span> =&gt; [</div>
<div class="line"><a id="l02864" name="l02864"></a><span class="lineno"> 2864</span>                        <span class="stringliteral">&#39;:user_id&#39;</span>   =&gt; $user_id,</div>
<div class="line"><a id="l02865" name="l02865"></a><span class="lineno"> 2865</span>                        <span class="stringliteral">&#39;:email&#39;</span>     =&gt; $filtered_email,</div>
<div class="line"><a id="l02866" name="l02866"></a><span class="lineno"> 2866</span>                        <span class="stringliteral">&#39;:real_name&#39;</span> =&gt; $post_data[<span class="stringliteral">&#39;real_name&#39;</span>],</div>
<div class="line"><a id="l02867" name="l02867"></a><span class="lineno"> 2867</span>                    ],</div>
<div class="line"><a id="l02868" name="l02868"></a><span class="lineno"> 2868</span>                ]</div>
<div class="line"><a id="l02869" name="l02869"></a><span class="lineno"> 2869</span>            );</div>
<div class="line"><a id="l02870" name="l02870"></a><span class="lineno"> 2870</span>            $counts = $this-&gt;db-&gt;result_row();</div>
<div class="line"><a id="l02871" name="l02871"></a><span class="lineno"> 2871</span>            $new_user_data[<span class="stringliteral">&#39;email&#39;</span>] = $counts &amp;&amp; isset($counts[<span class="stringliteral">&#39;email_count&#39;</span>]) &amp;&amp; $counts[<span class="stringliteral">&#39;email_count&#39;</span>] &gt; 0 ? $user_data[<span class="stringliteral">&#39;email&#39;</span>] : $filtered_email;</div>
<div class="line"><a id="l02872" name="l02872"></a><span class="lineno"> 2872</span>            $new_user_data[<span class="stringliteral">&#39;real_name&#39;</span>] = $counts &amp;&amp; isset($counts[<span class="stringliteral">&#39;real_count&#39;</span>]) &amp;&amp; $counts[<span class="stringliteral">&#39;real_count&#39;</span>] &gt; 0 ? $user_data[<span class="stringliteral">&#39;real_name&#39;</span>] : $post_data[<span class="stringliteral">&#39;real_name&#39;</span>];</div>
<div class="line"><a id="l02873" name="l02873"></a><span class="lineno"> 2873</span>        } <span class="keywordflow">else</span> {</div>
<div class="line"><a id="l02874" name="l02874"></a><span class="lineno"> 2874</span>            $new_user_data[<span class="stringliteral">&#39;email&#39;</span>] = $user_data[<span class="stringliteral">&#39;email&#39;</span>];</div>
<div class="line"><a id="l02875" name="l02875"></a><span class="lineno"> 2875</span>            $new_user_data[<span class="stringliteral">&#39;real_name&#39;</span>] = $user_data[<span class="stringliteral">&#39;real_name&#39;</span>];</div>
<div class="line"><a id="l02876" name="l02876"></a><span class="lineno"> 2876</span>        }</div>
<div class="line"><a id="l02877" name="l02877"></a><span class="lineno"> 2877</span>        <span class="comment">// === ОБРАБОТКА АВАТАРА ===</span></div>
<div class="line"><a id="l02878" name="l02878"></a><span class="lineno"> 2878</span>        $delete_old_avatar = <span class="keyword">false</span>; <span class="comment">// Флаг для удаления старого аватара</span></div>
<div class="line"><a id="l02879" name="l02879"></a><span class="lineno"> 2879</span>        <span class="keywordflow">if</span> ($post_data[<span class="stringliteral">&#39;delete_avatar&#39;</span>] !== <span class="stringliteral">&#39;true&#39;</span> || !$this-&gt;work-&gt;check_input(</div>
<div class="line"><a id="l02880" name="l02880"></a><span class="lineno"> 2880</span>            <span class="stringliteral">&#39;_POST&#39;</span>,</div>
<div class="line"><a id="l02881" name="l02881"></a><span class="lineno"> 2881</span>            <span class="stringliteral">&#39;delete_avatar&#39;</span>,</div>
<div class="line"><a id="l02882" name="l02882"></a><span class="lineno"> 2882</span>            [<span class="stringliteral">&#39;isset&#39;</span> =&gt; <span class="keyword">true</span>, <span class="stringliteral">&#39;empty&#39;</span> =&gt; <span class="keyword">true</span>]</div>
<div class="line"><a id="l02883" name="l02883"></a><span class="lineno"> 2883</span>        )) {</div>
<div class="line"><a id="l02884" name="l02884"></a><span class="lineno"> 2884</span>            $new_user_data[<span class="stringliteral">&#39;avatar&#39;</span>] = $this-&gt;<a class="code hl_function" href="../../df/dfe/classPhotoRigma_1_1Classes_1_1User.html#ad851c6d04f2daadb2243097b75f8bb90">_edit_avatar</a>($files_data, $max_size);</div>
<div class="line"><a id="l02885" name="l02885"></a><span class="lineno"> 2885</span>            <span class="comment">// Проверяем, нужно ли удалить старый аватар</span></div>
<div class="line"><a id="l02886" name="l02886"></a><span class="lineno"> 2886</span>            <span class="keywordflow">if</span> ($user_data[<span class="stringliteral">&#39;avatar&#39;</span>] !== DEFAULT_AVATAR &amp;&amp; $user_data[<span class="stringliteral">&#39;avatar&#39;</span>] !== $new_user_data[<span class="stringliteral">&#39;avatar&#39;</span>]) {</div>
<div class="line"><a id="l02887" name="l02887"></a><span class="lineno"> 2887</span>                $delete_old_avatar = <span class="keyword">true</span>; <span class="comment">// Устанавливаем флаг на удаление</span></div>
<div class="line"><a id="l02888" name="l02888"></a><span class="lineno"> 2888</span>            }</div>
<div class="line"><a id="l02889" name="l02889"></a><span class="lineno"> 2889</span>        } <span class="keywordflow">else</span> {</div>
<div class="line"><a id="l02890" name="l02890"></a><span class="lineno"> 2890</span>            $old_avatar_path = $this-&gt;work-&gt;config[<span class="stringliteral">&#39;site_dir&#39;</span>] . $this-&gt;work-&gt;config[<span class="stringliteral">&#39;avatar_folder&#39;</span>] . <span class="charliteral">&#39;/&#39;</span> . $user_data[<span class="stringliteral">&#39;avatar&#39;</span>];</div>
<div class="line"><a id="l02891" name="l02891"></a><span class="lineno"> 2891</span>            <span class="keywordflow">if</span> ($user_data[<span class="stringliteral">&#39;avatar&#39;</span>] !== DEFAULT_AVATAR &amp;&amp; is_file($old_avatar_path) &amp;&amp; is_writable(</div>
<div class="line"><a id="l02892" name="l02892"></a><span class="lineno"> 2892</span>                $old_avatar_path</div>
<div class="line"><a id="l02893" name="l02893"></a><span class="lineno"> 2893</span>            )) {</div>
<div class="line"><a id="l02894" name="l02894"></a><span class="lineno"> 2894</span>                unlink($old_avatar_path); <span class="comment">// Безопасное удаление старого аватара</span></div>
<div class="line"><a id="l02895" name="l02895"></a><span class="lineno"> 2895</span>            }</div>
<div class="line"><a id="l02896" name="l02896"></a><span class="lineno"> 2896</span>            $new_user_data[<span class="stringliteral">&#39;avatar&#39;</span>] = DEFAULT_AVATAR;</div>
<div class="line"><a id="l02897" name="l02897"></a><span class="lineno"> 2897</span>        }</div>
<div class="line"><a id="l02898" name="l02898"></a><span class="lineno"> 2898</span>        <span class="comment">// === Проверка языка и темы сайта ===</span></div>
<div class="line"><a id="l02899" name="l02899"></a><span class="lineno"> 2899</span>        $new_user_data[<span class="stringliteral">&#39;language&#39;</span>] = $this-&gt;work-&gt;check_input(</div>
<div class="line"><a id="l02900" name="l02900"></a><span class="lineno"> 2900</span>            <span class="stringliteral">&#39;_POST&#39;</span>,</div>
<div class="line"><a id="l02901" name="l02901"></a><span class="lineno"> 2901</span>            <span class="stringliteral">&#39;language&#39;</span>,</div>
<div class="line"><a id="l02902" name="l02902"></a><span class="lineno"> 2902</span>            [<span class="stringliteral">&#39;isset&#39;</span> =&gt; <span class="keyword">true</span>, <span class="stringliteral">&#39;empty&#39;</span> =&gt; <span class="keyword">true</span>]</div>
<div class="line"><a id="l02903" name="l02903"></a><span class="lineno"> 2903</span>        ) ? $post_data[<span class="stringliteral">&#39;language&#39;</span>] : $user_data[<span class="stringliteral">&#39;language&#39;</span>];</div>
<div class="line"><a id="l02904" name="l02904"></a><span class="lineno"> 2904</span>        $new_user_data[<span class="stringliteral">&#39;theme&#39;</span>] = $this-&gt;work-&gt;check_input(</div>
<div class="line"><a id="l02905" name="l02905"></a><span class="lineno"> 2905</span>            <span class="stringliteral">&#39;_POST&#39;</span>,</div>
<div class="line"><a id="l02906" name="l02906"></a><span class="lineno"> 2906</span>            <span class="stringliteral">&#39;theme&#39;</span>,</div>
<div class="line"><a id="l02907" name="l02907"></a><span class="lineno"> 2907</span>            [<span class="stringliteral">&#39;isset&#39;</span> =&gt; <span class="keyword">true</span>, <span class="stringliteral">&#39;empty&#39;</span> =&gt; <span class="keyword">true</span>]</div>
<div class="line"><a id="l02908" name="l02908"></a><span class="lineno"> 2908</span>        ) ? $post_data[<span class="stringliteral">&#39;theme&#39;</span>] : $user_data[<span class="stringliteral">&#39;theme&#39;</span>];</div>
<div class="line"><a id="l02909" name="l02909"></a><span class="lineno"> 2909</span>        <span class="comment">// === ОБНОВЛЕНИЕ ДАННЫХ В БАЗЕ ===</span></div>
<div class="line"><a id="l02910" name="l02910"></a><span class="lineno"> 2910</span>        <span class="comment">// === Формирование данных для обновления с плейсхолдерами ===</span></div>
<div class="line"><a id="l02911" name="l02911"></a><span class="lineno"> 2911</span>        $update_data = [];</div>
<div class="line"><a id="l02912" name="l02912"></a><span class="lineno"> 2912</span>        $params = [];</div>
<div class="line"><a id="l02913" name="l02913"></a><span class="lineno"> 2913</span>        <span class="keywordflow">foreach</span> ($new_user_data as $field =&gt; $value) {</div>
<div class="line"><a id="l02914" name="l02914"></a><span class="lineno"> 2914</span>            $placeholder = <span class="stringliteral">&quot;:update_$field&quot;</span>; <span class="comment">// Уникальный плейсхолдер для каждого поля</span></div>
<div class="line"><a id="l02915" name="l02915"></a><span class="lineno"> 2915</span>            $update_data[<span class="stringliteral">&quot;`$field`&quot;</span>] = $placeholder; <span class="comment">// Формируем ассоциативный массив для update</span></div>
<div class="line"><a id="l02916" name="l02916"></a><span class="lineno"> 2916</span>            $params[$placeholder] = $value; <span class="comment">// Добавляем значение в параметры</span></div>
<div class="line"><a id="l02917" name="l02917"></a><span class="lineno"> 2917</span>        }</div>
<div class="line"><a id="l02918" name="l02918"></a><span class="lineno"> 2918</span> </div>
<div class="line"><a id="l02919" name="l02919"></a><span class="lineno"> 2919</span>        <span class="comment">// Добавляем параметр для WHERE</span></div>
<div class="line"><a id="l02920" name="l02920"></a><span class="lineno"> 2920</span>        $params[<span class="stringliteral">&#39;:user_id&#39;</span>] = $user_id;</div>
<div class="line"><a id="l02921" name="l02921"></a><span class="lineno"> 2921</span> </div>
<div class="line"><a id="l02922" name="l02922"></a><span class="lineno"> 2922</span>        <span class="comment">// === Вызов метода update с явными плейсхолдерами ===</span></div>
<div class="line"><a id="l02923" name="l02923"></a><span class="lineno"> 2923</span>        $this-&gt;db-&gt;update(</div>
<div class="line"><a id="l02924" name="l02924"></a><span class="lineno"> 2924</span>            $update_data, <span class="comment">// Данные для обновления (ассоциативный массив с плейсхолдерами)</span></div>
<div class="line"><a id="l02925" name="l02925"></a><span class="lineno"> 2925</span>            TBL_USERS,    <span class="comment">// Таблица (строка)</span></div>
<div class="line"><a id="l02926" name="l02926"></a><span class="lineno"> 2926</span>            [</div>
<div class="line"><a id="l02927" name="l02927"></a><span class="lineno"> 2927</span>                <span class="stringliteral">&#39;where&#39;</span>  =&gt; <span class="stringliteral">&#39;`id` = :user_id&#39;</span>, <span class="comment">// Условие WHERE (строка)</span></div>
<div class="line"><a id="l02928" name="l02928"></a><span class="lineno"> 2928</span>                <span class="stringliteral">&#39;params&#39;</span> =&gt; $params,           <span class="comment">// Все параметры для prepared statements (массив)</span></div>
<div class="line"><a id="l02929" name="l02929"></a><span class="lineno"> 2929</span>            ]</div>
<div class="line"><a id="l02930" name="l02930"></a><span class="lineno"> 2930</span>        );</div>
<div class="line"><a id="l02931" name="l02931"></a><span class="lineno"> 2931</span>        $affected_rows = $this-&gt;db-&gt;get_affected_rows();</div>
<div class="line"><a id="l02932" name="l02932"></a><span class="lineno"> 2932</span>        <span class="comment">// Если данные успешно обновлены и флаг удаления установлен, удаляем старый аватар</span></div>
<div class="line"><a id="l02933" name="l02933"></a><span class="lineno"> 2933</span>        <span class="keywordflow">if</span> ($affected_rows &gt; 0 &amp;&amp; $delete_old_avatar) {</div>
<div class="line"><a id="l02934" name="l02934"></a><span class="lineno"> 2934</span>            $old_avatar_path = $this-&gt;work-&gt;config[<span class="stringliteral">&#39;site_dir&#39;</span>] . $this-&gt;work-&gt;config[<span class="stringliteral">&#39;avatar_folder&#39;</span>] . <span class="charliteral">&#39;/&#39;</span> . $user_data[<span class="stringliteral">&#39;avatar&#39;</span>];</div>
<div class="line"><a id="l02935" name="l02935"></a><span class="lineno"> 2935</span>            <span class="keywordflow">if</span> (is_file($old_avatar_path) &amp;&amp; is_writable($old_avatar_path)) {</div>
<div class="line"><a id="l02936" name="l02936"></a><span class="lineno"> 2936</span>                unlink($old_avatar_path); <span class="comment">// Безопасное удаление старого аватара</span></div>
<div class="line"><a id="l02937" name="l02937"></a><span class="lineno"> 2937</span>            }</div>
<div class="line"><a id="l02938" name="l02938"></a><span class="lineno"> 2938</span>        }</div>
<div class="line"><a id="l02939" name="l02939"></a><span class="lineno"> 2939</span>        <span class="keywordflow">return</span> $affected_rows;</div>
<div class="line"><a id="l02940" name="l02940"></a><span class="lineno"> 2940</span>    }</div>
</div>
<div class="line"><a id="l02941" name="l02941"></a><span class="lineno"> 2941</span></div>
<div class="foldopen" id="foldopen03017" data-start="{" data-end="}">
<div class="line"><a id="l03017" name="l03017"></a><span class="lineno"><a class="line" href="../../df/dfe/classPhotoRigma_1_1Classes_1_1User.html#ad851c6d04f2daadb2243097b75f8bb90"> 3017</a></span>    <span class="keyword">private</span> <span class="keyword">function</span> <a class="code hl_function" href="../../df/dfe/classPhotoRigma_1_1Classes_1_1User.html#ad851c6d04f2daadb2243097b75f8bb90">_edit_avatar</a>(array $files_data, <span class="keywordtype">int</span> $max_size): string</div>
<div class="line"><a id="l03018" name="l03018"></a><span class="lineno"> 3018</span>    {</div>
<div class="line"><a id="l03019" name="l03019"></a><span class="lineno"> 3019</span>        <span class="comment">// Проверяем входные данные через check_input</span></div>
<div class="line"><a id="l03020" name="l03020"></a><span class="lineno"> 3020</span>        <span class="keywordflow">if</span> ($this-&gt;work-&gt;check_input(<span class="stringliteral">&#39;_FILES&#39;</span>, <span class="stringliteral">&#39;file_avatar&#39;</span>, [</div>
<div class="line"><a id="l03021" name="l03021"></a><span class="lineno"> 3021</span>            <span class="stringliteral">&#39;isset&#39;</span>    =&gt; <span class="keyword">true</span>,</div>
<div class="line"><a id="l03022" name="l03022"></a><span class="lineno"> 3022</span>            <span class="stringliteral">&#39;empty&#39;</span>    =&gt; <span class="keyword">true</span>,</div>
<div class="line"><a id="l03023" name="l03023"></a><span class="lineno"> 3023</span>            <span class="stringliteral">&#39;max_size&#39;</span> =&gt; $max_size,</div>
<div class="line"><a id="l03024" name="l03024"></a><span class="lineno"> 3024</span>        ])) {</div>
<div class="line"><a id="l03025" name="l03025"></a><span class="lineno"> 3025</span>            <span class="comment">// Генерация имени файла</span></div>
<div class="line"><a id="l03026" name="l03026"></a><span class="lineno"> 3026</span>            $original_name = basename($files_data[<span class="stringliteral">&#39;file_avatar&#39;</span>][<span class="stringliteral">&#39;name&#39;</span>]);</div>
<div class="line"><a id="l03027" name="l03027"></a><span class="lineno"> 3027</span>            $file_info = pathinfo($original_name);</div>
<div class="line"><a id="l03028" name="l03028"></a><span class="lineno"> 3028</span>            $file_name = $file_info[<span class="stringliteral">&#39;filename&#39;</span>];</div>
<div class="line"><a id="l03029" name="l03029"></a><span class="lineno"> 3029</span>            $file_extension = isset($file_info[<span class="stringliteral">&#39;extension&#39;</span>]) ? <span class="charliteral">&#39;.&#39;</span> . $file_info[<span class="stringliteral">&#39;extension&#39;</span>] : <span class="stringliteral">&#39;&#39;</span>;</div>
<div class="line"><a id="l03030" name="l03030"></a><span class="lineno"> 3030</span>            $encoded_name = <a class="code hl_function" href="../../d7/d53/classPhotoRigma_1_1Classes_1_1Work.html#ad9ac814e0001840a4cdbf826d0d6e53e">Work::encodename</a>($file_name);</div>
<div class="line"><a id="l03031" name="l03031"></a><span class="lineno"> 3031</span>            $file_avatar = time() . <span class="charliteral">&#39;_&#39;</span> . $encoded_name . $file_extension;</div>
<div class="line"><a id="l03032" name="l03032"></a><span class="lineno"> 3032</span>            $path_avatar = $this-&gt;work-&gt;config[<span class="stringliteral">&#39;site_dir&#39;</span>] . $this-&gt;work-&gt;config[<span class="stringliteral">&#39;avatar_folder&#39;</span>] . <span class="charliteral">&#39;/&#39;</span> . $file_avatar;</div>
<div class="line"><a id="l03033" name="l03033"></a><span class="lineno"> 3033</span> </div>
<div class="line"><a id="l03034" name="l03034"></a><span class="lineno"> 3034</span>            <span class="comment">// Проверяем права доступа к директории</span></div>
<div class="line"><a id="l03035" name="l03035"></a><span class="lineno"> 3035</span>            <span class="keywordflow">if</span> (!is_writable($this-&gt;work-&gt;config[<span class="stringliteral">&#39;site_dir&#39;</span>] . $this-&gt;work-&gt;config[<span class="stringliteral">&#39;avatar_folder&#39;</span>])) {</div>
<div class="line"><a id="l03036" name="l03036"></a><span class="lineno"> 3036</span>                <span class="keywordflow">throw</span> <span class="keyword">new</span> RuntimeException(</div>
<div class="line"><a id="l03037" name="l03037"></a><span class="lineno"> 3037</span>                    __FILE__ . <span class="charliteral">&#39;:&#39;</span> . __LINE__ . <span class="stringliteral">&#39; (&#39;</span> . (__METHOD__ ?: __FUNCTION__ ?: <span class="stringliteral">&#39;global&#39;</span>) . <span class="stringliteral">&#39;) | Директория для аватаров недоступна для записи.&#39;</span></div>
<div class="line"><a id="l03038" name="l03038"></a><span class="lineno"> 3038</span>                );</div>
<div class="line"><a id="l03039" name="l03039"></a><span class="lineno"> 3039</span>            }</div>
<div class="line"><a id="l03040" name="l03040"></a><span class="lineno"> 3040</span> </div>
<div class="line"><a id="l03041" name="l03041"></a><span class="lineno"> 3041</span>            <span class="comment">// Перемещение загруженного файла</span></div>
<div class="line"><a id="l03042" name="l03042"></a><span class="lineno"> 3042</span>            <span class="keywordflow">if</span> (!move_uploaded_file($files_data[<span class="stringliteral">&#39;file_avatar&#39;</span>][<span class="stringliteral">&#39;tmp_name&#39;</span>], $path_avatar)) {</div>
<div class="line"><a id="l03043" name="l03043"></a><span class="lineno"> 3043</span>                <span class="keywordflow">throw</span> <span class="keyword">new</span> RuntimeException(</div>
<div class="line"><a id="l03044" name="l03044"></a><span class="lineno"> 3044</span>                    __FILE__ . <span class="charliteral">&#39;:&#39;</span> . __LINE__ . <span class="stringliteral">&#39; (&#39;</span> . (__METHOD__ ?: __FUNCTION__ ?: <span class="stringliteral">&#39;global&#39;</span>) . <span class="stringliteral">&quot;) | Не удалось переместить загруженный файл: {$files_data[&#39;file_avatar&#39;][&#39;tmp_name&#39;]} -&gt; $path_avatar&quot;</span></div>
<div class="line"><a id="l03045" name="l03045"></a><span class="lineno"> 3045</span>                );</div>
<div class="line"><a id="l03046" name="l03046"></a><span class="lineno"> 3046</span>            }</div>
<div class="line"><a id="l03047" name="l03047"></a><span class="lineno"> 3047</span> </div>
<div class="line"><a id="l03048" name="l03048"></a><span class="lineno"> 3048</span>            <span class="comment">// Корректировка расширения файла</span></div>
<div class="line"><a id="l03049" name="l03049"></a><span class="lineno"> 3049</span>            $fixed_path = $this-&gt;work-&gt;fix_file_extension($path_avatar);</div>
<div class="line"><a id="l03050" name="l03050"></a><span class="lineno"> 3050</span>            <span class="keywordflow">if</span> ($fixed_path !== $path_avatar) {</div>
<div class="line"><a id="l03051" name="l03051"></a><span class="lineno"> 3051</span>                rename($path_avatar, $fixed_path);</div>
<div class="line"><a id="l03052" name="l03052"></a><span class="lineno"> 3052</span>                $file_avatar = basename($fixed_path);</div>
<div class="line"><a id="l03053" name="l03053"></a><span class="lineno"> 3053</span>            }</div>
<div class="line"><a id="l03054" name="l03054"></a><span class="lineno"> 3054</span> </div>
<div class="line"><a id="l03055" name="l03055"></a><span class="lineno"> 3055</span>            <span class="keywordflow">return</span> $file_avatar;</div>
<div class="line"><a id="l03056" name="l03056"></a><span class="lineno"> 3056</span>        }</div>
<div class="line"><a id="l03057" name="l03057"></a><span class="lineno"> 3057</span> </div>
<div class="line"><a id="l03058" name="l03058"></a><span class="lineno"> 3058</span>        <span class="keywordflow">return</span> DEFAULT_AVATAR;</div>
<div class="line"><a id="l03059" name="l03059"></a><span class="lineno"> 3059</span>    }</div>
</div>
<div class="line"><a id="l03060" name="l03060"></a><span class="lineno"> 3060</span></div>
<div class="foldopen" id="foldopen03134" data-start="{" data-end="}">
<div class="line"><a id="l03134" name="l03134"></a><span class="lineno"><a class="line" href="../../df/dfe/classPhotoRigma_1_1Classes_1_1User.html#a54dd5e694d07ac47b91bf9a7cc58d9d2"> 3134</a></span>    <span class="keyword">public</span> <span class="keyword">function</span> <a class="code hl_function" href="../../df/dfe/classPhotoRigma_1_1Classes_1_1User.html#a54dd5e694d07ac47b91bf9a7cc58d9d2">update_user_rights</a>(<span class="keywordtype">int</span> $user_id, array $user_data, array $post_data): array</div>
<div class="line"><a id="l03135" name="l03135"></a><span class="lineno"> 3135</span>    {</div>
<div class="line"><a id="l03136" name="l03136"></a><span class="lineno"> 3136</span>        <span class="keywordflow">return</span> $this-&gt;<a class="code hl_function" href="../../df/dfe/classPhotoRigma_1_1Classes_1_1User.html#a0e0a242e5a2f6555e5f5dd0d4f9c52a4">_update_user_rights_internal</a>($user_id, $user_data, $post_data);</div>
<div class="line"><a id="l03137" name="l03137"></a><span class="lineno"> 3137</span>    }</div>
</div>
<div class="line"><a id="l03138" name="l03138"></a><span class="lineno"> 3138</span></div>
<div class="foldopen" id="foldopen03229" data-start="{" data-end="}">
<div class="line"><a id="l03229" name="l03229"></a><span class="lineno"><a class="line" href="../../df/dfe/classPhotoRigma_1_1Classes_1_1User.html#a0e0a242e5a2f6555e5f5dd0d4f9c52a4"> 3229</a></span>    <span class="keyword">protected</span> <span class="keyword">function</span> <a class="code hl_function" href="../../df/dfe/classPhotoRigma_1_1Classes_1_1User.html#a0e0a242e5a2f6555e5f5dd0d4f9c52a4">_update_user_rights_internal</a>(<span class="keywordtype">int</span> $user_id, array $user_data, array $post_data): array</div>
<div class="line"><a id="l03230" name="l03230"></a><span class="lineno"> 3230</span>    {</div>
<div class="line"><a id="l03231" name="l03231"></a><span class="lineno"> 3231</span>        $new_user_data = $user_data;</div>
<div class="line"><a id="l03232" name="l03232"></a><span class="lineno"> 3232</span>        <span class="comment">// Обновление группы пользователя</span></div>
<div class="line"><a id="l03234" name="l03234"></a><span class="lineno"> 3234</span>        <span class="keywordflow">if</span> ($this-&gt;work-&gt;check_input(<span class="stringliteral">&#39;_POST&#39;</span>, <span class="stringliteral">&#39;group&#39;</span>, [</div>
<div class="line"><a id="l03235" name="l03235"></a><span class="lineno"> 3235</span>                <span class="stringliteral">&#39;isset&#39;</span>    =&gt; <span class="keyword">true</span>,</div>
<div class="line"><a id="l03236" name="l03236"></a><span class="lineno"> 3236</span>                <span class="stringliteral">&#39;empty&#39;</span>    =&gt; <span class="keyword">true</span>,</div>
<div class="line"><a id="l03237" name="l03237"></a><span class="lineno"> 3237</span>                <span class="stringliteral">&#39;regexp&#39;</span>   =&gt; <span class="stringliteral">&#39;/^[0-9]+$/&#39;</span>,</div>
<div class="line"><a id="l03238" name="l03238"></a><span class="lineno"> 3238</span>                <span class="stringliteral">&#39;not_zero&#39;</span> =&gt; <span class="keyword">true</span>,</div>
<div class="line"><a id="l03239" name="l03239"></a><span class="lineno"> 3239</span>            ]) &amp;&amp; (<span class="keywordtype">int</span>)$post_data[<span class="stringliteral">&#39;group&#39;</span>] !== $user_data[<span class="stringliteral">&#39;group_id&#39;</span>]) {</div>
<div class="line"><a id="l03240" name="l03240"></a><span class="lineno"> 3240</span>            <span class="comment">// Получаем данные новой группы из таблицы групп</span></div>
<div class="line"><a id="l03241" name="l03241"></a><span class="lineno"> 3241</span>            $this-&gt;db-&gt;select(<span class="stringliteral">&#39;`id`, `user_rights`&#39;</span>, TBL_GROUP, [</div>
<div class="line"><a id="l03242" name="l03242"></a><span class="lineno"> 3242</span>                <span class="stringliteral">&#39;where&#39;</span>  =&gt; <span class="stringliteral">&#39;`id` = :group_id&#39;</span>,</div>
<div class="line"><a id="l03243" name="l03243"></a><span class="lineno"> 3243</span>                <span class="stringliteral">&#39;params&#39;</span> =&gt; [<span class="stringliteral">&#39;:group_id&#39;</span> =&gt; $post_data[<span class="stringliteral">&#39;group&#39;</span>]],</div>
<div class="line"><a id="l03244" name="l03244"></a><span class="lineno"> 3244</span>            ]);</div>
<div class="line"><a id="l03245" name="l03245"></a><span class="lineno"> 3245</span>            $group_data = $this-&gt;db-&gt;result_row();</div>
<div class="line"><a id="l03246" name="l03246"></a><span class="lineno"> 3246</span> </div>
<div class="line"><a id="l03247" name="l03247"></a><span class="lineno"> 3247</span>            <span class="keywordflow">if</span> ($group_data) {</div>
<div class="line"><a id="l03248" name="l03248"></a><span class="lineno"> 3248</span>                $query = [];</div>
<div class="line"><a id="l03249" name="l03249"></a><span class="lineno"> 3249</span>                <span class="keywordflow">foreach</span> ($group_data as $key =&gt; $value) {</div>
<div class="line"><a id="l03250" name="l03250"></a><span class="lineno"> 3250</span>                    <span class="keywordflow">if</span> ($key === <span class="stringliteral">&#39;id&#39;</span>) {</div>
<div class="line"><a id="l03251" name="l03251"></a><span class="lineno"> 3251</span>                        <span class="comment">// Обновляем ID группы пользователя</span></div>
<div class="line"><a id="l03252" name="l03252"></a><span class="lineno"> 3252</span>                        $query[<span class="stringliteral">&#39;`group_id`&#39;</span>] = <span class="stringliteral">&#39;:group_id&#39;</span>;</div>
<div class="line"><a id="l03253" name="l03253"></a><span class="lineno"> 3253</span>                        $params[<span class="stringliteral">&#39;:group_id&#39;</span>] = $value;</div>
<div class="line"><a id="l03254" name="l03254"></a><span class="lineno"> 3254</span>                        $new_user_data[<span class="stringliteral">&#39;group_id&#39;</span>] = $value;</div>
<div class="line"><a id="l03255" name="l03255"></a><span class="lineno"> 3255</span>                    } <span class="keywordflow">else</span> {</div>
<div class="line"><a id="l03256" name="l03256"></a><span class="lineno"> 3256</span>                        <span class="comment">// Формируем массив для обновления данных пользователя в БД</span></div>
<div class="line"><a id="l03257" name="l03257"></a><span class="lineno"> 3257</span>                        $query[<span class="stringliteral">&quot;`$key`&quot;</span>] = <span class="stringliteral">&quot;:$key&quot;</span>;</div>
<div class="line"><a id="l03258" name="l03258"></a><span class="lineno"> 3258</span>                        $params[<span class="stringliteral">&quot;:$key&quot;</span>] = $value;</div>
<div class="line"><a id="l03259" name="l03259"></a><span class="lineno"> 3259</span>                        $new_user_data[$key] = $value;</div>
<div class="line"><a id="l03260" name="l03260"></a><span class="lineno"> 3260</span>                    }</div>
<div class="line"><a id="l03261" name="l03261"></a><span class="lineno"> 3261</span>                }</div>
<div class="line"><a id="l03262" name="l03262"></a><span class="lineno"> 3262</span> </div>
<div class="line"><a id="l03263" name="l03263"></a><span class="lineno"> 3263</span>                $params[<span class="stringliteral">&#39;:uid&#39;</span>] = $user_id;</div>
<div class="line"><a id="l03264" name="l03264"></a><span class="lineno"> 3264</span> </div>
<div class="line"><a id="l03265" name="l03265"></a><span class="lineno"> 3265</span>                <span class="comment">// Обновляем данные пользователя в БД</span></div>
<div class="line"><a id="l03266" name="l03266"></a><span class="lineno"> 3266</span>                $this-&gt;db-&gt;update($query, TBL_USERS, [</div>
<div class="line"><a id="l03267" name="l03267"></a><span class="lineno"> 3267</span>                    <span class="stringliteral">&#39;where&#39;</span>  =&gt; <span class="stringliteral">&#39;`id` = :uid&#39;</span>,</div>
<div class="line"><a id="l03268" name="l03268"></a><span class="lineno"> 3268</span>                    <span class="stringliteral">&#39;params&#39;</span> =&gt; $params,</div>
<div class="line"><a id="l03269" name="l03269"></a><span class="lineno"> 3269</span>                ]);</div>
<div class="line"><a id="l03270" name="l03270"></a><span class="lineno"> 3270</span>                $rows = $this-&gt;db-&gt;get_affected_rows();</div>
<div class="line"><a id="l03271" name="l03271"></a><span class="lineno"> 3271</span> </div>
<div class="line"><a id="l03272" name="l03272"></a><span class="lineno"> 3272</span>                <span class="keywordflow">if</span> ($rows &gt; 0) {</div>
<div class="line"><a id="l03273" name="l03273"></a><span class="lineno"> 3273</span>                    <span class="comment">// Если данные успешно обновлены, обрабатываем права пользователя</span></div>
<div class="line"><a id="l03274" name="l03274"></a><span class="lineno"> 3274</span>                    $processed_rights = $this-&gt;<a class="code hl_function" href="../../df/dfe/classPhotoRigma_1_1Classes_1_1User.html#a6031ba212847fdf2810753c120c4b4d2">process_user_rights</a>($new_user_data[<span class="stringliteral">&#39;user_rights&#39;</span>]);</div>
<div class="line"><a id="l03275" name="l03275"></a><span class="lineno"> 3275</span>                    unset($new_user_data[<span class="stringliteral">&#39;user_rights&#39;</span>]);</div>
<div class="line"><a id="l03276" name="l03276"></a><span class="lineno"> 3276</span>                    $new_user_data = array_merge($new_user_data, $processed_rights);</div>
<div class="line"><a id="l03277" name="l03277"></a><span class="lineno"> 3277</span>                } <span class="keywordflow">else</span> {</div>
<div class="line"><a id="l03278" name="l03278"></a><span class="lineno"> 3278</span>                    <span class="keywordflow">throw</span> <span class="keyword">new</span> RuntimeException(</div>
<div class="line"><a id="l03279" name="l03279"></a><span class="lineno"> 3279</span>                        __FILE__ . <span class="charliteral">&#39;:&#39;</span> . __LINE__ . <span class="stringliteral">&#39; (&#39;</span> . (__METHOD__ ?: __FUNCTION__ ?: <span class="stringliteral">&#39;global&#39;</span>) . <span class="stringliteral">&quot;) | Ошибка при обновлении данных пользователя | ID пользователя: $user_id&quot;</span></div>
<div class="line"><a id="l03280" name="l03280"></a><span class="lineno"> 3280</span>                    );</div>
<div class="line"><a id="l03281" name="l03281"></a><span class="lineno"> 3281</span>                }</div>
<div class="line"><a id="l03282" name="l03282"></a><span class="lineno"> 3282</span>            } <span class="keywordflow">else</span> {</div>
<div class="line"><a id="l03283" name="l03283"></a><span class="lineno"> 3283</span>                <span class="comment">// Группа с указанным ID не найдена</span></div>
<div class="line"><a id="l03284" name="l03284"></a><span class="lineno"> 3284</span>                <span class="keywordflow">throw</span> <span class="keyword">new</span> RuntimeException(</div>
<div class="line"><a id="l03285" name="l03285"></a><span class="lineno"> 3285</span>                    __FILE__ . <span class="charliteral">&#39;:&#39;</span> . __LINE__ . <span class="stringliteral">&#39; (&#39;</span> . (__METHOD__ ?: __FUNCTION__ ?: <span class="stringliteral">&#39;global&#39;</span>) . <span class="stringliteral">&quot;) | Не удалось получить данные группы | ID группы: {$post_data[&#39;group&#39;]}&quot;</span></div>
<div class="line"><a id="l03286" name="l03286"></a><span class="lineno"> 3286</span>                );</div>
<div class="line"><a id="l03287" name="l03287"></a><span class="lineno"> 3287</span>            }</div>
<div class="line"><a id="l03288" name="l03288"></a><span class="lineno"> 3288</span>        } <span class="keywordflow">else</span> {</div>
<div class="line"><a id="l03289" name="l03289"></a><span class="lineno"> 3289</span>            <span class="comment">// Обновление прав доступа пользователя</span></div>
<div class="line"><a id="l03290" name="l03290"></a><span class="lineno"> 3290</span>            $new_user_rights = [];</div>
<div class="line"><a id="l03291" name="l03291"></a><span class="lineno"> 3291</span>            <span class="keywordflow">foreach</span> ($this-&gt;user_right_fields[<span class="stringliteral">&#39;all&#39;</span>] as $field) {</div>
<div class="line"><a id="l03292" name="l03292"></a><span class="lineno"> 3292</span>                <span class="keywordflow">if</span> ($this-&gt;work-&gt;check_input(<span class="stringliteral">&#39;_POST&#39;</span>, $field, [<span class="stringliteral">&#39;isset&#39;</span> =&gt; <span class="keyword">true</span>])) {</div>
<div class="line"><a id="l03293" name="l03293"></a><span class="lineno"> 3293</span>                    <span class="comment">// Если поле существует и имеет допустимое значение, устанавливаем его в true</span></div>
<div class="line"><a id="l03294" name="l03294"></a><span class="lineno"> 3294</span>                    $post_data[$field] = in_array($post_data[$field], [<span class="stringliteral">&#39;on&#39;</span>, 1, <span class="keyword">true</span>], <span class="keyword">true</span>);</div>
<div class="line"><a id="l03295" name="l03295"></a><span class="lineno"> 3295</span>                } <span class="keywordflow">else</span> {</div>
<div class="line"><a id="l03296" name="l03296"></a><span class="lineno"> 3296</span>                    <span class="comment">// Если поле не передано, устанавливаем его в false</span></div>
<div class="line"><a id="l03297" name="l03297"></a><span class="lineno"> 3297</span>                    $post_data[$field] = <span class="keyword">false</span>;</div>
<div class="line"><a id="l03298" name="l03298"></a><span class="lineno"> 3298</span>                }</div>
<div class="line"><a id="l03299" name="l03299"></a><span class="lineno"> 3299</span> </div>
<div class="line"><a id="l03300" name="l03300"></a><span class="lineno"> 3300</span>                $new_user_rights[$field] = $post_data[$field];</div>
<div class="line"><a id="l03301" name="l03301"></a><span class="lineno"> 3301</span>            }</div>
<div class="line"><a id="l03302" name="l03302"></a><span class="lineno"> 3302</span> </div>
<div class="line"><a id="l03303" name="l03303"></a><span class="lineno"> 3303</span>            <span class="comment">// Кодируем права доступа для сохранения в БД</span></div>
<div class="line"><a id="l03304" name="l03304"></a><span class="lineno"> 3304</span>            $encoded_user_rights = $this-&gt;<a class="code hl_function" href="../../df/dfe/classPhotoRigma_1_1Classes_1_1User.html#a6ccf217fb8ddc2f985779f15cf32f078">encode_user_rights</a>($new_user_rights);</div>
<div class="line"><a id="l03305" name="l03305"></a><span class="lineno"> 3305</span>            $new_user_data = array_merge($new_user_data, $new_user_rights);</div>
<div class="line"><a id="l03306" name="l03306"></a><span class="lineno"> 3306</span> </div>
<div class="line"><a id="l03307" name="l03307"></a><span class="lineno"> 3307</span>            <span class="comment">// Обновляем права доступа пользователя в БД</span></div>
<div class="line"><a id="l03308" name="l03308"></a><span class="lineno"> 3308</span>            $this-&gt;db-&gt;update(</div>
<div class="line"><a id="l03309" name="l03309"></a><span class="lineno"> 3309</span>                [<span class="stringliteral">&#39;`user_rights`&#39;</span> =&gt; <span class="stringliteral">&#39;:u_rights&#39;</span>],</div>
<div class="line"><a id="l03310" name="l03310"></a><span class="lineno"> 3310</span>                TBL_USERS,</div>
<div class="line"><a id="l03311" name="l03311"></a><span class="lineno"> 3311</span>                [</div>
<div class="line"><a id="l03312" name="l03312"></a><span class="lineno"> 3312</span>                    <span class="stringliteral">&#39;where&#39;</span>  =&gt; <span class="stringliteral">&#39;`id` = :uid&#39;</span>,</div>
<div class="line"><a id="l03313" name="l03313"></a><span class="lineno"> 3313</span>                    <span class="stringliteral">&#39;params&#39;</span> =&gt; [</div>
<div class="line"><a id="l03314" name="l03314"></a><span class="lineno"> 3314</span>                        <span class="stringliteral">&#39;:uid&#39;</span>      =&gt; $user_id,</div>
<div class="line"><a id="l03315" name="l03315"></a><span class="lineno"> 3315</span>                        <span class="stringliteral">&#39;:u_rights&#39;</span> =&gt; $encoded_user_rights,</div>
<div class="line"><a id="l03316" name="l03316"></a><span class="lineno"> 3316</span>                    ],</div>
<div class="line"><a id="l03317" name="l03317"></a><span class="lineno"> 3317</span>                ]</div>
<div class="line"><a id="l03318" name="l03318"></a><span class="lineno"> 3318</span>            );</div>
<div class="line"><a id="l03319" name="l03319"></a><span class="lineno"> 3319</span>        }</div>
<div class="line"><a id="l03320" name="l03320"></a><span class="lineno"> 3320</span> </div>
<div class="line"><a id="l03321" name="l03321"></a><span class="lineno"> 3321</span>        <span class="keywordflow">return</span> $new_user_data;</div>
<div class="line"><a id="l03322" name="l03322"></a><span class="lineno"> 3322</span>    }</div>
</div>
<div class="line"><a id="l03323" name="l03323"></a><span class="lineno"> 3323</span></div>
<div class="foldopen" id="foldopen03360" data-start="{" data-end="}">
<div class="line"><a id="l03360" name="l03360"></a><span class="lineno"><a class="line" href="../../df/dfe/classPhotoRigma_1_1Classes_1_1User.html#a83a705ec9f27426c7e5315e26d136770"> 3360</a></span>    <span class="keyword">public</span> <span class="keyword">function</span> <a class="code hl_function" href="../../df/dfe/classPhotoRigma_1_1Classes_1_1User.html#a83a705ec9f27426c7e5315e26d136770">is_soft_delete_expired</a>(?<span class="keywordtype">string</span> $deleted_at): array</div>
<div class="line"><a id="l03361" name="l03361"></a><span class="lineno"> 3361</span>    {</div>
<div class="line"><a id="l03362" name="l03362"></a><span class="lineno"> 3362</span>        <span class="keywordflow">return</span> $this-&gt;<a class="code hl_function" href="../../df/dfe/classPhotoRigma_1_1Classes_1_1User.html#ae7bbb3d70503c2c3ab7de0e44bf83798">_is_soft_delete_expired_internal</a>($deleted_at);</div>
<div class="line"><a id="l03363" name="l03363"></a><span class="lineno"> 3363</span>    }</div>
</div>
<div class="line"><a id="l03364" name="l03364"></a><span class="lineno"> 3364</span></div>
<div class="foldopen" id="foldopen03412" data-start="{" data-end="}">
<div class="line"><a id="l03412" name="l03412"></a><span class="lineno"><a class="line" href="../../df/dfe/classPhotoRigma_1_1Classes_1_1User.html#ae7bbb3d70503c2c3ab7de0e44bf83798"> 3412</a></span>    <span class="keyword">protected</span> <span class="keyword">function</span> <a class="code hl_function" href="../../df/dfe/classPhotoRigma_1_1Classes_1_1User.html#ae7bbb3d70503c2c3ab7de0e44bf83798">_is_soft_delete_expired_internal</a>(?<span class="keywordtype">string</span> $deleted_at): array</div>
<div class="line"><a id="l03413" name="l03413"></a><span class="lineno"> 3413</span>    {</div>
<div class="line"><a id="l03414" name="l03414"></a><span class="lineno"> 3414</span>        <span class="keywordflow">if</span> (empty($deleted_at)) {</div>
<div class="line"><a id="l03415" name="l03415"></a><span class="lineno"> 3415</span>            <span class="keywordflow">return</span> [</div>
<div class="line"><a id="l03416" name="l03416"></a><span class="lineno"> 3416</span>                <span class="stringliteral">&#39;restore_date&#39;</span>   =&gt; <span class="keyword">null</span>,</div>
<div class="line"><a id="l03417" name="l03417"></a><span class="lineno"> 3417</span>                <span class="stringliteral">&#39;restore_expiry&#39;</span> =&gt; <span class="keyword">null</span>,</div>
<div class="line"><a id="l03418" name="l03418"></a><span class="lineno"> 3418</span>                <span class="stringliteral">&#39;expired&#39;</span>        =&gt; <span class="keyword">false</span>,</div>
<div class="line"><a id="l03419" name="l03419"></a><span class="lineno"> 3419</span>            ];</div>
<div class="line"><a id="l03420" name="l03420"></a><span class="lineno"> 3420</span>        }</div>
<div class="line"><a id="l03421" name="l03421"></a><span class="lineno"> 3421</span> </div>
<div class="line"><a id="l03422" name="l03422"></a><span class="lineno"> 3422</span>        <span class="keywordflow">try</span> {</div>
<div class="line"><a id="l03423" name="l03423"></a><span class="lineno"> 3423</span>            <span class="comment">// Парсим дату удаления</span></div>
<div class="line"><a id="l03424" name="l03424"></a><span class="lineno"> 3424</span>            $deleted_date = <span class="keyword">new</span> DateTime($deleted_at, <span class="keyword">new</span> DateTimeZone(<span class="stringliteral">&#39;UTC&#39;</span>));</div>
<div class="line"><a id="l03425" name="l03425"></a><span class="lineno"> 3425</span> </div>
<div class="line"><a id="l03426" name="l03426"></a><span class="lineno"> 3426</span>            <span class="comment">// Срок окончания восстановления</span></div>
<div class="line"><a id="l03427" name="l03427"></a><span class="lineno"> 3427</span>            $restore_expiry = clone $deleted_date;</div>
<div class="line"><a id="l03428" name="l03428"></a><span class="lineno"> 3428</span>            $restore_expiry-&gt;modify(<span class="charliteral">&#39;+&#39;</span> . SOFT_DELETE_RETENTION_INTERVAL);</div>
<div class="line"><a id="l03429" name="l03429"></a><span class="lineno"> 3429</span> </div>
<div class="line"><a id="l03430" name="l03430"></a><span class="lineno"> 3430</span>            <span class="comment">// Проверяем истечение срока</span></div>
<div class="line"><a id="l03431" name="l03431"></a><span class="lineno"> 3431</span>            $now = <span class="keyword">new</span> DateTime(<span class="stringliteral">&#39;now&#39;</span>, <span class="keyword">new</span> DateTimeZone($this-&gt;session[<span class="stringliteral">&#39;timezone&#39;</span>]));</div>
<div class="line"><a id="l03432" name="l03432"></a><span class="lineno"> 3432</span>            $expired = $restore_expiry &lt;= $now;</div>
<div class="line"><a id="l03433" name="l03433"></a><span class="lineno"> 3433</span> </div>
<div class="line"><a id="l03434" name="l03434"></a><span class="lineno"> 3434</span>            <span class="keywordflow">return</span> [</div>
<div class="line"><a id="l03435" name="l03435"></a><span class="lineno"> 3435</span>                <span class="stringliteral">&#39;restore_date&#39;</span>   =&gt; $deleted_date,</div>
<div class="line"><a id="l03436" name="l03436"></a><span class="lineno"> 3436</span>                <span class="stringliteral">&#39;restore_expiry&#39;</span> =&gt; $restore_expiry,</div>
<div class="line"><a id="l03437" name="l03437"></a><span class="lineno"> 3437</span>                <span class="stringliteral">&#39;expired&#39;</span>        =&gt; $expired</div>
<div class="line"><a id="l03438" name="l03438"></a><span class="lineno"> 3438</span>            ];</div>
<div class="line"><a id="l03439" name="l03439"></a><span class="lineno"> 3439</span> </div>
<div class="line"><a id="l03440" name="l03440"></a><span class="lineno"> 3440</span>        } <span class="keywordflow">catch</span> (Exception) {</div>
<div class="line"><a id="l03441" name="l03441"></a><span class="lineno"> 3441</span>            <span class="keywordflow">return</span> [</div>
<div class="line"><a id="l03442" name="l03442"></a><span class="lineno"> 3442</span>                <span class="stringliteral">&#39;restore_date&#39;</span>   =&gt; <span class="keyword">null</span>,</div>
<div class="line"><a id="l03443" name="l03443"></a><span class="lineno"> 3443</span>                <span class="stringliteral">&#39;restore_expiry&#39;</span> =&gt; <span class="keyword">null</span>,</div>
<div class="line"><a id="l03444" name="l03444"></a><span class="lineno"> 3444</span>                <span class="stringliteral">&#39;expired&#39;</span>        =&gt; false</div>
<div class="line"><a id="l03445" name="l03445"></a><span class="lineno"> 3445</span>            ];</div>
<div class="line"><a id="l03446" name="l03446"></a><span class="lineno"> 3446</span>        }</div>
<div class="line"><a id="l03447" name="l03447"></a><span class="lineno"> 3447</span>    }</div>
</div>
<div class="line"><a id="l03448" name="l03448"></a><span class="lineno"> 3448</span></div>
<div class="foldopen" id="foldopen03468" data-start="{" data-end="}">
<div class="line"><a id="l03468" name="l03468"></a><span class="lineno"><a class="line" href="../../df/dfe/classPhotoRigma_1_1Classes_1_1User.html#a9a102a9a5c4c289295b12acbac2f5302"> 3468</a></span>    <span class="keyword">private</span> <span class="keyword">function</span> <a class="code hl_function" href="../../df/dfe/classPhotoRigma_1_1Classes_1_1User.html#a9a102a9a5c4c289295b12acbac2f5302">_soft_delete</a>(<span class="keywordtype">int</span> $user_id): bool</div>
<div class="line"><a id="l03469" name="l03469"></a><span class="lineno"> 3469</span>    {</div>
<div class="line"><a id="l03470" name="l03470"></a><span class="lineno"> 3470</span>        <span class="comment">// Проверяем, не был ли пользователь уже окончательно удалён</span></div>
<div class="line"><a id="l03471" name="l03471"></a><span class="lineno"> 3471</span>        $this-&gt;db-&gt;select(<span class="stringliteral">&#39;`permanently_deleted`&#39;</span>, TBL_USERS, [</div>
<div class="line"><a id="l03472" name="l03472"></a><span class="lineno"> 3472</span>            <span class="stringliteral">&#39;where&#39;</span> =&gt; <span class="stringliteral">&#39;`id` = :id&#39;</span>,</div>
<div class="line"><a id="l03473" name="l03473"></a><span class="lineno"> 3473</span>            <span class="stringliteral">&#39;params&#39;</span> =&gt; [<span class="stringliteral">&#39;:id&#39;</span> =&gt; $user_id],</div>
<div class="line"><a id="l03474" name="l03474"></a><span class="lineno"> 3474</span>        ]);</div>
<div class="line"><a id="l03475" name="l03475"></a><span class="lineno"> 3475</span> </div>
<div class="line"><a id="l03476" name="l03476"></a><span class="lineno"> 3476</span>        $result = $this-&gt;db-&gt;result_row();</div>
<div class="line"><a id="l03477" name="l03477"></a><span class="lineno"> 3477</span>        <span class="keywordflow">if</span> ($result &amp;&amp; (<span class="keywordtype">int</span>)$result[<span class="stringliteral">&#39;permanently_deleted&#39;</span>] === 1) {</div>
<div class="line"><a id="l03478" name="l03478"></a><span class="lineno"> 3478</span>            log_in_file(</div>
<div class="line"><a id="l03479" name="l03479"></a><span class="lineno"> 3479</span>                __FILE__ . <span class="charliteral">&#39;:&#39;</span> . __LINE__ . <span class="stringliteral">&#39; (&#39;</span> . (__METHOD__ ?: __FUNCTION__ ?: <span class="stringliteral">&#39;global&#39;</span>) . <span class="stringliteral">&quot;) | Невозможно мягко удалить пользователя — аккаунт уже окончательно удалён | ID: $user_id&quot;</span></div>
<div class="line"><a id="l03480" name="l03480"></a><span class="lineno"> 3480</span>            );</div>
<div class="line"><a id="l03481" name="l03481"></a><span class="lineno"> 3481</span>            <span class="keywordflow">return</span> <span class="keyword">false</span>;</div>
<div class="line"><a id="l03482" name="l03482"></a><span class="lineno"> 3482</span>        }</div>
<div class="line"><a id="l03483" name="l03483"></a><span class="lineno"> 3483</span> </div>
<div class="line"><a id="l03484" name="l03484"></a><span class="lineno"> 3484</span>        <span class="comment">// Устанавливаем дату мягкого удаления</span></div>
<div class="line"><a id="l03485" name="l03485"></a><span class="lineno"> 3485</span>        <span class="keywordflow">if</span> (!$this-&gt;db-&gt;update(</div>
<div class="line"><a id="l03486" name="l03486"></a><span class="lineno"> 3486</span>            [<span class="stringliteral">&#39;`deleted_at`&#39;</span> =&gt; <span class="stringliteral">&#39;CURRENT_TIMESTAMP&#39;</span>],</div>
<div class="line"><a id="l03487" name="l03487"></a><span class="lineno"> 3487</span>            TBL_USERS,</div>
<div class="line"><a id="l03488" name="l03488"></a><span class="lineno"> 3488</span>            [<span class="stringliteral">&#39;where&#39;</span> =&gt; <span class="stringliteral">&#39;`id` = :id&#39;</span>, <span class="stringliteral">&#39;params&#39;</span> =&gt; [<span class="stringliteral">&#39;:id&#39;</span> =&gt; $user_id]]</div>
<div class="line"><a id="l03489" name="l03489"></a><span class="lineno"> 3489</span>        )) {</div>
<div class="line"><a id="l03490" name="l03490"></a><span class="lineno"> 3490</span>            log_in_file(</div>
<div class="line"><a id="l03491" name="l03491"></a><span class="lineno"> 3491</span>                __FILE__ . <span class="charliteral">&#39;:&#39;</span> . __LINE__ . <span class="stringliteral">&#39; (&#39;</span> . (__METHOD__ ?: __FUNCTION__ ?: <span class="stringliteral">&#39;global&#39;</span>) . <span class="stringliteral">&quot;) | Не удалось установить флаг deleted_at для пользователя | ID: $user_id&quot;</span></div>
<div class="line"><a id="l03492" name="l03492"></a><span class="lineno"> 3492</span>            );</div>
<div class="line"><a id="l03493" name="l03493"></a><span class="lineno"> 3493</span>            <span class="keywordflow">return</span> <span class="keyword">false</span>;</div>
<div class="line"><a id="l03494" name="l03494"></a><span class="lineno"> 3494</span>        }</div>
<div class="line"><a id="l03495" name="l03495"></a><span class="lineno"> 3495</span> </div>
<div class="line"><a id="l03496" name="l03496"></a><span class="lineno"> 3496</span>        $rows = $this-&gt;db-&gt;get_affected_rows();</div>
<div class="line"><a id="l03497" name="l03497"></a><span class="lineno"> 3497</span> </div>
<div class="line"><a id="l03498" name="l03498"></a><span class="lineno"> 3498</span>        <span class="keywordflow">if</span> ($rows &gt; 0) {</div>
<div class="line"><a id="l03499" name="l03499"></a><span class="lineno"> 3499</span>            log_in_file(</div>
<div class="line"><a id="l03500" name="l03500"></a><span class="lineno"> 3500</span>                __FILE__ . <span class="charliteral">&#39;:&#39;</span> . __LINE__ . <span class="stringliteral">&#39; (&#39;</span> . (__METHOD__ ?: __FUNCTION__ ?: <span class="stringliteral">&#39;global&#39;</span>) . <span class="stringliteral">&quot;) | Аккаунт пользователя временно удален | ID: $user_id&quot;</span></div>
<div class="line"><a id="l03501" name="l03501"></a><span class="lineno"> 3501</span>            );</div>
<div class="line"><a id="l03502" name="l03502"></a><span class="lineno"> 3502</span>            <span class="keywordflow">return</span> <span class="keyword">true</span>;</div>
<div class="line"><a id="l03503" name="l03503"></a><span class="lineno"> 3503</span>        }</div>
<div class="line"><a id="l03504" name="l03504"></a><span class="lineno"> 3504</span> </div>
<div class="line"><a id="l03505" name="l03505"></a><span class="lineno"> 3505</span>        log_in_file(</div>
<div class="line"><a id="l03506" name="l03506"></a><span class="lineno"> 3506</span>            __FILE__ . <span class="charliteral">&#39;:&#39;</span> . __LINE__ . <span class="stringliteral">&#39; (&#39;</span> . (__METHOD__ ?: __FUNCTION__ ?: <span class="stringliteral">&#39;global&#39;</span>) . <span class="stringliteral">&quot;) | Не удалось выполнить мягкое удаление | ID: $user_id&quot;</span></div>
<div class="line"><a id="l03507" name="l03507"></a><span class="lineno"> 3507</span>        );</div>
<div class="line"><a id="l03508" name="l03508"></a><span class="lineno"> 3508</span> </div>
<div class="line"><a id="l03509" name="l03509"></a><span class="lineno"> 3509</span>        <span class="keywordflow">return</span> <span class="keyword">false</span>;</div>
<div class="line"><a id="l03510" name="l03510"></a><span class="lineno"> 3510</span>    }</div>
</div>
<div class="line"><a id="l03511" name="l03511"></a><span class="lineno"> 3511</span></div>
<div class="foldopen" id="foldopen03558" data-start="{" data-end="}">
<div class="line"><a id="l03558" name="l03558"></a><span class="lineno"><a class="line" href="../../df/dfe/classPhotoRigma_1_1Classes_1_1User.html#ae5495df50f19c5657eccf4d313bbc98c"> 3558</a></span>    <span class="keyword">public</span> <span class="keyword">function</span> <a class="code hl_function" href="../../df/dfe/classPhotoRigma_1_1Classes_1_1User.html#ae5495df50f19c5657eccf4d313bbc98c">hard_delete_user</a>(<span class="keywordtype">int</span> $user_id, <span class="keywordtype">bool</span> $force = <span class="keyword">false</span>): bool</div>
<div class="line"><a id="l03559" name="l03559"></a><span class="lineno"> 3559</span>    {</div>
<div class="line"><a id="l03560" name="l03560"></a><span class="lineno"> 3560</span>        <span class="keywordflow">return</span> $this-&gt;<a class="code hl_function" href="../../df/dfe/classPhotoRigma_1_1Classes_1_1User.html#ac4c1020c1604de75d27c31dbe77e2fb7">_hard_delete_user_internal</a>($user_id, $force);</div>
<div class="line"><a id="l03561" name="l03561"></a><span class="lineno"> 3561</span>    }</div>
</div>
<div class="line"><a id="l03562" name="l03562"></a><span class="lineno"> 3562</span></div>
<div class="foldopen" id="foldopen03601" data-start="{" data-end="}">
<div class="line"><a id="l03601" name="l03601"></a><span class="lineno"><a class="line" href="../../df/dfe/classPhotoRigma_1_1Classes_1_1User.html#ac4c1020c1604de75d27c31dbe77e2fb7"> 3601</a></span>    <span class="keyword">protected</span> <span class="keyword">function</span> <a class="code hl_function" href="../../df/dfe/classPhotoRigma_1_1Classes_1_1User.html#ac4c1020c1604de75d27c31dbe77e2fb7">_hard_delete_user_internal</a>(<span class="keywordtype">int</span> $user_id, <span class="keywordtype">bool</span> $force = <span class="keyword">false</span>): bool</div>
<div class="line"><a id="l03602" name="l03602"></a><span class="lineno"> 3602</span>    {</div>
<div class="line"><a id="l03603" name="l03603"></a><span class="lineno"> 3603</span>        <span class="comment">// 1. Получаем данные пользователя</span></div>
<div class="line"><a id="l03604" name="l03604"></a><span class="lineno"> 3604</span>        $this-&gt;db-&gt;select(</div>
<div class="line"><a id="l03605" name="l03605"></a><span class="lineno"> 3605</span>            [<span class="stringliteral">&#39;`id`&#39;</span>, <span class="stringliteral">&#39;`group_id`&#39;</span>, <span class="stringliteral">&#39;`deleted_at`&#39;</span>, <span class="stringliteral">&#39;`permanently_deleted`&#39;</span>, <span class="stringliteral">&#39;`email`&#39;</span>, <span class="stringliteral">&#39;`real_name`&#39;</span>, <span class="stringliteral">&#39;`login`&#39;</span>, <span class="stringliteral">&#39;`avatar`&#39;</span>],</div>
<div class="line"><a id="l03606" name="l03606"></a><span class="lineno"> 3606</span>            TBL_USERS,</div>
<div class="line"><a id="l03607" name="l03607"></a><span class="lineno"> 3607</span>            [<span class="stringliteral">&#39;where&#39;</span> =&gt; <span class="stringliteral">&#39;`id` = :id&#39;</span>, <span class="stringliteral">&#39;params&#39;</span> =&gt; [<span class="stringliteral">&#39;:id&#39;</span> =&gt; $user_id]]</div>
<div class="line"><a id="l03608" name="l03608"></a><span class="lineno"> 3608</span>        );</div>
<div class="line"><a id="l03609" name="l03609"></a><span class="lineno"> 3609</span>        $user_data = $this-&gt;db-&gt;result_row();</div>
<div class="line"><a id="l03610" name="l03610"></a><span class="lineno"> 3610</span> </div>
<div class="line"><a id="l03611" name="l03611"></a><span class="lineno"> 3611</span>        <span class="keywordflow">if</span> (!$user_data) {</div>
<div class="line"><a id="l03612" name="l03612"></a><span class="lineno"> 3612</span>            log_in_file(</div>
<div class="line"><a id="l03613" name="l03613"></a><span class="lineno"> 3613</span>                __FILE__ . <span class="charliteral">&#39;:&#39;</span> . __LINE__ . <span class="stringliteral">&#39; (&#39;</span> . (__METHOD__ ?: __FUNCTION__ ?: <span class="stringliteral">&#39;global&#39;</span>) . <span class="stringliteral">&quot;) | Пользователь с ID $user_id не найден&quot;</span></div>
<div class="line"><a id="l03614" name="l03614"></a><span class="lineno"> 3614</span>            );</div>
<div class="line"><a id="l03615" name="l03615"></a><span class="lineno"> 3615</span>            <span class="keywordflow">return</span> <span class="keyword">false</span>;</div>
<div class="line"><a id="l03616" name="l03616"></a><span class="lineno"> 3616</span>        }</div>
<div class="line"><a id="l03617" name="l03617"></a><span class="lineno"> 3617</span> </div>
<div class="line"><a id="l03618" name="l03618"></a><span class="lineno"> 3618</span>        <span class="comment">// 2. Проверяем, уже ли помечен как окончательно удалённый</span></div>
<div class="line"><a id="l03619" name="l03619"></a><span class="lineno"> 3619</span>        <span class="keywordflow">if</span> ((<span class="keywordtype">int</span>)$user_data[<span class="stringliteral">&#39;permanently_deleted&#39;</span>] === 1) {</div>
<div class="line"><a id="l03620" name="l03620"></a><span class="lineno"> 3620</span>            log_in_file(</div>
<div class="line"><a id="l03621" name="l03621"></a><span class="lineno"> 3621</span>                __FILE__ . <span class="charliteral">&#39;:&#39;</span> . __LINE__ . <span class="stringliteral">&#39; (&#39;</span> . (__METHOD__ ?: __FUNCTION__ ?: <span class="stringliteral">&#39;global&#39;</span>) . <span class="stringliteral">&quot;) | Пользователь уже окончательно удалён | ID: $user_id&quot;</span></div>
<div class="line"><a id="l03622" name="l03622"></a><span class="lineno"> 3622</span>            );</div>
<div class="line"><a id="l03623" name="l03623"></a><span class="lineno"> 3623</span>            <span class="keywordflow">return</span> <span class="keyword">true</span>;</div>
<div class="line"><a id="l03624" name="l03624"></a><span class="lineno"> 3624</span>        }</div>
<div class="line"><a id="l03625" name="l03625"></a><span class="lineno"> 3625</span> </div>
<div class="line"><a id="l03626" name="l03626"></a><span class="lineno"> 3626</span>        <span class="comment">// 3. Если НЕ force — проверяем срок мягкого удаления</span></div>
<div class="line"><a id="l03627" name="l03627"></a><span class="lineno"> 3627</span>        <span class="keywordflow">if</span> (!$force) {</div>
<div class="line"><a id="l03628" name="l03628"></a><span class="lineno"> 3628</span>            <span class="keywordflow">if</span> (empty($user_data[<span class="stringliteral">&#39;deleted_at&#39;</span>])) {</div>
<div class="line"><a id="l03629" name="l03629"></a><span class="lineno"> 3629</span>                log_in_file(</div>
<div class="line"><a id="l03630" name="l03630"></a><span class="lineno"> 3630</span>                    __FILE__ . <span class="charliteral">&#39;:&#39;</span> . __LINE__ . <span class="stringliteral">&#39; (&#39;</span> . (__METHOD__ ?: __FUNCTION__ ?: <span class="stringliteral">&#39;global&#39;</span>) . <span class="stringliteral">&quot;) | Пользователь не был мягко удалён | ID: $user_id&quot;</span></div>
<div class="line"><a id="l03631" name="l03631"></a><span class="lineno"> 3631</span>                );</div>
<div class="line"><a id="l03632" name="l03632"></a><span class="lineno"> 3632</span>                <span class="keywordflow">return</span> <span class="keyword">false</span>;</div>
<div class="line"><a id="l03633" name="l03633"></a><span class="lineno"> 3633</span>            }</div>
<div class="line"><a id="l03634" name="l03634"></a><span class="lineno"> 3634</span> </div>
<div class="line"><a id="l03635" name="l03635"></a><span class="lineno"> 3635</span>            <span class="keywordflow">if</span> (!$this-&gt;<a class="code hl_function" href="../../df/dfe/classPhotoRigma_1_1Classes_1_1User.html#ae7bbb3d70503c2c3ab7de0e44bf83798">_is_soft_delete_expired_internal</a>($user_data[<span class="stringliteral">&#39;deleted_at&#39;</span>])[<span class="stringliteral">&#39;expired&#39;</span>]) {</div>
<div class="line"><a id="l03636" name="l03636"></a><span class="lineno"> 3636</span>                log_in_file(</div>
<div class="line"><a id="l03637" name="l03637"></a><span class="lineno"> 3637</span>                    __FILE__ . <span class="charliteral">&#39;:&#39;</span> . __LINE__ . <span class="stringliteral">&#39; (&#39;</span> . (__METHOD__ ?: __FUNCTION__ ?: <span class="stringliteral">&#39;global&#39;</span>) . <span class="stringliteral">&quot;) | Срок мягкого удаления ещё не истёк | ID: $user_id&quot;</span></div>
<div class="line"><a id="l03638" name="l03638"></a><span class="lineno"> 3638</span>                );</div>
<div class="line"><a id="l03639" name="l03639"></a><span class="lineno"> 3639</span>                <span class="keywordflow">return</span> <span class="keyword">false</span>;</div>
<div class="line"><a id="l03640" name="l03640"></a><span class="lineno"> 3640</span>            }</div>
<div class="line"><a id="l03641" name="l03641"></a><span class="lineno"> 3641</span>        }</div>
<div class="line"><a id="l03642" name="l03642"></a><span class="lineno"> 3642</span> </div>
<div class="line"><a id="l03643" name="l03643"></a><span class="lineno"> 3643</span>        <span class="comment">// 4. Если force = TRUE → проверяем права админа</span></div>
<div class="line"><a id="l03644" name="l03644"></a><span class="lineno"> 3644</span>        <span class="keywordflow">if</span> ($force) {</div>
<div class="line"><a id="l03645" name="l03645"></a><span class="lineno"> 3645</span>            <span class="comment">// Проверяем, является ли текущий пользователь админом</span></div>
<div class="line"><a id="l03646" name="l03646"></a><span class="lineno"> 3646</span>            <span class="keywordflow">if</span> (!$this-&gt;user[<span class="stringliteral">&#39;admin&#39;</span>]) {</div>
<div class="line"><a id="l03647" name="l03647"></a><span class="lineno"> 3647</span>                log_in_file(</div>
<div class="line"><a id="l03648" name="l03648"></a><span class="lineno"> 3648</span>                    __FILE__ . <span class="charliteral">&#39;:&#39;</span> . __LINE__ . <span class="stringliteral">&#39; (&#39;</span> . (__METHOD__ ?: __FUNCTION__ ?: <span class="stringliteral">&#39;global&#39;</span>) . <span class="stringliteral">&quot;) | Текущий пользователь не администратор | ID: $user_id&quot;</span></div>
<div class="line"><a id="l03649" name="l03649"></a><span class="lineno"> 3649</span>                );</div>
<div class="line"><a id="l03650" name="l03650"></a><span class="lineno"> 3650</span>                <span class="keywordflow">return</span> <span class="keyword">false</span>;</div>
<div class="line"><a id="l03651" name="l03651"></a><span class="lineno"> 3651</span>            }</div>
<div class="line"><a id="l03652" name="l03652"></a><span class="lineno"> 3652</span> </div>
<div class="line"><a id="l03653" name="l03653"></a><span class="lineno"> 3653</span>            <span class="comment">// Проверяем, что админ подтвердил сессию</span></div>
<div class="line"><a id="l03654" name="l03654"></a><span class="lineno"> 3654</span>            <span class="keywordflow">if</span> (!$this-&gt;session[<span class="stringliteral">&#39;admin_on&#39;</span>]) {</div>
<div class="line"><a id="l03655" name="l03655"></a><span class="lineno"> 3655</span>                log_in_file(</div>
<div class="line"><a id="l03656" name="l03656"></a><span class="lineno"> 3656</span>                    __FILE__ . <span class="charliteral">&#39;:&#39;</span> . __LINE__ . <span class="stringliteral">&#39; (&#39;</span> . (__METHOD__ ?: __FUNCTION__ ?: <span class="stringliteral">&#39;global&#39;</span>) . <span class="stringliteral">&quot;) | Админ не подтвердил сессию | ID: $user_id&quot;</span></div>
<div class="line"><a id="l03657" name="l03657"></a><span class="lineno"> 3657</span>                );</div>
<div class="line"><a id="l03658" name="l03658"></a><span class="lineno"> 3658</span>                <span class="keywordflow">return</span> <span class="keyword">false</span>;</div>
<div class="line"><a id="l03659" name="l03659"></a><span class="lineno"> 3659</span>            }</div>
<div class="line"><a id="l03660" name="l03660"></a><span class="lineno"> 3660</span> </div>
<div class="line"><a id="l03661" name="l03661"></a><span class="lineno"> 3661</span>            <span class="comment">// Проверяем, не пытается ли админ удалить сам себя</span></div>
<div class="line"><a id="l03662" name="l03662"></a><span class="lineno"> 3662</span>            <span class="keywordflow">if</span> ((<span class="keywordtype">int</span>)$user_data[<span class="stringliteral">&#39;id&#39;</span>] === $this-&gt;user[<span class="stringliteral">&#39;id&#39;</span>]) {</div>
<div class="line"><a id="l03663" name="l03663"></a><span class="lineno"> 3663</span>                log_in_file(</div>
<div class="line"><a id="l03664" name="l03664"></a><span class="lineno"> 3664</span>                    __FILE__ . <span class="charliteral">&#39;:&#39;</span> . __LINE__ . <span class="stringliteral">&#39; (&#39;</span> . (__METHOD__ ?: __FUNCTION__ ?: <span class="stringliteral">&#39;global&#39;</span>) . <span class="stringliteral">&quot;) | Админ не может удалить сам себя | ID: $user_id&quot;</span></div>
<div class="line"><a id="l03665" name="l03665"></a><span class="lineno"> 3665</span>                );</div>
<div class="line"><a id="l03666" name="l03666"></a><span class="lineno"> 3666</span>                <span class="keywordflow">return</span> <span class="keyword">false</span>;</div>
<div class="line"><a id="l03667" name="l03667"></a><span class="lineno"> 3667</span>            }</div>
<div class="line"><a id="l03668" name="l03668"></a><span class="lineno"> 3668</span>        }</div>
<div class="line"><a id="l03669" name="l03669"></a><span class="lineno"> 3669</span> </div>
<div class="line"><a id="l03670" name="l03670"></a><span class="lineno"> 3670</span>        <span class="comment">// 5. Проверяем, не последний ли это админ</span></div>
<div class="line"><a id="l03671" name="l03671"></a><span class="lineno"> 3671</span>        <span class="keywordflow">if</span> ((<span class="keywordtype">int</span>)$user_data[<span class="stringliteral">&#39;group_id&#39;</span>] === GROUP_ADMIN) {</div>
<div class="line"><a id="l03672" name="l03672"></a><span class="lineno"> 3672</span>            $this-&gt;db-&gt;select(<span class="stringliteral">&#39;COUNT(*) AS cnt&#39;</span>, TBL_USERS, [</div>
<div class="line"><a id="l03673" name="l03673"></a><span class="lineno"> 3673</span>                <span class="stringliteral">&#39;where&#39;</span>  =&gt; <span class="stringliteral">&#39;`group_id` = :group AND `id` != :exclude_id AND `permanently_deleted` = 0&#39;</span>,</div>
<div class="line"><a id="l03674" name="l03674"></a><span class="lineno"> 3674</span>                <span class="stringliteral">&#39;params&#39;</span> =&gt; [</div>
<div class="line"><a id="l03675" name="l03675"></a><span class="lineno"> 3675</span>                    <span class="stringliteral">&#39;:group&#39;</span>      =&gt; GROUP_ADMIN,</div>
<div class="line"><a id="l03676" name="l03676"></a><span class="lineno"> 3676</span>                    <span class="stringliteral">&#39;:exclude_id&#39;</span> =&gt; $user_id,</div>
<div class="line"><a id="l03677" name="l03677"></a><span class="lineno"> 3677</span>                ],</div>
<div class="line"><a id="l03678" name="l03678"></a><span class="lineno"> 3678</span>            ]);</div>
<div class="line"><a id="l03679" name="l03679"></a><span class="lineno"> 3679</span>            $count_result = $this-&gt;db-&gt;result_row();</div>
<div class="line"><a id="l03680" name="l03680"></a><span class="lineno"> 3680</span>            $admin_count = (int)$count_result[<span class="stringliteral">&#39;cnt&#39;</span>];</div>
<div class="line"><a id="l03681" name="l03681"></a><span class="lineno"> 3681</span> </div>
<div class="line"><a id="l03682" name="l03682"></a><span class="lineno"> 3682</span>            <span class="keywordflow">if</span> ($admin_count &lt;= 0) {</div>
<div class="line"><a id="l03683" name="l03683"></a><span class="lineno"> 3683</span>                log_in_file(</div>
<div class="line"><a id="l03684" name="l03684"></a><span class="lineno"> 3684</span>                    __FILE__ . <span class="charliteral">&#39;:&#39;</span> . __LINE__ . <span class="stringliteral">&#39; (&#39;</span> . (__METHOD__ ?: __FUNCTION__ ?: <span class="stringliteral">&#39;global&#39;</span>) . <span class="stringliteral">&quot;) | Невозможно удалить последнего админа | ID: $user_id&quot;</span></div>
<div class="line"><a id="l03685" name="l03685"></a><span class="lineno"> 3685</span>                );</div>
<div class="line"><a id="l03686" name="l03686"></a><span class="lineno"> 3686</span>                <span class="keywordflow">return</span> <span class="keyword">false</span>;</div>
<div class="line"><a id="l03687" name="l03687"></a><span class="lineno"> 3687</span>            }</div>
<div class="line"><a id="l03688" name="l03688"></a><span class="lineno"> 3688</span>        }</div>
<div class="line"><a id="l03689" name="l03689"></a><span class="lineno"> 3689</span> </div>
<div class="line"><a id="l03690" name="l03690"></a><span class="lineno"> 3690</span>        <span class="comment">// 6. Удаляем личный контент</span></div>
<div class="line"><a id="l03691" name="l03691"></a><span class="lineno"> 3691</span>        <span class="keywordflow">if</span> (!$this-&gt;<a class="code hl_function" href="../../df/dfe/classPhotoRigma_1_1Classes_1_1User.html#acaafe0adac99eb3c3223a78198854401">_delete_personal_content</a>($user_id)) {</div>
<div class="line"><a id="l03692" name="l03692"></a><span class="lineno"> 3692</span>            log_in_file(</div>
<div class="line"><a id="l03693" name="l03693"></a><span class="lineno"> 3693</span>                __FILE__ . <span class="charliteral">&#39;:&#39;</span> . __LINE__ . <span class="stringliteral">&#39; (&#39;</span> . (__METHOD__ ?: __FUNCTION__ ?: <span class="stringliteral">&#39;global&#39;</span>) . <span class="stringliteral">&quot;) | Не удалось удалить личный контент пользователя | ID: $user_id&quot;</span></div>
<div class="line"><a id="l03694" name="l03694"></a><span class="lineno"> 3694</span>            );</div>
<div class="line"><a id="l03695" name="l03695"></a><span class="lineno"> 3695</span>            <span class="keywordflow">return</span> <span class="keyword">false</span>;</div>
<div class="line"><a id="l03696" name="l03696"></a><span class="lineno"> 3696</span>        }</div>
<div class="line"><a id="l03697" name="l03697"></a><span class="lineno"> 3697</span> </div>
<div class="line"><a id="l03698" name="l03698"></a><span class="lineno"> 3698</span>        <span class="comment">// 7. Генерируем обезличенные данные</span></div>
<div class="line"><a id="l03699" name="l03699"></a><span class="lineno"> 3699</span>        $anonymized_login = <span class="stringliteral">&quot;deleted_$user_id&quot;</span>;</div>
<div class="line"><a id="l03700" name="l03700"></a><span class="lineno"> 3700</span>        $anonymized_email = <span class="stringliteral">&quot;deleted_$user_id@local.com&quot;</span>;</div>
<div class="line"><a id="l03701" name="l03701"></a><span class="lineno"> 3701</span>        $delete_token = substr(basename(tempnam(sys_get_temp_dir(), <span class="stringliteral">&#39;del_&#39;</span>)), 0, 20);</div>
<div class="line"><a id="l03702" name="l03702"></a><span class="lineno"> 3702</span> </div>
<div class="line"><a id="l03703" name="l03703"></a><span class="lineno"> 3703</span>        <span class="comment">// 8. Обезличиваем запись пользователя</span></div>
<div class="line"><a id="l03704" name="l03704"></a><span class="lineno"> 3704</span>        $this-&gt;db-&gt;update(</div>
<div class="line"><a id="l03705" name="l03705"></a><span class="lineno"> 3705</span>            [</div>
<div class="line"><a id="l03706" name="l03706"></a><span class="lineno"> 3706</span>                <span class="stringliteral">&#39;`email`&#39;</span>               =&gt; <span class="stringliteral">&#39;:email&#39;</span>,</div>
<div class="line"><a id="l03707" name="l03707"></a><span class="lineno"> 3707</span>                <span class="stringliteral">&#39;`login`&#39;</span>               =&gt; <span class="stringliteral">&#39;:login&#39;</span>,</div>
<div class="line"><a id="l03708" name="l03708"></a><span class="lineno"> 3708</span>                <span class="stringliteral">&#39;`password`&#39;</span>            =&gt; <span class="stringliteral">&#39;:password&#39;</span>,</div>
<div class="line"><a id="l03709" name="l03709"></a><span class="lineno"> 3709</span>                <span class="stringliteral">&#39;`avatar`&#39;</span>              =&gt; <span class="stringliteral">&#39;:avatar&#39;</span>,</div>
<div class="line"><a id="l03710" name="l03710"></a><span class="lineno"> 3710</span>                <span class="stringliteral">&#39;`permanently_deleted`&#39;</span> =&gt; <span class="charliteral">&#39;1&#39;</span>,</div>
<div class="line"><a id="l03711" name="l03711"></a><span class="lineno"> 3711</span>            ],</div>
<div class="line"><a id="l03712" name="l03712"></a><span class="lineno"> 3712</span>            TBL_USERS,</div>
<div class="line"><a id="l03713" name="l03713"></a><span class="lineno"> 3713</span>            [</div>
<div class="line"><a id="l03714" name="l03714"></a><span class="lineno"> 3714</span>                <span class="stringliteral">&#39;where&#39;</span>  =&gt; <span class="stringliteral">&#39;`id` = :id&#39;</span>,</div>
<div class="line"><a id="l03715" name="l03715"></a><span class="lineno"> 3715</span>                <span class="stringliteral">&#39;params&#39;</span> =&gt; [</div>
<div class="line"><a id="l03716" name="l03716"></a><span class="lineno"> 3716</span>                    <span class="stringliteral">&#39;:id&#39;</span>       =&gt; $user_id,</div>
<div class="line"><a id="l03717" name="l03717"></a><span class="lineno"> 3717</span>                    <span class="stringliteral">&#39;:login&#39;</span>    =&gt; $anonymized_login,</div>
<div class="line"><a id="l03718" name="l03718"></a><span class="lineno"> 3718</span>                    <span class="stringliteral">&#39;:email&#39;</span>    =&gt; $anonymized_email,</div>
<div class="line"><a id="l03719" name="l03719"></a><span class="lineno"> 3719</span>                    <span class="stringliteral">&#39;:password&#39;</span> =&gt; $delete_token,</div>
<div class="line"><a id="l03720" name="l03720"></a><span class="lineno"> 3720</span>                    <span class="stringliteral">&#39;:avatar&#39;</span>   =&gt; DEFAULT_AVATAR,</div>
<div class="line"><a id="l03721" name="l03721"></a><span class="lineno"> 3721</span>                ],</div>
<div class="line"><a id="l03722" name="l03722"></a><span class="lineno"> 3722</span>            ]</div>
<div class="line"><a id="l03723" name="l03723"></a><span class="lineno"> 3723</span>        );</div>
<div class="line"><a id="l03724" name="l03724"></a><span class="lineno"> 3724</span> </div>
<div class="line"><a id="l03725" name="l03725"></a><span class="lineno"> 3725</span>        <span class="comment">// 9. Дополнительно проверяем, действительно ли обновилась запись</span></div>
<div class="line"><a id="l03726" name="l03726"></a><span class="lineno"> 3726</span>        $this-&gt;db-&gt;select(<span class="stringliteral">&#39;`email`, `login`, `password`, `avatar`, `permanently_deleted`&#39;</span>, TBL_USERS, [</div>
<div class="line"><a id="l03727" name="l03727"></a><span class="lineno"> 3727</span>            <span class="stringliteral">&#39;where&#39;</span>  =&gt; <span class="stringliteral">&#39;`id` = :id&#39;</span>,</div>
<div class="line"><a id="l03728" name="l03728"></a><span class="lineno"> 3728</span>            <span class="stringliteral">&#39;params&#39;</span> =&gt; [<span class="stringliteral">&#39;:id&#39;</span> =&gt; $user_id],</div>
<div class="line"><a id="l03729" name="l03729"></a><span class="lineno"> 3729</span>        ]);</div>
<div class="line"><a id="l03730" name="l03730"></a><span class="lineno"> 3730</span>        $updated_data = $this-&gt;db-&gt;result_row();</div>
<div class="line"><a id="l03731" name="l03731"></a><span class="lineno"> 3731</span> </div>
<div class="line"><a id="l03732" name="l03732"></a><span class="lineno"> 3732</span>        <span class="keywordflow">if</span> (</div>
<div class="line"><a id="l03733" name="l03733"></a><span class="lineno"> 3733</span>            $updated_data === <span class="keyword">false</span> ||</div>
<div class="line"><a id="l03734" name="l03734"></a><span class="lineno"> 3734</span>            $updated_data[<span class="stringliteral">&#39;email&#39;</span>] !== $anonymized_email ||</div>
<div class="line"><a id="l03735" name="l03735"></a><span class="lineno"> 3735</span>            $updated_data[<span class="stringliteral">&#39;login&#39;</span>] !== $anonymized_login ||</div>
<div class="line"><a id="l03736" name="l03736"></a><span class="lineno"> 3736</span>            $updated_data[<span class="stringliteral">&#39;password&#39;</span>] !== $delete_token ||</div>
<div class="line"><a id="l03737" name="l03737"></a><span class="lineno"> 3737</span>            $updated_data[<span class="stringliteral">&#39;avatar&#39;</span>] !== DEFAULT_AVATAR ||</div>
<div class="line"><a id="l03738" name="l03738"></a><span class="lineno"> 3738</span>            (<span class="keywordtype">int</span>)$updated_data[<span class="stringliteral">&#39;permanently_deleted&#39;</span>] !== 1</div>
<div class="line"><a id="l03739" name="l03739"></a><span class="lineno"> 3739</span>        ) {</div>
<div class="line"><a id="l03740" name="l03740"></a><span class="lineno"> 3740</span>            log_in_file(</div>
<div class="line"><a id="l03741" name="l03741"></a><span class="lineno"> 3741</span>                __FILE__ . <span class="charliteral">&#39;:&#39;</span> . __LINE__ . <span class="stringliteral">&#39; (&#39;</span> . (__METHOD__ ?: __FUNCTION__ ?: <span class="stringliteral">&#39;global&#39;</span>) . <span class="stringliteral">&quot;) | Не удалось подтвердить обезличивание пользователя | ID: $user_id&quot;</span></div>
<div class="line"><a id="l03742" name="l03742"></a><span class="lineno"> 3742</span>            );</div>
<div class="line"><a id="l03743" name="l03743"></a><span class="lineno"> 3743</span>            <span class="keywordflow">return</span> <span class="keyword">false</span>;</div>
<div class="line"><a id="l03744" name="l03744"></a><span class="lineno"> 3744</span>        }</div>
<div class="line"><a id="l03745" name="l03745"></a><span class="lineno"> 3745</span> </div>
<div class="line"><a id="l03746" name="l03746"></a><span class="lineno"> 3746</span>        <span class="comment">// 10. Логируем событие</span></div>
<div class="line"><a id="l03747" name="l03747"></a><span class="lineno"> 3747</span>        log_in_file(</div>
<div class="line"><a id="l03748" name="l03748"></a><span class="lineno"> 3748</span>            __FILE__ . <span class="charliteral">&#39;:&#39;</span> . __LINE__ . <span class="stringliteral">&#39; (&#39;</span> . (__METHOD__ ?: __FUNCTION__ ?: <span class="stringliteral">&#39;global&#39;</span>) . <span class="stringliteral">&quot;) | Аккаунт пользователя окончательно удален | ID: $user_id&quot;</span></div>
<div class="line"><a id="l03749" name="l03749"></a><span class="lineno"> 3749</span>        );</div>
<div class="line"><a id="l03750" name="l03750"></a><span class="lineno"> 3750</span> </div>
<div class="line"><a id="l03751" name="l03751"></a><span class="lineno"> 3751</span>        <span class="keywordflow">return</span> <span class="keyword">true</span>;</div>
<div class="line"><a id="l03752" name="l03752"></a><span class="lineno"> 3752</span>    }</div>
</div>
<div class="line"><a id="l03753" name="l03753"></a><span class="lineno"> 3753</span></div>
<div class="foldopen" id="foldopen03799" data-start="{" data-end="}">
<div class="line"><a id="l03799" name="l03799"></a><span class="lineno"><a class="line" href="../../df/dfe/classPhotoRigma_1_1Classes_1_1User.html#acaafe0adac99eb3c3223a78198854401"> 3799</a></span>    <span class="keyword">private</span> <span class="keyword">function</span> <a class="code hl_function" href="../../df/dfe/classPhotoRigma_1_1Classes_1_1User.html#acaafe0adac99eb3c3223a78198854401">_delete_personal_content</a>(<span class="keywordtype">int</span> $user_id): bool</div>
<div class="line"><a id="l03800" name="l03800"></a><span class="lineno"> 3800</span>    {</div>
<div class="line"><a id="l03801" name="l03801"></a><span class="lineno"> 3801</span>        <span class="comment">// 1. Получаем список личных фото</span></div>
<div class="line"><a id="l03802" name="l03802"></a><span class="lineno"> 3802</span>        $this-&gt;db-&gt;select(</div>
<div class="line"><a id="l03803" name="l03803"></a><span class="lineno"> 3803</span>            <span class="stringliteral">&#39;`id` AS photo_id&#39;</span>,</div>
<div class="line"><a id="l03804" name="l03804"></a><span class="lineno"> 3804</span>            TBL_PHOTO,</div>
<div class="line"><a id="l03805" name="l03805"></a><span class="lineno"> 3805</span>            [</div>
<div class="line"><a id="l03806" name="l03806"></a><span class="lineno"> 3806</span>                <span class="stringliteral">&#39;where&#39;</span> =&gt; <span class="stringliteral">&#39;`user_upload` = :user_id AND `category` = 0&#39;</span>,</div>
<div class="line"><a id="l03807" name="l03807"></a><span class="lineno"> 3807</span>                <span class="stringliteral">&#39;params&#39;</span> =&gt; [<span class="stringliteral">&#39;:user_id&#39;</span> =&gt; $user_id],</div>
<div class="line"><a id="l03808" name="l03808"></a><span class="lineno"> 3808</span>            ]</div>
<div class="line"><a id="l03809" name="l03809"></a><span class="lineno"> 3809</span>        );</div>
<div class="line"><a id="l03810" name="l03810"></a><span class="lineno"> 3810</span>        $photos = $this-&gt;db-&gt;result_array();</div>
<div class="line"><a id="l03811" name="l03811"></a><span class="lineno"> 3811</span> </div>
<div class="line"><a id="l03812" name="l03812"></a><span class="lineno"> 3812</span>        <span class="keywordflow">if</span> (!$photos) {</div>
<div class="line"><a id="l03813" name="l03813"></a><span class="lineno"> 3813</span>            <span class="keywordflow">return</span> <span class="keyword">true</span>; <span class="comment">// Нет фото → ничего не удалять</span></div>
<div class="line"><a id="l03814" name="l03814"></a><span class="lineno"> 3814</span>        }</div>
<div class="line"><a id="l03815" name="l03815"></a><span class="lineno"> 3815</span> </div>
<div class="line"><a id="l03816" name="l03816"></a><span class="lineno"> 3816</span>        $deleted_count = 0;</div>
<div class="line"><a id="l03817" name="l03817"></a><span class="lineno"> 3817</span> </div>
<div class="line"><a id="l03818" name="l03818"></a><span class="lineno"> 3818</span>        <span class="keywordflow">foreach</span> ($photos as $row) {</div>
<div class="line"><a id="l03819" name="l03819"></a><span class="lineno"> 3819</span>            $photo_id = (int)$row[<span class="stringliteral">&#39;photo_id&#39;</span>];</div>
<div class="line"><a id="l03820" name="l03820"></a><span class="lineno"> 3820</span> </div>
<div class="line"><a id="l03821" name="l03821"></a><span class="lineno"> 3821</span>            <span class="comment">// 2. Вызываем внешний метод удаления фото</span></div>
<div class="line"><a id="l03822" name="l03822"></a><span class="lineno"> 3822</span>            <span class="keywordflow">if</span> ($this-&gt;work-&gt;del_photo($photo_id)) {</div>
<div class="line"><a id="l03823" name="l03823"></a><span class="lineno"> 3823</span>                $deleted_count++;</div>
<div class="line"><a id="l03824" name="l03824"></a><span class="lineno"> 3824</span>            }</div>
<div class="line"><a id="l03825" name="l03825"></a><span class="lineno"> 3825</span>        }</div>
<div class="line"><a id="l03826" name="l03826"></a><span class="lineno"> 3826</span> </div>
<div class="line"><a id="l03827" name="l03827"></a><span class="lineno"> 3827</span>        <span class="comment">// 3. Логируем результат</span></div>
<div class="line"><a id="l03828" name="l03828"></a><span class="lineno"> 3828</span>        log_in_file(</div>
<div class="line"><a id="l03829" name="l03829"></a><span class="lineno"> 3829</span>            __FILE__ . <span class="charliteral">&#39;:&#39;</span> . __LINE__ . <span class="stringliteral">&#39; (&#39;</span> . (__METHOD__ ?: __FUNCTION__ ?: <span class="stringliteral">&#39;global&#39;</span>) . <span class="stringliteral">&quot;) | Успешно удален контент: $deleted_count шт. | Пользователь: $user_id&quot;</span></div>
<div class="line"><a id="l03830" name="l03830"></a><span class="lineno"> 3830</span>        );</div>
<div class="line"><a id="l03831" name="l03831"></a><span class="lineno"> 3831</span> </div>
<div class="line"><a id="l03832" name="l03832"></a><span class="lineno"> 3832</span>        <span class="keywordflow">return</span> <span class="keyword">true</span>;</div>
<div class="line"><a id="l03833" name="l03833"></a><span class="lineno"> 3833</span>    }</div>
</div>
<div class="line"><a id="l03834" name="l03834"></a><span class="lineno"> 3834</span></div>
<div class="foldopen" id="foldopen03867" data-start="{" data-end="}">
<div class="line"><a id="l03867" name="l03867"></a><span class="lineno"><a class="line" href="../../df/dfe/classPhotoRigma_1_1Classes_1_1User.html#af20ed50055d313a9cc9e78e7aace9d5d"> 3867</a></span>    <span class="keyword">public</span> <span class="keyword">function</span> <a class="code hl_function" href="../../df/dfe/classPhotoRigma_1_1Classes_1_1User.html#af20ed50055d313a9cc9e78e7aace9d5d">cron_user_delete</a>(): void</div>
<div class="line"><a id="l03868" name="l03868"></a><span class="lineno"> 3868</span>    {</div>
<div class="line"><a id="l03869" name="l03869"></a><span class="lineno"> 3869</span>        <span class="comment">// Защита от запуска через веб-интерфейс</span></div>
<div class="line"><a id="l03870" name="l03870"></a><span class="lineno"> 3870</span>        <span class="keywordflow">if</span> (PHP_SAPI !== <span class="stringliteral">&#39;cli&#39;</span>) {</div>
<div class="line"><a id="l03871" name="l03871"></a><span class="lineno"> 3871</span>            log_in_file(</div>
<div class="line"><a id="l03872" name="l03872"></a><span class="lineno"> 3872</span>                __FILE__ . <span class="charliteral">&#39;:&#39;</span> . __LINE__ . <span class="stringliteral">&#39; (&#39;</span> . (__METHOD__ ?: __FUNCTION__ ?: <span class="stringliteral">&#39;global&#39;</span>) . <span class="stringliteral">&#39;) | &#39;</span> .</div>
<div class="line"><a id="l03873" name="l03873"></a><span class="lineno"> 3873</span>                <span class="stringliteral">&#39;Запрещён запуск через веб | cron_user_delete()&#39;</span></div>
<div class="line"><a id="l03874" name="l03874"></a><span class="lineno"> 3874</span>            );</div>
<div class="line"><a id="l03875" name="l03875"></a><span class="lineno"> 3875</span>            exit(<span class="stringliteral">&#39;Доступ запрещён&#39;</span>);</div>
<div class="line"><a id="l03876" name="l03876"></a><span class="lineno"> 3876</span>        }</div>
<div class="line"><a id="l03877" name="l03877"></a><span class="lineno"> 3877</span> </div>
<div class="line"><a id="l03878" name="l03878"></a><span class="lineno"> 3878</span>        <span class="comment">// Запуск внутренней логики</span></div>
<div class="line"><a id="l03879" name="l03879"></a><span class="lineno"> 3879</span>        $this-&gt;<a class="code hl_function" href="../../df/dfe/classPhotoRigma_1_1Classes_1_1User.html#aafee1ee3b55febdd62f61df8a6d4ef01">_cron_user_delete_internal</a>();</div>
<div class="line"><a id="l03880" name="l03880"></a><span class="lineno"> 3880</span>    }</div>
</div>
<div class="line"><a id="l03881" name="l03881"></a><span class="lineno"> 3881</span></div>
<div class="foldopen" id="foldopen03925" data-start="{" data-end="}">
<div class="line"><a id="l03925" name="l03925"></a><span class="lineno"><a class="line" href="../../df/dfe/classPhotoRigma_1_1Classes_1_1User.html#aafee1ee3b55febdd62f61df8a6d4ef01"> 3925</a></span>    <span class="keyword">protected</span> <span class="keyword">function</span> <a class="code hl_function" href="../../df/dfe/classPhotoRigma_1_1Classes_1_1User.html#aafee1ee3b55febdd62f61df8a6d4ef01">_cron_user_delete_internal</a>(): void</div>
<div class="line"><a id="l03926" name="l03926"></a><span class="lineno"> 3926</span>    {</div>
<div class="line"><a id="l03927" name="l03927"></a><span class="lineno"> 3927</span>        <span class="comment">// 1. Получаем список пользователей на окончательное удаление</span></div>
<div class="line"><a id="l03928" name="l03928"></a><span class="lineno"> 3928</span>        $this-&gt;db-&gt;select(</div>
<div class="line"><a id="l03929" name="l03929"></a><span class="lineno"> 3929</span>            [<span class="stringliteral">&#39;`id`&#39;</span>, <span class="stringliteral">&#39;`deleted_at`&#39;</span>],</div>
<div class="line"><a id="l03930" name="l03930"></a><span class="lineno"> 3930</span>            TBL_USERS,</div>
<div class="line"><a id="l03931" name="l03931"></a><span class="lineno"> 3931</span>            [</div>
<div class="line"><a id="l03932" name="l03932"></a><span class="lineno"> 3932</span>                <span class="stringliteral">&#39;where&#39;</span> =&gt; <span class="stringliteral">&#39;`deleted_at` IS NOT NULL AND `permanently_deleted` = 0&#39;</span></div>
<div class="line"><a id="l03933" name="l03933"></a><span class="lineno"> 3933</span>            ]</div>
<div class="line"><a id="l03934" name="l03934"></a><span class="lineno"> 3934</span>        );</div>
<div class="line"><a id="l03935" name="l03935"></a><span class="lineno"> 3935</span>        $users = $this-&gt;db-&gt;result_array();</div>
<div class="line"><a id="l03936" name="l03936"></a><span class="lineno"> 3936</span> </div>
<div class="line"><a id="l03937" name="l03937"></a><span class="lineno"> 3937</span>        <span class="keywordflow">if</span> (!$users) {</div>
<div class="line"><a id="l03938" name="l03938"></a><span class="lineno"> 3938</span>            log_in_file(</div>
<div class="line"><a id="l03939" name="l03939"></a><span class="lineno"> 3939</span>                __FILE__ . <span class="charliteral">&#39;:&#39;</span> . __LINE__ . <span class="stringliteral">&#39; (&#39;</span> . (__METHOD__ ?: __FUNCTION__ ?: <span class="stringliteral">&#39;global&#39;</span>) . <span class="stringliteral">&#39;) | &#39;</span> .</div>
<div class="line"><a id="l03940" name="l03940"></a><span class="lineno"> 3940</span>                <span class="stringliteral">&#39;Нет пользователей к окончательному удалению&#39;</span></div>
<div class="line"><a id="l03941" name="l03941"></a><span class="lineno"> 3941</span>            );</div>
<div class="line"><a id="l03942" name="l03942"></a><span class="lineno"> 3942</span>            <span class="keywordflow">return</span>;</div>
<div class="line"><a id="l03943" name="l03943"></a><span class="lineno"> 3943</span>        }</div>
<div class="line"><a id="l03944" name="l03944"></a><span class="lineno"> 3944</span> </div>
<div class="line"><a id="l03945" name="l03945"></a><span class="lineno"> 3945</span>        <span class="keywordflow">foreach</span> ($users as <a class="code hl_variable" href="../../df/dfe/classPhotoRigma_1_1Classes_1_1User.html#a54301e4038f95a7b17247e0d674ff3d6">$user</a>) {</div>
<div class="line"><a id="l03946" name="l03946"></a><span class="lineno"> 3946</span>            $user_id = (int)<a class="code hl_variable" href="../../df/dfe/classPhotoRigma_1_1Classes_1_1User.html#a54301e4038f95a7b17247e0d674ff3d6">$user</a>[<span class="stringliteral">&#39;id&#39;</span>];</div>
<div class="line"><a id="l03947" name="l03947"></a><span class="lineno"> 3947</span> </div>
<div class="line"><a id="l03948" name="l03948"></a><span class="lineno"> 3948</span>            <span class="comment">// 2. Проверяем, истёк ли срок мягкого удаления</span></div>
<div class="line"><a id="l03949" name="l03949"></a><span class="lineno"> 3949</span>            <span class="keywordflow">if</span> (!$this-&gt;<a class="code hl_function" href="../../df/dfe/classPhotoRigma_1_1Classes_1_1User.html#ae7bbb3d70503c2c3ab7de0e44bf83798">_is_soft_delete_expired_internal</a>($user[<span class="stringliteral">&#39;deleted_at&#39;</span>])[<span class="stringliteral">&#39;expired&#39;</span>]) {</div>
<div class="line"><a id="l03950" name="l03950"></a><span class="lineno"> 3950</span>                <span class="keywordflow">continue</span>; <span class="comment">// Срок ещё не истёк</span></div>
<div class="line"><a id="l03951" name="l03951"></a><span class="lineno"> 3951</span>            }</div>
<div class="line"><a id="l03952" name="l03952"></a><span class="lineno"> 3952</span> </div>
<div class="line"><a id="l03953" name="l03953"></a><span class="lineno"> 3953</span>            <span class="comment">// 3. Вызываем окончательное удаление</span></div>
<div class="line"><a id="l03954" name="l03954"></a><span class="lineno"> 3954</span>            $this-&gt;<a class="code hl_function" href="../../df/dfe/classPhotoRigma_1_1Classes_1_1User.html#ac4c1020c1604de75d27c31dbe77e2fb7">_hard_delete_user_internal</a>($user_id);</div>
<div class="line"><a id="l03955" name="l03955"></a><span class="lineno"> 3955</span>        }</div>
<div class="line"><a id="l03956" name="l03956"></a><span class="lineno"> 3956</span> </div>
<div class="line"><a id="l03957" name="l03957"></a><span class="lineno"> 3957</span>        log_in_file(</div>
<div class="line"><a id="l03958" name="l03958"></a><span class="lineno"> 3958</span>            __FILE__ . <span class="charliteral">&#39;:&#39;</span> . __LINE__ . <span class="stringliteral">&#39; (&#39;</span> . (__METHOD__ ?: __FUNCTION__ ?: <span class="stringliteral">&#39;global&#39;</span>) . <span class="stringliteral">&#39;) | &#39;</span> .</div>
<div class="line"><a id="l03959" name="l03959"></a><span class="lineno"> 3959</span>            <span class="stringliteral">&#39;Фоновая задача окончательного удаления завершена&#39;</span></div>
<div class="line"><a id="l03960" name="l03960"></a><span class="lineno"> 3960</span>        );</div>
<div class="line"><a id="l03961" name="l03961"></a><span class="lineno"> 3961</span>    }</div>
</div>
<div class="line"><a id="l03962" name="l03962"></a><span class="lineno"> 3962</span>}</div>
</div>
<div class="ttc" id="aclassPhotoRigma_1_1Classes_1_1User_html"><div class="ttname"><a href="../../df/dfe/classPhotoRigma_1_1Classes_1_1User.html">PhotoRigma\Classes\User</a></div><div class="ttdoc">Класс для работы с пользователями и хранения данных о текущем пользователе.</div><div class="ttdef"><b>Определения</b> <a href="#l00108">User.php:109</a></div></div>
<div class="ttc" id="aclassPhotoRigma_1_1Classes_1_1User_html_a0524c883699d2510258de9ed3b7b3194"><div class="ttname"><a href="../../df/dfe/classPhotoRigma_1_1Classes_1_1User.html#a0524c883699d2510258de9ed3b7b3194">PhotoRigma\Classes\User\__construct</a></div><div class="ttdeci">__construct(Database_Interface $db, array &amp;$session)</div><div class="ttdoc">Конструктор класса.</div><div class="ttdef"><b>Определения</b> <a href="#l00167">User.php:167</a></div></div>
<div class="ttc" id="aclassPhotoRigma_1_1Classes_1_1User_html_a0acd7052f38245fd3723ea29c83bf3f3"><div class="ttname"><a href="../../df/dfe/classPhotoRigma_1_1Classes_1_1User.html#a0acd7052f38245fd3723ea29c83bf3f3">PhotoRigma\Classes\User\__get</a></div><div class="ttdeci">__get(string $name)</div><div class="ttdoc">Получает значение приватного свойства.</div><div class="ttdef"><b>Определения</b> <a href="#l01002">User.php:1002</a></div></div>
<div class="ttc" id="aclassPhotoRigma_1_1Classes_1_1User_html_a0bb4e25a2291e3792c181a821de0c88c"><div class="ttname"><a href="../../df/dfe/classPhotoRigma_1_1Classes_1_1User.html#a0bb4e25a2291e3792c181a821de0c88c">PhotoRigma\Classes\User\set_work</a></div><div class="ttdeci">set_work(Work_Interface $work)</div><div class="ttdoc">Устанавливает объект Work через вызов внутреннего метода.</div><div class="ttdef"><b>Определения</b> <a href="#l00894">User.php:894</a></div></div>
<div class="ttc" id="aclassPhotoRigma_1_1Classes_1_1User_html_a0c45daa80235f514090aa7789f5e93b3"><div class="ttname"><a href="../../df/dfe/classPhotoRigma_1_1Classes_1_1User.html#a0c45daa80235f514090aa7789f5e93b3">PhotoRigma\Classes\User\__isset</a></div><div class="ttdeci">__isset(string $name)</div><div class="ttdoc">Проверяет существование недоступного свойства.</div><div class="ttdef"><b>Определения</b> <a href="#l01135">User.php:1135</a></div></div>
<div class="ttc" id="aclassPhotoRigma_1_1Classes_1_1User_html_a0e0a242e5a2f6555e5f5dd0d4f9c52a4"><div class="ttname"><a href="../../df/dfe/classPhotoRigma_1_1Classes_1_1User.html#a0e0a242e5a2f6555e5f5dd0d4f9c52a4">PhotoRigma\Classes\User\_update_user_rights_internal</a></div><div class="ttdeci">_update_user_rights_internal(int $user_id, array $user_data, array $post_data)</div><div class="ttdoc">Обновляет права пользователя или группу через Админку.</div><div class="ttdef"><b>Определения</b> <a href="#l03229">User.php:3229</a></div></div>
<div class="ttc" id="aclassPhotoRigma_1_1Classes_1_1User_html_a0e838259fa4a4581be6a51e6ae8ab238"><div class="ttname"><a href="../../df/dfe/classPhotoRigma_1_1Classes_1_1User.html#a0e838259fa4a4581be6a51e6ae8ab238">PhotoRigma\Classes\User\_add_new_group_internal</a></div><div class="ttdeci">_add_new_group_internal(array $group_data)</div><div class="ttdoc">Добавляет новую группу в систему через Админку.</div><div class="ttdef"><b>Определения</b> <a href="#l01237">User.php:1237</a></div></div>
<div class="ttc" id="aclassPhotoRigma_1_1Classes_1_1User_html_a18e3eac65d39ced5231d9b3e3630ba75"><div class="ttname"><a href="../../df/dfe/classPhotoRigma_1_1Classes_1_1User.html#a18e3eac65d39ced5231d9b3e3630ba75">PhotoRigma\Classes\User\$db</a></div><div class="ttdeci">Database_Interface $db</div><div class="ttdoc">Объект для работы с базой данных.</div><div class="ttdef"><b>Определения</b> <a href="#l00112">User.php:112</a></div></div>
<div class="ttc" id="aclassPhotoRigma_1_1Classes_1_1User_html_a2308665ad82b46f7f73e34750887dbee"><div class="ttname"><a href="../../df/dfe/classPhotoRigma_1_1Classes_1_1User.html#a2308665ad82b46f7f73e34750887dbee">PhotoRigma\Classes\User\_add_new_user_internal</a></div><div class="ttdeci">_add_new_user_internal(array $post_data)</div><div class="ttdoc">Добавляет нового пользователя в базу данных, выполняя валидацию входных данных.</div><div class="ttdef"><b>Определения</b> <a href="#l01428">User.php:1428</a></div></div>
<div class="ttc" id="aclassPhotoRigma_1_1Classes_1_1User_html_a28425e4464b81751a589fb6bdd1c19f1"><div class="ttname"><a href="../../df/dfe/classPhotoRigma_1_1Classes_1_1User.html#a28425e4464b81751a589fb6bdd1c19f1">PhotoRigma\Classes\User\_csrf_token_internal</a></div><div class="ttdeci">_csrf_token_internal()</div><div class="ttdoc">Генерирует или возвращает CSRF-токен для защиты от межсайтовой подделки запросов.</div><div class="ttdef"><b>Определения</b> <a href="#l01745">User.php:1745</a></div></div>
<div class="ttc" id="aclassPhotoRigma_1_1Classes_1_1User_html_a2ca555fe6bbef0b0a691c03111ffe700"><div class="ttname"><a href="../../df/dfe/classPhotoRigma_1_1Classes_1_1User.html#a2ca555fe6bbef0b0a691c03111ffe700">PhotoRigma\Classes\User\_update_user_data_internal</a></div><div class="ttdeci">_update_user_data_internal(int $user_id, array $post_data, array $files_data, int $max_size)</div><div class="ttdoc">Обновляет данные существующего пользователя, включая пароль, email, имя и аватар.</div><div class="ttdef"><b>Определения</b> <a href="#l02826">User.php:2826</a></div></div>
<div class="ttc" id="aclassPhotoRigma_1_1Classes_1_1User_html_a31dc3b03e806ca6646c7fcc89b72004e"><div class="ttname"><a href="../../df/dfe/classPhotoRigma_1_1Classes_1_1User.html#a31dc3b03e806ca6646c7fcc89b72004e">PhotoRigma\Classes\User\_all_right_fields</a></div><div class="ttdeci">_all_right_fields()</div><div class="ttdoc">Метод загружает права первого пользователя и первой группы из базы данных, извлекает имена полей (клю...</div><div class="ttdef"><b>Определения</b> <a href="#l00236">User.php:236</a></div></div>
<div class="ttc" id="aclassPhotoRigma_1_1Classes_1_1User_html_a37a62de0669ef3c96b196350fdfed0f5"><div class="ttname"><a href="../../df/dfe/classPhotoRigma_1_1Classes_1_1User.html#a37a62de0669ef3c96b196350fdfed0f5">PhotoRigma\Classes\User\_load_guest_user</a></div><div class="ttdeci">_load_guest_user()</div><div class="ttdoc">Метод загружает данные группы гостя из базы данных, обрабатывает права (user_rights) и сохраняет итог...</div><div class="ttdef"><b>Определения</b> <a href="#l00499">User.php:499</a></div></div>
<div class="ttc" id="aclassPhotoRigma_1_1Classes_1_1User_html_a4045f753ad732e5f01bafd4b6c04d961"><div class="ttname"><a href="../../df/dfe/classPhotoRigma_1_1Classes_1_1User.html#a4045f753ad732e5f01bafd4b6c04d961">PhotoRigma\Classes\User\delete_group</a></div><div class="ttdeci">delete_group(int $group_id)</div><div class="ttdoc">Удаляет группу из системы через Админку.</div><div class="ttdef"><b>Определения</b> <a href="#l01792">User.php:1792</a></div></div>
<div class="ttc" id="aclassPhotoRigma_1_1Classes_1_1User_html_a4375fc668762fd63651b09a2a04f35bb"><div class="ttname"><a href="../../df/dfe/classPhotoRigma_1_1Classes_1_1User.html#a4375fc668762fd63651b09a2a04f35bb">PhotoRigma\Classes\User\add_new_user</a></div><div class="ttdeci">add_new_user(array $post_data)</div><div class="ttdoc">Добавляет нового пользователя в базу данных через вызов внутреннего метода.</div><div class="ttdef"><b>Определения</b> <a href="#l01337">User.php:1337</a></div></div>
<div class="ttc" id="aclassPhotoRigma_1_1Classes_1_1User_html_a440fb4e1ddf381895225c74da750d6ce"><div class="ttname"><a href="../../df/dfe/classPhotoRigma_1_1Classes_1_1User.html#a440fb4e1ddf381895225c74da750d6ce">PhotoRigma\Classes\User\$work</a></div><div class="ttdeci">Work_Interface $work</div><div class="ttdoc">Свойство для объекта класса Work.</div><div class="ttdef"><b>Определения</b> <a href="#l00115">User.php:115</a></div></div>
<div class="ttc" id="aclassPhotoRigma_1_1Classes_1_1User_html_a54301e4038f95a7b17247e0d674ff3d6"><div class="ttname"><a href="../../df/dfe/classPhotoRigma_1_1Classes_1_1User.html#a54301e4038f95a7b17247e0d674ff3d6">PhotoRigma\Classes\User\$user</a></div><div class="ttdeci">array $user</div><div class="ttdoc">Массив, содержащий все данные о текущем пользователе.</div><div class="ttdef"><b>Определения</b> <a href="#l00111">User.php:111</a></div></div>
<div class="ttc" id="aclassPhotoRigma_1_1Classes_1_1User_html_a54dd5e694d07ac47b91bf9a7cc58d9d2"><div class="ttname"><a href="../../df/dfe/classPhotoRigma_1_1Classes_1_1User.html#a54dd5e694d07ac47b91bf9a7cc58d9d2">PhotoRigma\Classes\User\update_user_rights</a></div><div class="ttdeci">update_user_rights(int $user_id, array $user_data, array $post_data)</div><div class="ttdoc">Обновляет права пользователя или группу через вызов внутреннего метода.</div><div class="ttdef"><b>Определения</b> <a href="#l03134">User.php:3134</a></div></div>
<div class="ttc" id="aclassPhotoRigma_1_1Classes_1_1User_html_a6031ba212847fdf2810753c120c4b4d2"><div class="ttname"><a href="../../df/dfe/classPhotoRigma_1_1Classes_1_1User.html#a6031ba212847fdf2810753c120c4b4d2">PhotoRigma\Classes\User\process_user_rights</a></div><div class="ttdeci">process_user_rights(string $user_rights)</div><div class="ttdoc">Обрабатывает поле user_rights, преобразуя его из строки JSON в массив прав, через вызов внутреннего м...</div><div class="ttdef"><b>Определения</b> <a href="#l00326">User.php:326</a></div></div>
<div class="ttc" id="aclassPhotoRigma_1_1Classes_1_1User_html_a60ad4ddd8eb6b52a14c926e2a495dcba"><div class="ttname"><a href="../../df/dfe/classPhotoRigma_1_1Classes_1_1User.html#a60ad4ddd8eb6b52a14c926e2a495dcba">PhotoRigma\Classes\User\_set_property_key_internal</a></div><div class="ttdeci">_set_property_key_internal(string $name, string $key, string|int|bool $value)</div><div class="ttdoc">Метод устанавливает значение свойства в массивах $user или $session.</div><div class="ttdef"><b>Определения</b> <a href="#l00841">User.php:841</a></div></div>
<div class="ttc" id="aclassPhotoRigma_1_1Classes_1_1User_html_a6ccf217fb8ddc2f985779f15cf32f078"><div class="ttname"><a href="../../df/dfe/classPhotoRigma_1_1Classes_1_1User.html#a6ccf217fb8ddc2f985779f15cf32f078">PhotoRigma\Classes\User\encode_user_rights</a></div><div class="ttdeci">encode_user_rights(array $rights)</div><div class="ttdoc">Преобразует массив прав пользователя в строку JSON через вызов внутреннего метода.</div><div class="ttdef"><b>Определения</b> <a href="#l02319">User.php:2319</a></div></div>
<div class="ttc" id="aclassPhotoRigma_1_1Classes_1_1User_html_a6faeda51357eb02f3ea21011d8db4262"><div class="ttname"><a href="../../df/dfe/classPhotoRigma_1_1Classes_1_1User.html#a6faeda51357eb02f3ea21011d8db4262">PhotoRigma\Classes\User\_login_user_internal</a></div><div class="ttdeci">_login_user_internal(array $post, string $redirect_url)</div><div class="ttdoc">Проверяет данные пользователя для входа в систему с &quot;мягким&quot; обновлением паролей на новый формат хран...</div><div class="ttdef"><b>Определения</b> <a href="#l02546">User.php:2546</a></div></div>
<div class="ttc" id="aclassPhotoRigma_1_1Classes_1_1User_html_a7c8aa5e8f1335dd150232b9ba442d694"><div class="ttname"><a href="../../df/dfe/classPhotoRigma_1_1Classes_1_1User.html#a7c8aa5e8f1335dd150232b9ba442d694">PhotoRigma\Classes\User\__set</a></div><div class="ttdeci">__set(string $name, array $value)</div><div class="ttdoc">Устанавливает значение приватного свойства.</div><div class="ttdef"><b>Определения</b> <a href="#l01065">User.php:1065</a></div></div>
<div class="ttc" id="aclassPhotoRigma_1_1Classes_1_1User_html_a8364c028db3f92e0d44c0533289be005"><div class="ttname"><a href="../../df/dfe/classPhotoRigma_1_1Classes_1_1User.html#a8364c028db3f92e0d44c0533289be005">PhotoRigma\Classes\User\_load_authenticated_user</a></div><div class="ttdeci">_load_authenticated_user(int $user_id)</div><div class="ttdoc">Метод загружает данные аутентифицированного пользователя из базы данных, включая права пользователя и...</div><div class="ttdef"><b>Определения</b> <a href="#l00608">User.php:608</a></div></div>
<div class="ttc" id="aclassPhotoRigma_1_1Classes_1_1User_html_a83a705ec9f27426c7e5315e26d136770"><div class="ttname"><a href="../../df/dfe/classPhotoRigma_1_1Classes_1_1User.html#a83a705ec9f27426c7e5315e26d136770">PhotoRigma\Classes\User\is_soft_delete_expired</a></div><div class="ttdeci">is_soft_delete_expired(?string $deleted_at)</div><div class="ttdoc">Проверяет, истёк ли срок восстановления мягкого удаления.</div><div class="ttdef"><b>Определения</b> <a href="#l03360">User.php:3360</a></div></div>
<div class="ttc" id="aclassPhotoRigma_1_1Classes_1_1User_html_a8432fa6f08d4982b9c9d9aaede7de566"><div class="ttname"><a href="../../df/dfe/classPhotoRigma_1_1Classes_1_1User.html#a8432fa6f08d4982b9c9d9aaede7de566">PhotoRigma\Classes\User\update_group_data</a></div><div class="ttdeci">update_group_data(array $group_data, array $post_data)</div><div class="ttdoc">Обновляет данные группы в системе через вызов внутреннего метода.</div><div class="ttdef"><b>Определения</b> <a href="#l02117">User.php:2117</a></div></div>
<div class="ttc" id="aclassPhotoRigma_1_1Classes_1_1User_html_a846904b254f7b59e420e58a68604dc77"><div class="ttname"><a href="../../df/dfe/classPhotoRigma_1_1Classes_1_1User.html#a846904b254f7b59e420e58a68604dc77">PhotoRigma\Classes\User\_update_group_data_internal</a></div><div class="ttdeci">_update_group_data_internal(array $group_data, array $post_data)</div><div class="ttdoc">Обновляет данные группы в системе через Админку.</div><div class="ttdef"><b>Определения</b> <a href="#l02200">User.php:2200</a></div></div>
<div class="ttc" id="aclassPhotoRigma_1_1Classes_1_1User_html_a855f88015180a39f2464a41a2ce2a5c2"><div class="ttname"><a href="../../df/dfe/classPhotoRigma_1_1Classes_1_1User.html#a855f88015180a39f2464a41a2ce2a5c2">PhotoRigma\Classes\User\update_user_data</a></div><div class="ttdeci">update_user_data(int $user_id, array $post_data, array $files_data, int $max_size)</div><div class="ttdoc">Обновляет данные существующего пользователя через вызов внутреннего метода.</div><div class="ttdef"><b>Определения</b> <a href="#l02734">User.php:2734</a></div></div>
<div class="ttc" id="aclassPhotoRigma_1_1Classes_1_1User_html_a9a102a9a5c4c289295b12acbac2f5302"><div class="ttname"><a href="../../df/dfe/classPhotoRigma_1_1Classes_1_1User.html#a9a102a9a5c4c289295b12acbac2f5302">PhotoRigma\Classes\User\_soft_delete</a></div><div class="ttdeci">_soft_delete(int $user_id)</div><div class="ttdoc">Выполняет мягкое удаление пользователя.</div><div class="ttdef"><b>Определения</b> <a href="#l03468">User.php:3468</a></div></div>
<div class="ttc" id="aclassPhotoRigma_1_1Classes_1_1User_html_a9f839b5040591e4ea416cfc8f2ec8f44"><div class="ttname"><a href="../../df/dfe/classPhotoRigma_1_1Classes_1_1User.html#a9f839b5040591e4ea416cfc8f2ec8f44">PhotoRigma\Classes\User\login_user</a></div><div class="ttdeci">login_user(array $post, string $redirect_url)</div><div class="ttdoc">Проверяет данные пользователя для входа в систему через вызов внутреннего метода.</div><div class="ttdef"><b>Определения</b> <a href="#l02459">User.php:2459</a></div></div>
<div class="ttc" id="aclassPhotoRigma_1_1Classes_1_1User_html_aa4aebf7c7377e1c2823e0520d16de530"><div class="ttname"><a href="../../df/dfe/classPhotoRigma_1_1Classes_1_1User.html#aa4aebf7c7377e1c2823e0520d16de530">PhotoRigma\Classes\User\$session</a></div><div class="ttdeci">array $session</div><div class="ttdoc">Массив, привязанный к глобальному массиву $_SESSION.</div><div class="ttdef"><b>Определения</b> <a href="#l00113">User.php:113</a></div></div>
<div class="ttc" id="aclassPhotoRigma_1_1Classes_1_1User_html_aab7ca272675fb69fed326d0094ec13e2"><div class="ttname"><a href="../../df/dfe/classPhotoRigma_1_1Classes_1_1User.html#aab7ca272675fb69fed326d0094ec13e2">PhotoRigma\Classes\User\_delete_group_internal</a></div><div class="ttdeci">_delete_group_internal(int $group_id)</div><div class="ttdoc">Удаляет группу из базы данных.</div><div class="ttdef"><b>Определения</b> <a href="#l01842">User.php:1842</a></div></div>
<div class="ttc" id="aclassPhotoRigma_1_1Classes_1_1User_html_aaf0dcd4a67d4b0f9d67121936d09b848"><div class="ttname"><a href="../../df/dfe/classPhotoRigma_1_1Classes_1_1User.html#aaf0dcd4a67d4b0f9d67121936d09b848">PhotoRigma\Classes\User\_set_work_internal</a></div><div class="ttdeci">_set_work_internal(Work_Interface $work)</div><div class="ttdoc">Установка объекта Work_Interface через сеттер.</div><div class="ttdef"><b>Определения</b> <a href="#l00944">User.php:944</a></div></div>
<div class="ttc" id="aclassPhotoRigma_1_1Classes_1_1User_html_aafee1ee3b55febdd62f61df8a6d4ef01"><div class="ttname"><a href="../../df/dfe/classPhotoRigma_1_1Classes_1_1User.html#aafee1ee3b55febdd62f61df8a6d4ef01">PhotoRigma\Classes\User\_cron_user_delete_internal</a></div><div class="ttdeci">_cron_user_delete_internal()</div><div class="ttdoc">Фоновая задача: выполняет окончательное обезличивание пользователей, у которых истёк срок восстановле...</div><div class="ttdef"><b>Определения</b> <a href="#l03925">User.php:3925</a></div></div>
<div class="ttc" id="aclassPhotoRigma_1_1Classes_1_1User_html_ab19c821428e4402d7669bc3940afe6d7"><div class="ttname"><a href="../../df/dfe/classPhotoRigma_1_1Classes_1_1User.html#ab19c821428e4402d7669bc3940afe6d7">PhotoRigma\Classes\User\unset_property_key</a></div><div class="ttdeci">unset_property_key(string $name, string $key)</div><div class="ttdoc">Удаляет ключ из указанного свойства объекта (user или session) через вызов внутреннего метода.</div><div class="ttdef"><b>Определения</b> <a href="#l01603">User.php:1603</a></div></div>
<div class="ttc" id="aclassPhotoRigma_1_1Classes_1_1User_html_ab2c4aecffb50ad3f568cc504c6aea0c3"><div class="ttname"><a href="../../df/dfe/classPhotoRigma_1_1Classes_1_1User.html#ab2c4aecffb50ad3f568cc504c6aea0c3">PhotoRigma\Classes\User\delete_user</a></div><div class="ttdeci">delete_user(int $user_id, bool $permanent=false)</div><div class="ttdoc">Публичный метод-редирект для выполнения мягкого или окончательного удаления пользователя.</div><div class="ttdef"><b>Определения</b> <a href="#l01919">User.php:1919</a></div></div>
<div class="ttc" id="aclassPhotoRigma_1_1Classes_1_1User_html_ab6a181342a4b7b3aac421c86eb537238"><div class="ttname"><a href="../../df/dfe/classPhotoRigma_1_1Classes_1_1User.html#ab6a181342a4b7b3aac421c86eb537238">PhotoRigma\Classes\User\_encode_user_rights_internal</a></div><div class="ttdeci">_encode_user_rights_internal(array $rights)</div><div class="ttdoc">Метод преобразует массив прав пользователя в строку JSON.</div><div class="ttdef"><b>Определения</b> <a href="#l02375">User.php:2375</a></div></div>
<div class="ttc" id="aclassPhotoRigma_1_1Classes_1_1User_html_abc511791f65e1fca6093700a8a3fee23"><div class="ttname"><a href="../../df/dfe/classPhotoRigma_1_1Classes_1_1User.html#abc511791f65e1fca6093700a8a3fee23">PhotoRigma\Classes\User\_merge_user_with_group</a></div><div class="ttdeci">_merge_user_with_group(array $group_data)</div><div class="ttdoc">Метод объединяет данные пользователя с данными его группы, применяя логику перезаписи значений,...</div><div class="ttdef"><b>Определения</b> <a href="#l00730">User.php:730</a></div></div>
<div class="ttc" id="aclassPhotoRigma_1_1Classes_1_1User_html_ac4c1020c1604de75d27c31dbe77e2fb7"><div class="ttname"><a href="../../df/dfe/classPhotoRigma_1_1Classes_1_1User.html#ac4c1020c1604de75d27c31dbe77e2fb7">PhotoRigma\Classes\User\_hard_delete_user_internal</a></div><div class="ttdeci">_hard_delete_user_internal(int $user_id, bool $force=false)</div><div class="ttdoc">Выполняет окончательное обезличивание записи пользователя.</div><div class="ttdef"><b>Определения</b> <a href="#l03601">User.php:3601</a></div></div>
<div class="ttc" id="aclassPhotoRigma_1_1Classes_1_1User_html_acaafe0adac99eb3c3223a78198854401"><div class="ttname"><a href="../../df/dfe/classPhotoRigma_1_1Classes_1_1User.html#acaafe0adac99eb3c3223a78198854401">PhotoRigma\Classes\User\_delete_personal_content</a></div><div class="ttdeci">_delete_personal_content(int $user_id)</div><div class="ttdoc">Удаляет личные фото пользователя (категория 0) через существующий метод del_photo().</div><div class="ttdef"><b>Определения</b> <a href="#l03799">User.php:3799</a></div></div>
<div class="ttc" id="aclassPhotoRigma_1_1Classes_1_1User_html_acb35e2058e1fa1189a515873e76e62dd"><div class="ttname"><a href="../../df/dfe/classPhotoRigma_1_1Classes_1_1User.html#acb35e2058e1fa1189a515873e76e62dd">PhotoRigma\Classes\User\add_new_group</a></div><div class="ttdeci">add_new_group(array $group_data)</div><div class="ttdoc">Добавляет новую группу в систему через Админку.</div><div class="ttdef"><b>Определения</b> <a href="#l01180">User.php:1180</a></div></div>
<div class="ttc" id="aclassPhotoRigma_1_1Classes_1_1User_html_ad202cf4189004edefa5403d1fad8c7f3"><div class="ttname"><a href="../../df/dfe/classPhotoRigma_1_1Classes_1_1User.html#ad202cf4189004edefa5403d1fad8c7f3">PhotoRigma\Classes\User\_process_user_rights_internal</a></div><div class="ttdeci">_process_user_rights_internal(string $user_rights)</div><div class="ttdoc">Метод обрабатывает поле user_rights, преобразуя его из строки JSON в массив прав.</div><div class="ttdef"><b>Определения</b> <a href="#l00377">User.php:377</a></div></div>
<div class="ttc" id="aclassPhotoRigma_1_1Classes_1_1User_html_ad677f704af643ac0152f7d46455bf769"><div class="ttname"><a href="../../df/dfe/classPhotoRigma_1_1Classes_1_1User.html#ad677f704af643ac0152f7d46455bf769">PhotoRigma\Classes\User\set_property_key</a></div><div class="ttdeci">set_property_key(string $name, string $key, string|int|bool $value)</div><div class="ttdoc">Устанавливает значение свойства в массивах $user или $session через вызов внутреннего метода.</div><div class="ttdef"><b>Определения</b> <a href="#l00788">User.php:788</a></div></div>
<div class="ttc" id="aclassPhotoRigma_1_1Classes_1_1User_html_ad851c6d04f2daadb2243097b75f8bb90"><div class="ttname"><a href="../../df/dfe/classPhotoRigma_1_1Classes_1_1User.html#ad851c6d04f2daadb2243097b75f8bb90">PhotoRigma\Classes\User\_edit_avatar</a></div><div class="ttdeci">_edit_avatar(array $files_data, int $max_size)</div><div class="ttdoc">Обрабатывает загрузку аватара пользователя и возвращает имя нового аватара или значение по умолчанию ...</div><div class="ttdef"><b>Определения</b> <a href="#l03017">User.php:3017</a></div></div>
<div class="ttc" id="aclassPhotoRigma_1_1Classes_1_1User_html_ae5495df50f19c5657eccf4d313bbc98c"><div class="ttname"><a href="../../df/dfe/classPhotoRigma_1_1Classes_1_1User.html#ae5495df50f19c5657eccf4d313bbc98c">PhotoRigma\Classes\User\hard_delete_user</a></div><div class="ttdeci">hard_delete_user(int $user_id, bool $force=false)</div><div class="ttdoc">Публичный метод для окончательного обезличивания личных данных пользователя.</div><div class="ttdef"><b>Определения</b> <a href="#l03558">User.php:3558</a></div></div>
<div class="ttc" id="aclassPhotoRigma_1_1Classes_1_1User_html_ae5e5917c41be4155a54de5e90827dc57"><div class="ttname"><a href="../../df/dfe/classPhotoRigma_1_1Classes_1_1User.html#ae5e5917c41be4155a54de5e90827dc57">PhotoRigma\Classes\User\csrf_token</a></div><div class="ttdeci">csrf_token()</div><div class="ttdoc">Генерирует или возвращает CSRF-токен через вызов внутреннего метода.</div><div class="ttdef"><b>Определения</b> <a href="#l01706">User.php:1706</a></div></div>
<div class="ttc" id="aclassPhotoRigma_1_1Classes_1_1User_html_ae687233b186e739de3c8987820209b66"><div class="ttname"><a href="../../df/dfe/classPhotoRigma_1_1Classes_1_1User.html#ae687233b186e739de3c8987820209b66">PhotoRigma\Classes\User\_delete_user_internal</a></div><div class="ttdeci">_delete_user_internal(int $user_id, bool $permanent=false)</div><div class="ttdoc">Выполняет мягкое или окончательное удаление пользователя с предварительными проверками.</div><div class="ttdef"><b>Определения</b> <a href="#l01992">User.php:1992</a></div></div>
<div class="ttc" id="aclassPhotoRigma_1_1Classes_1_1User_html_ae7bbb3d70503c2c3ab7de0e44bf83798"><div class="ttname"><a href="../../df/dfe/classPhotoRigma_1_1Classes_1_1User.html#ae7bbb3d70503c2c3ab7de0e44bf83798">PhotoRigma\Classes\User\_is_soft_delete_expired_internal</a></div><div class="ttdeci">_is_soft_delete_expired_internal(?string $deleted_at)</div><div class="ttdoc">Возвращает данные о сроке восстановления аккаунта.</div><div class="ttdef"><b>Определения</b> <a href="#l03412">User.php:3412</a></div></div>
<div class="ttc" id="aclassPhotoRigma_1_1Classes_1_1User_html_aee4743c1e7219e86017ef88bdd1a4656"><div class="ttname"><a href="../../df/dfe/classPhotoRigma_1_1Classes_1_1User.html#aee4743c1e7219e86017ef88bdd1a4656">PhotoRigma\Classes\User\_initialize_user</a></div><div class="ttdeci">_initialize_user()</div><div class="ttdoc">Инициализация данных пользователя: определение типа пользователя (гость или аутентифицированный) на о...</div><div class="ttdef"><b>Определения</b> <a href="#l00435">User.php:435</a></div></div>
<div class="ttc" id="aclassPhotoRigma_1_1Classes_1_1User_html_af20ed50055d313a9cc9e78e7aace9d5d"><div class="ttname"><a href="../../df/dfe/classPhotoRigma_1_1Classes_1_1User.html#af20ed50055d313a9cc9e78e7aace9d5d">PhotoRigma\Classes\User\cron_user_delete</a></div><div class="ttdeci">cron_user_delete()</div><div class="ttdoc">Публичный метод для запуска фоновой задачи окончательного удаления пользователей.</div><div class="ttdef"><b>Определения</b> <a href="#l03867">User.php:3867</a></div></div>
<div class="ttc" id="aclassPhotoRigma_1_1Classes_1_1User_html_af31e6e13ab6e21a8020e1573c9899c5f"><div class="ttname"><a href="../../df/dfe/classPhotoRigma_1_1Classes_1_1User.html#af31e6e13ab6e21a8020e1573c9899c5f">PhotoRigma\Classes\User\$user_right_fields</a></div><div class="ttdeci">array $user_right_fields</div><div class="ttdoc">Массив с полями наименований прав доступа</div><div class="ttdef"><b>Определения</b> <a href="#l00114">User.php:114</a></div></div>
<div class="ttc" id="aclassPhotoRigma_1_1Classes_1_1User_html_afaec38e538d6cb2625c21ac316cb7692"><div class="ttname"><a href="../../df/dfe/classPhotoRigma_1_1Classes_1_1User.html#afaec38e538d6cb2625c21ac316cb7692">PhotoRigma\Classes\User\_unset_property_key_internal</a></div><div class="ttdeci">_unset_property_key_internal(string $name, string $key)</div><div class="ttdoc">Удаляет ключ из указанного свойства объекта (user или session).</div><div class="ttdef"><b>Определения</b> <a href="#l01654">User.php:1654</a></div></div>
<div class="ttc" id="aclassPhotoRigma_1_1Classes_1_1Work_html_a8ecb9d3a6cba675b7a2d72ddc14b53f3"><div class="ttname"><a href="../../d7/d53/classPhotoRigma_1_1Classes_1_1Work.html#a8ecb9d3a6cba675b7a2d72ddc14b53f3">PhotoRigma\Classes\Work\clean_field</a></div><div class="ttdeci">static clean_field(string $field)</div><div class="ttdoc">Очищает строку от HTML-тегов и специальных символов через вызов публичного метода в дочернем классе.</div><div class="ttdef"><b>Определения</b> <a href="../../d1/dce/Work_8php_source.html#l01491">Work.php:1491</a></div></div>
<div class="ttc" id="aclassPhotoRigma_1_1Classes_1_1Work_html_ad9ac814e0001840a4cdbf826d0d6e53e"><div class="ttname"><a href="../../d7/d53/classPhotoRigma_1_1Classes_1_1Work.html#ad9ac814e0001840a4cdbf826d0d6e53e">PhotoRigma\Classes\Work\encodename</a></div><div class="ttdeci">static encodename(string $string)</div><div class="ttdoc">Транслитерация строки и замена знаков пунктуации на &quot;_&quot; через вызов публичного метода в дочернем клас...</div><div class="ttdef"><b>Определения</b> <a href="../../d1/dce/Work_8php_source.html#l00895">Work.php:895</a></div></div>
<div class="ttc" id="ainterfacePhotoRigma_1_1Interfaces_1_1Database__Interface_html"><div class="ttname"><a href="../../d7/dc2/interfacePhotoRigma_1_1Interfaces_1_1Database__Interface.html">PhotoRigma\Interfaces\Database_Interface</a></div><div class="ttdoc">Интерфейс для работы с базами данных через PDO.</div><div class="ttdef"><b>Определения</b> <a href="../../d0/da3/Database__Interface_8php_source.html#l00106">Database_Interface.php:107</a></div></div>
<div class="ttc" id="ainterfacePhotoRigma_1_1Interfaces_1_1User__Interface_html"><div class="ttname"><a href="../../dc/d14/interfacePhotoRigma_1_1Interfaces_1_1User__Interface.html">PhotoRigma\Interfaces\User_Interface</a></div><div class="ttdoc">Интерфейс для работы с пользователями и группами.</div><div class="ttdef"><b>Определения</b> <a href="../../dc/db5/User__Interface_8php_source.html#l00106">User_Interface.php:107</a></div></div>
<div class="ttc" id="ainterfacePhotoRigma_1_1Interfaces_1_1Work__Interface_html"><div class="ttname"><a href="../../da/d79/interfacePhotoRigma_1_1Interfaces_1_1Work__Interface.html">PhotoRigma\Interfaces\Work_Interface</a></div><div class="ttdoc">Интерфейс для центральной точки приложения.</div><div class="ttdef"><b>Определения</b> <a href="../../d3/dee/Work__Interface_8php_source.html#l00117">Work_Interface.php:118</a></div></div>
<div class="ttc" id="anamespacePhotoRigma_html_afc238d5007d9f82f9c59e7d33f7a75c6"><div class="ttname"><a href="../../de/d90/namespacePhotoRigma.html#afc238d5007d9f82f9c59e7d33f7a75c6">PhotoRigma\IN_GALLERY</a></div><div class="ttdeci">const IN_GALLERY</div><div class="ttdef"><b>Определения</b> <a href="../../de/d20/index_8php_source.html#l00183">index.php:183</a></div></div>
</div><!-- fragment --></div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="../../dir_d44c64559bbebec7f509842c48db8b23.html">include</a></li><li class="navelem"><a class="el" href="../../db/da2/User_8php.html">User.php</a></li>
    <li class="footer">Документация по Photo-Rigma-BiZ. Последние изменения: Пн 12 Май 2025. Создано системой <a href="https://www.doxygen.org/index.html"><img class="footer" src="../../doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.13.2 </li>
  </ul>
</div>
</body>
</html>
