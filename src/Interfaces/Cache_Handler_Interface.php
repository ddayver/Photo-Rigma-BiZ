<?php

/**
 * Интерфейс для работы с системами кеширования.
 *
 * Этот файл содержит интерфейс `Cache_Handler_Interface`, который определяет контракт для работы с различными типами
 * кеширования:
 * - Файловое кеширование (`file`).
 * - Redis.
 * - Memcached.
 * Интерфейс обеспечивает единообразие реализации различных систем кеширования и предоставляет методы для выполнения
 * основных операций:
 * - Проверка актуальности данных в кеше.
 * - Запись данных в кеш.
 * Все методы должны быть реализованы в классах, поддерживающих этот интерфейс.
 *
 * @author    Dark Dayver
 * @version   0.5.0
 * @since     2025-05-29
 * @namespace PhotoRigma\\Interfaces
 * @package   PhotoRigma
 *
 * @section   CacheHandlerInterface_Main_Functions Основные функции
 *            - Проверка актуальности данных в кеше с использованием ключа и контрольного числа.
 *            - Запись данных в кеш с кодированием в формат JSON и Base64.
 *
 * @note      Этот файл является частью системы PhotoRigma и обеспечивает взаимодействие приложения с системами
 *            кеширования. Реализация интерфейса гарантирует унифицированный подход к работе с различными системами
 *            кеширования.
 *
 * @warning   Реализация методов интерфейса может отличаться от предыдущих версий. Убедитесь, что вы изучили новую
 *            документацию перед использованием.
 *
 * @copyright Copyright (c) 2008-2025 Dark Dayver. Все права защищены.
 * @license   MIT License {@link https://opensource.org/licenses/MIT}
 *            Разрешается использовать, копировать, изменять, объединять, публиковать, распространять,
 *            сублицензировать и/или продавать копии программного обеспечения, а также разрешать лицам, которым
 *            предоставляется данное программное обеспечение, делать это при соблюдении следующих условий:
 *            - Уведомление об авторских правах и условия лицензии должны быть включены во все копии или значимые
 *              части программного обеспечения.
 */

namespace PhotoRigma\Interfaces;

use JsonException;
use RuntimeException;

// Предотвращение прямого вызова файла
if (!defined('IN_GALLERY') || IN_GALLERY !== true) {
    /** @noinspection ForgottenDebugOutputInspection */
    error_log(
        date('H:i:s') . ' [ERROR] | ' . (filter_input(
            INPUT_SERVER,
            'REMOTE_ADDR',
            FILTER_VALIDATE_IP
        ) ?: 'UNKNOWN_IP') . ' | ' . __FILE__ . ' | Попытка прямого вызова файла'
    );
    die('HACK!');
}

/**
 * Интерфейс для работы с системами кеширования.
 *
 * Этот интерфейс определяет контракт для работы с различными типами кеширования:
 * - Файловое кеширование (file).
 * - Redis.
 * - Memcached.
 * Он предоставляет методы для выполнения основных операций с кешем:
 * - Проверка актуальности данных.
 * - Запись данных в кеш.
 * Все методы должны быть реализованы в классах, поддерживающих этот интерфейс.
 *
 * @note    Интерфейс поддерживает только файловое кеширование, Redis и Memcached.
 *
 * @warning Реализация методов интерфейса может отличаться от предыдущих версий. Убедитесь, что вы изучили новую
 *          документацию перед использованием.
 */
interface Cache_Handler_Interface
{
    /**
     * Проверяет актуальность данных в кеше.
     *
     * Этот метод является частью контракта интерфейса и должен быть реализован в классе.
     * Он выполняет следующие действия:
     * 1. Принимает параметры для проверки актуальности данных: ключ кеша и контрольное число.
     * 2. В зависимости от типа кеширования проверяет данные:
     *    - Для файлового кеширования (`file`) используется файловый кеш.
     *    - Для Redis/Memcached используется хранилище.
     * 3. Возвращает массив данных, если кеш актуален, или `false`, если данные устарели или отсутствуют.
     *
     * @param string     $key      Ключ кеша. Используется для проверки актуальности данных.
     *                             Пример: `'user_settings'`.
     * @param int|string $checksum Контрольное число или хеш-строка для проверки актуальности данных.
     *                             Должно соответствовать сохранённому значению в кеше.
     *
     * @return array|false Массив данных, если кеш актуален, или `false`, если:
     *                     - Тип кеширования не поддерживается.
     *                     - Данные в кеше устарели или отсутствуют.
     *
     * @throws JsonException    Выбрасывается при ошибках декодирования JSON:
     * @throws RuntimeException Выбрасывается при следующих условиях:
     *                           - Для Redis/Memcached:
     *                             - Если клиент хранилища не инициализирован или имеет неправильный тип.
     *
     * @note    Метод должен быть реализован в классе, реализующем интерфейс.
     *          Все параметры и возвращаемое значение должны соответствовать описанию.
     *
     * @warning Неверные типы данных или некорректные значения могут привести к выбросу исключения.
     *          Убедитесь, что файлы кеша или хранилище правильно настроены и доступны для чтения.
     */
    public function is_valid(string $key, int|string $checksum): array|false;

    /**
     * Записывает данные в кеш.
     *
     * Этот метод является частью контракта интерфейса и должен быть реализован в классе.
     * Он выполняет следующие действия:
     * 1. Принимает параметры для записи данных: ключ кеша, контрольное число и данные.
     * 2. В зависимости от типа кеширования записывает данные:
     *    - Для файлового кеширования (`file`) используется файловый кеш.
     *    - Для Redis/Memcached используется хранилище.
     * 3. Возвращает `true`, если запись успешна, или `false`, если произошла ошибка.
     *
     * @param string     $key      Ключ кеша. Используется для записи данных.
     *                             Пример: `'user_settings'`.
     * @param int|string $checksum Контрольное число или хеш-строка для проверки актуальности данных.
     *                             Будет сохранено в кеше.
     * @param array      $data     Данные для записи. Будут закодированы в формат JSON и Base64.
     *                             Пример: `['theme' => 'dark', 'language' => 'en']`.
     *
     * @return bool True, если запись успешна, или `false`, если:
     *              - Тип кеширования не поддерживается.
     *              - Произошла ошибка при записи данных.
     *
     * @throws JsonException    Выбрасывается при ошибках кодирования JSON:
     * @throws RuntimeException Выбрасывается при следующих условиях:
     *                           - Для файлового кеширования:
     *                             - Если директория для кеша не существует или недоступна для записи.
     *                             - Если файл кеша недоступен для записи.
     *                           - Для Redis/Memcached:
     *                             - Если клиент хранилища не инициализирован или имеет неправильный тип.
     *
     * @note    Метод должен быть реализован в классе, реализующем интерфейс.
     *          Все параметры и возвращаемое значение должны соответствовать описанию.
     *
     * @warning Неверные типы данных или некорректные значения могут привести к выбросу исключения.
     *          Убедитесь, что файлы кеша или хранилище правильно настроены и доступны для записи.
     */
    public function update_cache(string $key, int|string $checksum, array $data): bool;
}
